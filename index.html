<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="format-detection" content="address=no">
<title>æ—…éŠ / é¤æœƒ å ±åç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin:15px; background:#f0f2f5; color: #333; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { color: #1a73e8; margin-bottom: 20px; text-align: center; }
  .event-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
  .event-card { 
    background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 12px 8px; 
    text-align: center; cursor: pointer; transition: 0.2s; position: relative;
    display: flex; flex-direction: column; justify-content: center; min-height: 80px;
  }
  .event-card.selected { border-color: #1a73e8; background: #f8faff; box-shadow: 0 4px 12px rgba(26,115,232,0.15); }
  .event-card .badge { position: absolute; top: -8px; right: -5px; background: #4CAF50; color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
  .event-card .type-tag { font-size: 10px; color: #888; margin-bottom: 4px; }
  .event-card .title { font-size: 14px; font-weight: bold; color: #333; line-height: 1.3; }
  label { display:block; margin-top:12px; font-weight: bold; color: #555; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  .btn-group { margin-top: 25px; }
  button { padding:12px; width:100%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 16px; }
  button:hover { background: #45a049; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  button.delete-btn { background:#e53935; margin-top: 12px; } 
  button.delete-btn:hover { background:#d32f2f; }
  #eventInfo, #stats { margin-top:15px; padding:15px; border-radius:8px; display:none; }
  #eventInfo { background:#e8f0fe; border-left: 5px solid #1a73e8; }
  #stats { background:#f8f9fa; border-left: 5px solid #4CAF50; }
  .store-wrapper { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .web-icon { width: 18px; height: 18px; fill: #1a73e8; cursor: pointer; transition: 0.2s; vertical-align: middle; }
  .address-wrapper { display: flex; align-items: flex-start; margin-top: 10px; line-height: 1.5; }
  .address-label { font-weight:bold; flex-shrink:0; }
  .address-link { display: inline-flex; align-items: center; cursor: pointer; color: inherit !important; text-decoration: none !important; }
  .gm-icon { width: 18px; height: 18px; margin-left: 6px; flex-shrink: 0; fill: #EA4335; opacity: 0.8; }
  .itinerary-container { margin-top: 15px; background: #fff; border: 1px solid #cce0ff; border-radius: 6px; overflow: hidden; }
  .itinerary-header { background: #1a73e8; color: white; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: bold; }
  .itinerary-content { display: none; padding: 10px; font-size: 13px; max-height: 500px; overflow-y: auto; background: #fcfdfe; }
  .day-section { margin-bottom: 8px; border: 1px solid #e0e6ed; border-radius: 6px; overflow: hidden; background: #fff; }
  .day-toggle { background: #f8faff; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #1a73e8; font-size: 13px; }
  .day-content { display: none; padding: 5px; }
  .itinerary-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
  .itinerary-table th, .itinerary-table td { border-bottom: 1px solid #eee; padding: 10px 6px; text-align: left; }
  .user-list-item { font-size: 13px; color: #444; padding: 8px 12px; border-left: 4px solid #1a73e8; margin: 6px 0; background: #fff; border-radius: 0 4px 4px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .sponsor-item { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
  .sponsor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .remove-btn { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 18px; font-weight: bold; width: auto; }
  .add-sponsor-btn { background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 14px; width: 100%; font-weight: bold; display:none; }
  .map-link-btn { background: #e8f0fe; color: #1a73e8; border: 1px solid #1a73e8; padding: 10px; border-radius: 6px; font-size: 13px; cursor: pointer; text-align: center; margin-top: 10px; font-weight: bold; }

  .guest-card { border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 15px; background: #fff; overflow: hidden; }
  .guest-header { background: #f8f9fa; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #1a73e8; border-bottom: 1px solid #eee; }
  .guest-body { padding: 15px; display: block; }
  .guest-del { color: #ff4d4d; font-size: 13px; cursor: pointer; text-decoration: underline; }
  .btn-add-guest { background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 15px; font-size: 14px; width: 100%; font-weight: bold; display: none; }
  
  .g-arrow, #arrow, .day-arrow { 
    font-size: 24px; 
    font-weight: 900; 
    line-height: 1; 
    margin-left: 10px; 
    display: inline-block; 
    color: #1a73e8;
  }

  /* è¤‡è£½æŒ‰éˆ•æ¨£å¼ */
/* ä¿®æ­£ç¸½å ±åæ¬„ä½çš„å®¹å™¨ä½ˆå±€ */
/* 1. ä¿®æ­£å®¹å™¨ï¼šè®“å…§å®¹å·¦å³æ’é–‹ */
#uStats {
    display: flex;
    justify-content: space-between; /* é—œéµï¼šæ¨å‘å…©æ¥µ */
    align-items: center;           /* å‚ç›´å±…ä¸­ */
    margin-bottom: 10px;
    padding: 0 5px;
  }

  /* 2. ä¿®æ­£æŒ‰éˆ•ï¼šç¢ºä¿æ¨£å¼ç¨ç«‹ */
  .copy-btn {
    background: #ffffff;
    color: #4CAF50;
    border: 1px solid #4CAF50;
    padding: 2px 6px;           /* å†åº¦ç¸®æ¸›ï¼šä¸Šä¸‹2pxï¼Œå·¦å³6px */
    font-size: 11px;            /* ä½¿ç”¨è¼ƒå°å­—é«” */
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
    transition: 0.2s;
    width: auto;                /* ç§»é™¤ min-widthï¼Œè®“å¯¬åº¦ç”±æ–‡å­—æ’é–‹ */
  }
  
  .copy-btn:hover {
    background: #4CAF50;
    color: #ffffff;
  }

  .copy-btn:active {
    background: #e8f5e9;
    transform: translateY(1px);    /* æŒ‰å£“æ„Ÿ */
  }
</style>
</head>
<body>

<div class="container">
  <h2>æ—…éŠ / é¤æœƒ å ±åç³»çµ±</h2>
  <label>é¸æ“‡æ´»å‹•ï¼š</label>
  <div id="eventGrid" class="event-grid">
    <p style="grid-column: span 2; text-align: center; color: #1a73e8; padding: 10px;">ğŸš€ è¼‰å…¥ä¸­...</p>
  </div>
  <select id="eventSelect" style="display:none;"><option value="">è¼‰å…¥ä¸­...</option></select>

  <div id="eventInfo">
    <h3 id="evTitle" style="margin:0 0 8px 0; color:#1a73e8;"></h3>
    <p>ğŸ‘¤ ä¸»è¾¦äººï¼š<span id="evHost"></span></p>
    <p>ğŸ“… æ™‚é–“ï¼š<span id="evTime"></span></p>
    <p class="store-wrapper">
      ğŸ“ åœ°é»ï¼š<span id="evStore"></span>
      <svg class="web-icon" onclick="openOfficialSite()" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    </p>
    <div class="address-wrapper">
      <span class="address-label">ğŸ  åœ°å€ï¼š</span>
      <div class="address-link" onclick="openGoogleMap()"><span id="evAddress"></span><svg class="gm-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/></svg></div>
    </div>
    <div id="itineraryBox" class="itinerary-container" style="display:none;">
      <div class="itinerary-header" onclick="toggleItinerary()"><span>ğŸ—ºï¸ æŸ¥çœ‹åˆ†å¤©è¡Œç¨‹è¡¨</span><span id="arrow">ï¼‹</span></div>
      <div id="itineraryContent" class="itinerary-content"></div>
    </div>
  </div>

  <form id="regForm" style="display:none;">
    <input type="hidden" id="userId"><input type="hidden" id="userName">
    
    <div style="background: #f8faff; padding: 12px; border-radius: 8px; border: 1px solid #e8f0fe;">
      <label>å ±åè€…å§“å (æœ¬äºº)ï¼š<input type="text" id="userNameShow" readonly></label>
      <label>åƒåŠ äººæ•¸ï¼š<select id="people"></select></label>
      <div id="weiyaFields" style="display:none;"><label>èªæ¡Œæ•¸é‡ï¼š<select id="table"></select></label></div>
      <div id="travelFields" style="display:none;">
        <label><span style="color:red;">*</span> ä¸Šè»Šåœ°é»ï¼š</label>
        <select id="pickup" onchange="updatePickupMap()"></select>
        <div id="pickupMapLink" class="map-link-btn" style="display:none;" onclick="openPickupMap()">ğŸ“ æŸ¥çœ‹ [ <span id="locLabel"></span> ] ä¸Šè»Šä½ç½®</div>
        <label><span style="color:red;">*</span> æˆ¿å‹é¸æ“‡ï¼š</label><select id="room"></select>
      </div>
    </div>

    <div id="guestContainer"></div>
    <button type="button" class="btn-add-guest" id="addGuestBtn">â• æ–°å¢ä¾†è³“å ±å</button>

    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
    <label>ğŸ è´ŠåŠ©é …ç›®ç®¡ç†ï¼š</label>
    <div id="sponsorContainer"></div>
    <button type="button" class="add-sponsor-btn" id="addSponsorBtn">â• æ–°å¢è´ŠåŠ©é …ç›®</button>
    <label style="margin-top:20px;">å‚™è¨»ï¼š<textarea id="memo" rows="2" placeholder="ç‰¹æ®Šé£Ÿæ€§ã€æˆ¿å‹å€™è£œæˆ–ä½µæˆ¿éœ€æ±‚èªªæ˜"></textarea></label>
    <div class="btn-group">
      <button type="submit" id="subBtn">é€å‡ºå ±å</button>
      <button type="button" id="cancelBtn" class="delete-btn" style="display:none;">âŒ å–æ¶ˆå ±å</button>
    </div>
  </form>

  <div id="stats">
    <div id="uStats"></div>
    <div id="uDetail" style="margin-bottom:15px;"></div>
    <div id="sStats"></div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);
let masterOptions = { sponsor: [], sponsorQty: [], people: [], table: [], pickup: [], room: [], itinerary: [] };

// å…¨åŸŸå­˜å„²ç›®å‰åå–®èˆ‡æ´»å‹•è³‡è¨Šï¼Œä¾›è¤‡è£½ä½¿ç”¨
let CURRENT_STATS_DATA = { users: [], eventInfo: {}, type: "" };

// --- è¤‡è£½åŠŸèƒ½ (å„ªåŒ–ç‰ˆæœ¬ï¼šè‡ªå‹•å½™æ•´æˆ¿å‹èˆ‡è´ŠåŠ©) ---
function copyToClipboard() {
  if (!CURRENT_STATS_DATA.users || CURRENT_STATS_DATA.users.length === 0) {
    alert("ç›®å‰å°šç„¡å ±åè³‡æ–™å¯è¤‡è£½");
    return;
  }
  const info = CURRENT_STATS_DATA.eventInfo;
  const isTravel = CURRENT_STATS_DATA.type === 'æ—…éŠ';
  
  // 1. æ´»å‹•æ¨™é¡Œèˆ‡åŸºæœ¬è³‡è¨Š
  let text = `ã€${info.title}ã€‘\nğŸ‘¤ ä¸»è¾¦ï¼š${info.host}\nğŸ“… æ™‚é–“ï¼š${$('evTime').innerText}\nğŸ“ åœ°é»ï¼š${info.store}\n------------------\n`;
  
  // 2. å ±ååå–®æ˜ç´°
  CURRENT_STATS_DATA.users.forEach((u, i) => {
    let detail = isTravel 
      ? `${u.pickup} / ${u.room || 'æœªé¸æˆ¿'}` 
      : `${u.table || 0}æ¡Œ`;
    text += `${i + 1}. ${u.userName} (${u.people}äºº) [${detail}]\n`;
  });
  
  // 3. çµ±è¨ˆèˆ‡è´ŠåŠ©å½™æ•´
  const totalPeople = CURRENT_STATS_DATA.users.reduce((s, u) => s + (parseInt(u.people) || 0), 0);
  text += `------------------\nğŸ“Š ç¸½è¨ˆï¼š${totalPeople} äºº\n`;

  // å¾ä»‹é¢æŠ“å–è´ŠåŠ©å½™æ•´å…§å®¹
  const sStatsEl = $('sStats');
  if (sStatsEl) {
    let sText = sStatsEl.innerText.replace('ğŸ è´ŠåŠ©å½™æ•´ï¼š', '').trim();
    if (sText && sText !== 'æš«ç„¡è´ŠåŠ©') {
      text += `ğŸ è´ŠåŠ©å½™æ•´ï¼š\n${sText}\n`;
    }
  }

  text += `ğŸ”— å ±åï¼šhttps://liff.line.me/${LIFF_ID}`;

  // åŸ·è¡Œè¤‡è£½
  const el = document.createElement('textarea');
  el.value = text;
  document.body.appendChild(el);
  el.select();
  try {
    document.execCommand('copy');
    alert("âœ… å ±ååå–®(å«æˆ¿å‹èˆ‡è´ŠåŠ©)å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
  } catch (err) {
    alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—");
  }
  document.body.removeChild(el);
}

// --- åŠŸèƒ½å‡½æ•¸ ---
function openOfficialSite() {
  const sel = $('eventSelect').selectedOptions[0];
  if (!sel) return;
  const o = sel.dataset;
  if (o.officialsite && o.officialsite !== "undefined" && o.officialsite.trim() !== "") window.open(o.officialsite, '_blank');
  else alert("æ­¤åœ°é»æš«ç„¡å®˜ç¶²è³‡æ–™");
}
function openGoogleMap() {
  const sel = $('eventSelect').selectedOptions[0];
  if (!sel) return;
  const o = sel.dataset;
  const query = encodeURIComponent(`${o.store} ${o.address}`);
  window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
}
function formatOnlyDate(val) {
  if (!val || val === 'undefined') return '';
  const d = new Date(val);
  if (isNaN(d.getTime())) return val;
  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
}
function formatDateTime(val) {
  if (!val || val === 'undefined') return '';
  let d = new Date(val);
  if (isNaN(d.getTime())) return val;
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const date = String(d.getDate()).padStart(2, '0');
  const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const dayName = `(${days[d.getDay()]})`;
  let timePart = (typeof val === 'string' && val.includes(' ')) ? val.split(' ')[1].substring(0, 5) : String(d.getHours()).padStart(2, '0') + ":" + String(d.getMinutes()).padStart(2, '0');
  return `${y}/${m}/${date} ${dayName} ${timePart}`;
}
function toggleItinerary() {
  const c = $('itineraryContent'); 
  c.style.display = c.style.display === 'block' ? 'none' : 'block';
  $('arrow').innerText = c.style.display === 'block' ? 'ï¼' : 'ï¼‹';
}
function toggleDay(el) {
  const c = el.nextElementSibling; 
  c.style.display = c.style.display === 'block' ? 'none' : 'block';
  el.querySelector('.day-arrow').innerText = c.style.display === 'block' ? 'ï¼' : 'ï¼‹';
}
async function callApi(action, extra = '') {
  try {
    const r = await fetch(`${GAS_URL}?action=${action}${extra}&ts=${Date.now()}`);
    return await r.json();
  } catch (e) { return []; }
}

async function init(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    $('userName').value = $('userNameShow').value = p.displayName; 
    $('userId').value = p.userId;
    const res = await callApi('getInitData'); 
    masterOptions = res.options;
    masterOptions.itinerary = res.itinerary;
    const sel = $('eventSelect');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
    res.events.forEach(ev => {
      if (!ev.eventId) return;
      const joined = res.registrations.some(j => String(j.eventId) === String(ev.eventId) && String(j.userId) === String(p.userId));
      const opt = new Option(`${joined ? 'ã€âœ… å·²å ±åã€‘ ' : ''}${ev.title}`, ev.eventId);
      Object.assign(opt.dataset, { 
        joined, eventid: ev.eventId, type: ev.type, title: ev.title, host: ev.host, time: ev.time, 
        startdate: ev.startDate, enddate: ev.endDate, store: ev.store, address: ev.address, officialsite: ev.officialSite 
      });
      sel.add(opt);
    });
    renderEventCards();
  } catch (err) { console.error(err); }
}

function renderEventCards() {
  const grid = $('eventGrid'); const sel = $('eventSelect');
  grid.innerHTML = '';
  Array.from(sel.options).forEach((opt, idx) => {
    if (idx === 0) return;
    const d = opt.dataset;
    const card = document.createElement('div');
    card.className = 'event-card';
    if (d.joined === 'true') card.innerHTML += '<span class="badge">å·²å ±å</span>';
    card.innerHTML += `<div class="type-tag">${d.type}</div><div class="title">${d.title}</div>`;
    card.onclick = () => {
      document.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      sel.value = opt.value; 
      sel.dispatchEvent(new Event('change'));
    };
    grid.appendChild(card);
  });
}

$('eventSelect').onchange = async () => {
  const sel = $('eventSelect');
  const o = sel.selectedOptions[0];
  if (!o || !o.value) return;

  // --- 1. å¾¹åº•æ¸…ç©ºæ‰€æœ‰èˆŠè³‡æ–™å®¹å™¨ ---
  $('regForm').style.display = 'none';
  $('eventInfo').style.display = 'none';
  $('stats').style.display = 'none';
  $('pickupMapLink').style.display = 'none';
  $('sponsorContainer').innerHTML = ''; // æ¸…ç©ºè´ŠåŠ©æ¬„ä½
  $('guestContainer').innerHTML = '';   // æ¸…ç©ºä¾†è³“
  $('itineraryContent').innerHTML = ''; // æ¸…ç©ºè¡Œç¨‹
  $('arrow').innerText = 'ï¼‹';

  const d = o.dataset;
  const isW = (d.type === 'å°¾ç‰™' || d.type === 'èšæœƒ' || d.type === 'é¤æœƒ');
  const isTravel = (d.type === 'æ—…éŠ');

  // è¨­å®šæ´»å‹•åŸºç¤è³‡è¨Š
  $('addGuestBtn').style.display = isTravel ? 'block' : 'none';
  $('evTitle').innerText = d.title; 
  $('evHost').innerText = d.host;
  $('evStore').innerText = d.store; 
  $('evAddress').innerText = d.address;

  // ç´€éŒ„ç›®å‰æ´»å‹•è³‡è¨Šä¾›è¤‡è£½åŠŸèƒ½ä½¿ç”¨
  CURRENT_STATS_DATA.eventInfo = { title: d.title, host: d.host, store: d.store };
  CURRENT_STATS_DATA.type = d.type;

  // --- 2. æŠ“å– API è³‡æ–™ ---
  const curStats = await callApi('queryStats', `&eventId=${o.value}`);
  const users = curStats.users || [];
  const joined = (d.joined === 'true');

  $('subBtn').innerText = joined ? 'ç·¨è¼¯å ±å' : 'é€å‡ºå ±å';
  $('subBtn').disabled = false;
  $('cancelBtn').style.display = joined ? 'block' : 'none';

  // --- 3. å¡«å……ä¸‹æ‹‰é¸å–® ---
  const fill = (id, list) => { 
    const target = $(id);
    target.innerHTML = ''; 
    list.forEach(x => target.add(new Option(x, x))); 
  };
  fill('people', masterOptions.people);

  if (isW) {
    $('evTime').innerText = formatDateTime(d.time) || "æ™‚é–“æœªå®š";
    $('weiyaFields').style.display = 'block'; 
    $('travelFields').style.display = 'none';
    $('itineraryBox').style.display = 'none'; 
    fill('table', masterOptions.table);
  } else {
    const sDate = formatOnlyDate(d.startdate);
    const eDate = formatOnlyDate(d.enddate);
    $('evTime').innerText = (sDate && eDate) ? `${sDate} ~ ${eDate}` : "æ™‚é–“æœªå®š";
    $('travelFields').style.display = 'block'; 
    $('weiyaFields').style.display = 'none';
    
    // ä¸Šè»Šåœ°é»
    const pSel = $('pickup');
    pSel.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸Šè»Šé» --</option>';
    masterOptions.pickup.forEach(i => { 
      const opt = new Option(i.name, i.name); 
      opt.dataset.mapurl = i.info; 
      pSel.add(opt); 
    });

    // æˆ¿å‹é¸æ“‡
    const rSel = $('room');
    rSel.innerHTML = '<option value="">-- è«‹é¸æ“‡æˆ¿å‹ --</option>';
    rSel.add(new Option("æˆ‘è¦ä½µæˆ¿ (è²»ç”¨å¦è¨ˆ)", "æˆ‘è¦ä½µæˆ¿"));
    masterOptions.room.forEach(i => {
      const used = users.reduce((acc, u) => (u.room && u.room.startsWith(i.name)) ? acc + 1 : acc, 0);
      const rem = (parseInt(i.totalCount) || 0) - used;
      const label = rem > 0 ? `${i.name} / ${i.price}å…ƒ / å‰©${rem}é–“` : `${i.name} (å·²æ»¿ï¼Œå¾…è¦åŠƒ)`;
      rSel.add(new Option(label, i.name));
    });
    renderItinerary();
  }

  // --- 4. åˆå§‹åŒ–è´ŠåŠ©æ¬„ä½ (ç¢ºä¿åªå‘¼å«ä¸€æ¬¡) ---
  if ($('sponsorContainer').children.length === 0) {
    createSponsorRow();
  }

  // --- 5. é¡¯ç¤ºè¡¨å–®èˆ‡çµ±è¨ˆåå–® ---
  $('regForm').style.display = $('eventInfo').style.display = 'block';
  renderStatsView(curStats, d.type);
};
// --- ä¾†è³“ç®¡ç†é‚è¼¯ (å«é˜²å‘†æª¢æŸ¥) ---
$('addGuestBtn').onclick = () => {
  const guestInputs = document.querySelectorAll('.g-name');
  for (let input of guestInputs) {
    if (input.value.trim() === "") {
      alert("è«‹å…ˆå¡«å¯«å®Œç›®å‰ä¾†è³“çš„å§“åï¼Œå†æ–°å¢ä¸‹ä¸€ä½ï¼");
      input.focus();
      return;
    }
  }

  const gid = 'guest_' + Date.now();
  const isTravel = $('travelFields').style.display === 'block';
  
  const div = document.createElement('div');
  div.className = 'guest-card';
  div.id = gid;
  div.innerHTML = `
    <div class="guest-header" onclick="toggleGuest('${gid}')">
      <span>ğŸ‘¤ ä¾†è³“ï¼š<span class="g-name-lbl">æ–°ä¾†è³“</span></span>
      <div>
        <span class="guest-del" onclick="removeGuest('${gid}', event)">åˆªé™¤</span>
        <span class="g-arrow">ï¼</span>
      </div>
    </div>
    <div class="guest-body">
      <label>ä¾†è³“å§“åï¼š<input type="text" class="g-name" placeholder="è«‹è¼¸å…¥å§“å" oninput="updateGuestName(this)"></label>
      <label>åƒåŠ äººæ•¸ï¼š<select class="g-people">${$('people').innerHTML}</select></label>
      <div class="g-travel-only" style="display:${isTravel ? 'block' : 'none'}">
        <label>ä¸Šè»Šåœ°é»ï¼š<select class="g-pickup">${$('pickup').innerHTML}</select></label>
        <label>æˆ¿å‹é¸æ“‡ï¼š<select class="g-room">${$('room').innerHTML}</select></label>
      </div>
    </div>
  `;
  $('guestContainer').appendChild(div);
};

function updateGuestName(input) {
  input.closest('.guest-card').querySelector('.g-name-lbl').innerText = input.value || "æ–°ä¾†è³“";
}

function toggleGuest(id) {
  const card = $(id);
  const body = card.querySelector('.guest-body');
  const arrow = card.querySelector('.g-arrow');
  const isHidden = body.style.display === 'none';
  body.style.display = isHidden ? 'block' : 'none';
  arrow.innerText = isHidden ? 'ï¼' : 'ï¼‹';
}

function removeGuest(id, e) {
  e.stopPropagation();
  if(confirm("ç¢ºå®šè¦ç§»é™¤é€™ä½ä¾†è³“å—ï¼Ÿ")) $(id).remove();
}

// --- å…¶ä»–è¼”åŠ©é‚è¼¯ ---
function updatePickupMap() {
  const opt = $('pickup').selectedOptions[0];
  if (opt && opt.value && opt.dataset.mapurl) { 
    $('locLabel').innerText = opt.value; 
    $('pickupMapLink').style.display = 'block'; 
  } else { $('pickupMapLink').style.display = 'none'; }
}
function openPickupMap() { 
  const url = $('pickup').selectedOptions[0].dataset.mapurl; 
  if (url) window.open(url, '_blank'); 
}

function renderStatsView(data, type) {
  const users = data.users || [];
  CURRENT_STATS_DATA.users = users; 
  
  const totalPeople = users.reduce((s, u) => s + (parseInt(u.people) || 0), 0);
  
  // çµæ§‹æ›´æ–°ï¼šæ–‡å­—åœ¨å·¦ï¼ŒæŒ‰éˆ•åœ¨å³
  $('uStats').innerHTML = `
    <strong>ğŸ‘¤ ç¸½å ±åï¼š${totalPeople} äºº</strong>
    <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½åå–®</button>
  `;
  
  let uHtml = `<hr><strong>ğŸ“ å ±ååå–®ï¼š</strong>`;
  users.forEach(u => {
    // é€™è£¡åŒæ­¥å„ªåŒ–ç¶²é ç«¯çš„é¡¯ç¤º
    let detail = type === 'æ—…éŠ' 
      ? `${u.pickup} / ${u.room || 'æœªé¸æˆ¿'}` 
      : `${u.table || 0}æ¡Œ`;
    uHtml += `<div class="user-list-item">${u.userName} (${u.people}äºº) [${detail}]</div>`;
  });
  $('uDetail').innerHTML = uHtml;
  
  let spHtml = `<hr><strong>ğŸ è´ŠåŠ©å½™æ•´ï¼š</strong><br>`;
  if(data.sponsor && Object.keys(data.sponsor).length > 0) {
    for (let k in data.sponsor) spHtml += `â€¢ ${k}: ${data.sponsor[k]}<br>`;
  } else { spHtml += 'æš«ç„¡è´ŠåŠ©'; }
  $('sStats').innerHTML = spHtml; 
  $('stats').style.display = 'block';
}

function renderItinerary() {
  const list = masterOptions.itinerary;
  if (!list || list.length === 0) { $('itineraryBox').style.display = 'none'; return; }
  const container = $('itineraryContent'); 
  container.innerHTML = ''; 
  const days = [...new Set(list.map(i => i.day))].sort((a, b) => a - b);
  days.forEach((day, idx) => {
    const div = document.createElement('div'); div.className = 'day-section';
    div.innerHTML = `<div class="day-toggle" onclick="toggleDay(this)"><span>ç¬¬ ${day} å¤©</span><span class="day-arrow">${idx === 0 ? 'ï¼' : 'ï¼‹'}</span></div>
      <div class="day-content" style="display: ${idx === 0 ? 'block' : 'none'}"><table class="itinerary-table">
      ${list.filter(i => i.day == day).map(i => `<tr><td>${i.startTime}</td><td>${i.startLoc}</td><td>${i.endTime}</td><td>${i.endLoc}</td></tr>`).join('')}
      </table></div>`;
    container.appendChild(div);
  });
  $('itineraryBox').style.display = 'block';
}

$('addSponsorBtn').onclick = createSponsorRow;
function createSponsorRow() {
  const rowId = 'spRow_' + Date.now();
  const div = document.createElement('div'); div.className = 'sponsor-item'; div.id = rowId;
  div.innerHTML = `<div class="sponsor-header"><span>è´ŠåŠ©é …ç›®</span><button type="button" class="remove-btn" onclick="removeRow('${rowId}')">ğŸ—‘ï¸</button></div>
    <select class="sponsor-select" onchange="handleSponsorChange('${rowId}')"></select>
    <div class="qtyGrp" style="display:none; margin-top:8px;">
      <select class="qtySelect" onchange="handleQtyChange('${rowId}')" style="display:none;"></select>
      <input type="text" class="otherInput" placeholder="è«‹è‡ªå¡«é …ç›®" style="display:none;">
      <div class="custom-qty-grp" style="display:none;"><input type="number" class="cQty" value="5" onchange="validateCustomQty('${rowId}')">
      <select class="cUnit" onchange="validateCustomQty('${rowId}')"><option value="ç“¶">ç“¶</option><option value="ç®±">ç®±</option></select></div>
      <div class="moneyGrp" style="display:none;"><input type="number" class="mVal" value="500"> <span>å…ƒ</span></div>
    </div>`;
  $('sponsorContainer').appendChild(div);
  const sel = div.querySelector('.sponsor-select'); 
  sel.add(new Option("-- è«‹é¸æ“‡ --", "")); 
  sel.add(new Option("ç„¡", "ç„¡"));
  masterOptions.sponsor.filter(s => s !== "ç„¡").forEach(s => sel.add(new Option(s, s)));
}
function handleSponsorChange(id) {
  const r = $(id), v = r.querySelector('.sponsor-select').value, qG = r.querySelector('.qtyGrp'), qS = r.querySelector('.qtySelect'), oI = r.querySelector('.otherInput'), mG = r.querySelector('.moneyGrp');
  qG.style.display = (v && v !== 'ç„¡') ? 'block' : 'none';
  qS.style.display = oI.style.display = mG.style.display = 'none';
  if (v === 'å…¶ä»–') oI.style.display = 'block';
  else if (v === 'ç´…åŒ…') mG.style.display = 'flex';
  else if (v && v !== 'ç„¡') {
    qS.style.display = 'block'; qS.innerHTML = '';
    let its = v.includes('é…’') ? ['1ç“¶','2ç“¶','3ç“¶','4ç“¶','5ç“¶','1ç®±(6ç“¶)','2ç®±(12ç“¶)','è‡ªå®šç¾©æ•¸é‡'] : masterOptions.sponsorQty;
    its.forEach(q => qS.add(new Option(q, q)));
  }
  checkSponsorAddButton();
}
function handleQtyChange(id) { 
  $(id).querySelector('.custom-qty-grp').style.display = ($(id).querySelector('.qtySelect').value === 'è‡ªå®šç¾©æ•¸é‡') ? 'flex' : 'none'; 
}
function validateCustomQty(id) { 
  const r = $(id), u = r.querySelector('.cUnit').value, i = r.querySelector('.cQty'); 
  if (u === 'ç“¶' && i.value < 6) i.value = 6; 
  if (u === 'ç®±' && i.value < 3) i.value = 3; 
}
function removeRow(id) { 
  $(id).remove(); 
  checkSponsorAddButton(); 
  if ($('sponsorContainer').children.length === 0) createSponsorRow(); 
}
function checkSponsorAddButton() { 
  const s = document.querySelectorAll('.sponsor-select'); 
  $('addSponsorBtn').style.display = (s[s.length - 1]?.value && s[s.length - 1]?.value !== 'ç„¡') ? 'block' : 'none'; 
}

// --- æäº¤èˆ‡å–æ¶ˆé‚è¼¯ ---
$('regForm').onsubmit = async (e) => {
  e.preventDefault();
  const o = $('eventSelect').selectedOptions[0].dataset;
  
  if (o.type === 'æ—…éŠ') {
    if (!$('pickup').value) return alert("è«‹é¸æ“‡æœ¬äººçš„ä¸Šè»Šåœ°é»");
    if (!$('room').value) return alert("è«‹é¸æ“‡æœ¬äººçš„æˆ¿å‹");
  }

  const sponsorList = [];
  document.querySelectorAll('.sponsor-item').forEach(r => {
    const n = r.querySelector('.sponsor-select').value; if(!n || n === 'ç„¡') return;
    if (n === 'å…¶ä»–') { 
      const val = r.querySelector('.otherInput').value;
      if(val) sponsorList.push(val); 
    } else if (n === 'ç´…åŒ…') { 
      sponsorList.push(`ç´…åŒ…(${r.querySelector('.mVal').value}å…ƒ)`); 
    } else {
      const q = r.querySelector('.qtySelect').value;
      sponsorList.push(q === 'è‡ªå®šç¾©æ•¸é‡' ? `${n}(${r.querySelector('.cQty').value}${r.querySelector('.cUnit').value})` : `${n}(${q})`);
    }
  });

  const queue = [];
  queue.push({
    eventId: o.eventid,
    eventType: o.type,
    userId: $('userId').value,
    userName: $('userName').value,
    people: $('people').value,
    table: (o.type === 'å°¾ç‰™' || o.type === 'èšæœƒ' || o.type === 'é¤æœƒ') ? $('table').value : '',
    pickup: o.type === 'æ—…éŠ' ? $('pickup').value : '',
    room: o.type === 'æ—…éŠ' ? ($('room').value === 'æˆ‘è¦ä½µæˆ¿' ? 'æˆ‘è¦ä½µæˆ¿' : `${$('room').value} (1é–“)`) : '',
    sponsor: sponsorList.join(', ') || 'ç„¡',
    memo: $('memo').value
  });

  document.querySelectorAll('.guest-card').forEach((c, index) => {
    const gName = c.querySelector('.g-name').value;
    const gRoom = c.querySelector('.g-room').value;
    if (!gName) return;
    
    queue.push({
      eventId: o.eventid,
      eventType: o.type,
      userId: $('userId').value + "_guest_" + index,
      userName: gName + " (ä¾†è³“)",
      people: c.querySelector('.g-people').value,
      table: (o.type === 'å°¾ç‰™' || o.type === 'èšæœƒ' || o.type === 'é¤æœƒ') ? $('table').value : '',
      pickup: o.type === 'æ—…éŠ' ? c.querySelector('.g-pickup').value : '',
      room: o.type === 'æ—…éŠ' ? (gRoom === 'æˆ‘è¦ä½µæˆ¿' ? 'æˆ‘è¦ä½µæˆ¿' : `${gRoom} (1é–“)`) : '',
      sponsor: "ç„¡",
      memo: `ç”± ${$('userName').value} ä»£å ±å`
    });
  });

  $('subBtn').disabled = true;
  $('subBtn').innerText = "è™•ç†ä¸­...";

  try {
    let successCount = 0;
    for (const payload of queue) {
      const r = await callApi('modify', `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
      if (r.status === "success") successCount++;
    }
    alert(`æˆåŠŸè™•ç† ${successCount} ä½å ±åç´€éŒ„ï¼`);
    location.reload();
  } catch (err) {
    alert("éƒ¨åˆ†æˆ–å…¨éƒ¨å ±åå¤±æ•—");
    $('subBtn').disabled = false;
    $('subBtn').innerText = "é€å‡ºå ±å";
  }
};

$('cancelBtn').onclick = async () => {
  if (!confirm("è­¦å‘Šï¼šå–æ¶ˆå ±åå°‡æœƒä¸€ä½µç§»é™¤æ‚¨åä¸‹çš„æ‰€æœ‰ä¾†è³“ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  const o = $('eventSelect').selectedOptions[0].dataset;
  $('cancelBtn').disabled = true;
  $('cancelBtn').innerText = "è™•ç†ä¸­...";
  try {
    const r = await callApi('cancel', `&payload=${encodeURIComponent(JSON.stringify({ eventId: o.eventid, userId: $('userId').value }))}`);
    alert(r.message); 
    location.reload();
  } catch (err) {
    alert("å–æ¶ˆå¤±æ•—");
    $('cancelBtn').disabled = false;
  }
};

window.onload = init;
</script>
</body>
</html>
