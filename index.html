<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ´»å‹•å ±åç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin:15px; background:#f0f2f5; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { text-align:center; color: #1a73e8; }
  label { display:block; margin-top:12px; font-weight: bold; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  .btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
  button { padding:12px; width:48%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-weight: bold; }
  button.cancel { background:#e53935; }
  #eventInfo, #stats { margin-top:15px; padding:15px; border-radius:8px; display:none; }
  #eventInfo { background:#e8f0fe; border-left: 5px solid #1a73e8; }
  #stats { background:#f8f9fa; border-left: 5px solid #4CAF50; }
  #result { margin-top:15px; text-align: center; font-weight:bold; }
  .stat-item { margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ´»å‹•å ±åç³»çµ±</h2>
  <label>é¸æ“‡æ´»å‹•ï¼š<select id="eventSelect"><option value="">è¼‰å…¥ä¸­...</option></select></label>
  <div id="eventInfo">
    <h3 id="evTitle" style="margin:0; color:#1a73e8;"></h3>
    <p>ğŸ‘¤ ä¸»è¾¦ï¼š<span id="evHost"></span> | ğŸ“… <span id="evTime"></span></p>
    <p>ğŸ“ <span id="evStore"></span> (<span id="evAddress"></span>)</p>
  </div>
  <form id="regForm" style="display:none;">
    <label>å ±åè€…ï¼š<input type="text" id="userName" readonly></label>
    <input type="hidden" id="userId">
    <label>äººæ•¸ï¼š<select id="people"></select></label>
    <div id="weiyaFields" style="display:none;"><label>èªæ¡Œï¼š<select id="table"></select></label></div>
    <div id="travelFields" style="display:none;">
      <label>ä¸Šè»Šé»ï¼š<select id="pickup"></select></label>
      <label>æˆ¿å‹ï¼š<select id="room"></select></label>
    </div>
    <label>è´ŠåŠ©ï¼š<select id="sponsor"></select></label>
    <div id="spOtherGrp" style="display:none;"><label>é …ç›®ï¼š<input type="text" id="spOther"> </label></div>
    <label id="qtyLbl">æ•¸é‡ï¼š<select id="qty"></select></label>
    <label>å‚™è¨»ï¼š<textarea id="memo" rows="2"></textarea></label>
    <div class="btn-group">
      <button type="submit" id="subBtn">é€å‡ºæ›´æ–°</button>
      <button type="button" class="cancel" id="canBtn">å–æ¶ˆå ±å</button>
    </div>
  </form>
  <div id="result"></div>
  <div id="stats">
    <h3 style="margin:0; font-size:16px; color:#2e7d32;">ğŸ“Š çµ±è¨ˆå›å ±</h3>
    <div id="uStats" class="stat-item"></div>
    <div id="dStats" class="stat-item"></div>
    <div id="sStats"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);

async function init(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  $('userName').value = p.displayName;
  $('userId').value = p.userId;
  loadEvents();
}

async function loadEvents(){
  const [evs, myJoined] = await Promise.all([
    fetch(`${GAS_URL}?action=getEvents`).then(r => r.json()),
    fetch(`${GAS_URL}?action=queryStats&all=true`).then(r => r.json())
  ]);
  
  $('eventSelect').innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
  evs.forEach(ev => {
    const isJoined = myJoined.some(j => j.eventId === ev.eventId && j.userId === $('userId').value);
    const opt = document.createElement('option');
    opt.value = ev.eventId;
    opt.text = `${ev.title} (${ev.type})${isJoined ? ' ã€ âœ… å·²å ±å ã€‘' : ''}`;
    Object.keys(ev).forEach(k => opt.dataset[k] = ev[k] || '');
    $('eventSelect').add(opt);
  });
}

$('eventSelect').onchange = () => {
  const o = $('eventSelect').selectedOptions[0];
  if(!o.value) { $('regForm').style.display = $('eventInfo').style.display = $('stats').style.display = 'none'; return; }
  const isW = o.dataset.type === 'å°¾ç‰™';
  $('eventInfo').style.display = $('regForm').style.display = $('stats').style.display = 'block';
  $('evTitle').innerText = o.dataset.title;
  $('evHost').innerText = o.dataset.host;
  $('evStore').innerText = o.dataset.store;
  $('evAddress').innerText = o.dataset.address;
  $('evTime').innerText = isW ? o.dataset.time : `${o.dataset.startDate} ~ ${o.dataset.endDate}`;
  $('weiyaFields').style.display = isW ? 'block' : 'none';
  $('travelFields').style.display = isW ? 'none' : 'block';
  loadStats(o.value);
};

$('regForm').onsubmit = async (e) => {
  e.preventDefault();
  $('subBtn').disabled = true;
  $('result').innerText = 'è™•ç†ä¸­...';
  const o = $('eventSelect').selectedOptions[0];
  const payload = {
    eventId: o.value, eventType: o.dataset.type, userId: $('userId').value, userName: $('userName').value,
    people: $('people').value, table: $('table').value, pickup: $('pickup').value, room: $('room').value,
    sponsor: $('sponsor').value, sponsorOther: $('spOther').value, qty: $('qty').value, memo: $('memo').value
  };
  const r = await fetch(`${GAS_URL}?action=modify&payload=${encodeURIComponent(JSON.stringify(payload))}`).then(r=>r.json());
  $('result').innerHTML = `<span style="color:blue">${r.message}</span>`;
  $('subBtn').disabled = false;
  loadEvents(); // åˆ·æ–°é¸å–®ç‹€æ…‹
  loadStats(o.value);
};

$('canBtn').onclick = async () => {
  if(!confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) return;
  const o = $('eventSelect').selectedOptions[0];
  const r = await fetch(`${GAS_URL}?action=cancel&payload=${encodeURIComponent(JSON.stringify({eventId:o.value, userId:$('userId').value}))}`).then(r=>r.json());
  $('result').innerText = r.message;
  loadEvents();
  loadStats(o.value);
};

async function loadStats(id) {
  const d = await fetch(`${GAS_URL}?action=queryStats&eventId=${id}`).then(r=>r.json());
  const isW = $('eventSelect').selectedOptions[0].dataset.type === 'å°¾ç‰™';
  let t = 0; d.users.forEach(u => t += parseInt(u.people)||0);
  $('uStats').innerHTML = `<strong>ğŸ‘¥ ç¸½äººæ•¸ï¼š${t} äºº</strong><br>` + d.users.map(u => `${u.userName}(${u.people})`).join(', ');
  
  let det = `<strong>${isW?'ğŸ—„ï¸ æ¡Œæ•¸':'ğŸ¨ æˆ¿å‹'}ï¼š</strong><br>`;
  const tar = isW ? d.tableStats : d.roomStats;
  const keys = Object.keys(tar).filter(k => k && k!=="undefined");
  if(keys.length) keys.forEach(k => det += `â€¢ ${k}: ${tar[k]}${(!k.includes('æ¡Œ')&&!k.includes('é–“'))?(isW?' æ¡Œ':' é–“'):''}<br>`);
  else det += 'ç„¡è³‡æ–™';
  $('dStats').innerHTML = det;

  let s = `<strong>ğŸ è´ŠåŠ©ï¼š</strong><br>`;
  const sk = Object.keys(d.sponsor).filter(k => k);
  if(sk.length) sk.forEach(k => s += `â€¢ ${k}: ${d.sponsor[k]}<br>`);
  else s += 'ç„¡';
  $('sStats').innerHTML = s;
}

$('sponsor').onchange = () => {
  $('spOtherGrp').style.display = $('sponsor').value === 'å…¶ä»–' ? 'block' : 'none';
  $('qtyLbl').style.display = $('sponsor').value === 'ç„¡' ? 'none' : 'block';
};

window.onload = () => {
  init();
  ['people','table','pickup','room','sponsor','qty'].forEach(async (t) => {
    const d = await fetch(`${GAS_URL}?action=getOptions&type=${t==='qty'?'sponsorQty':t}`).then(r=>r.json());
    const el = $(t); el.innerHTML = '';
    d.forEach(v => { const opt = new Option(v, v); el.add(opt); });
  });
};
</script>
</body>
</html>
