<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin:15px; background:#f0f2f5; color: #333; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { text-align:center; color: #1a73e8; margin-bottom: 20px; }
  label { display:block; margin-top:12px; font-weight: bold; color: #555; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  .btn-group { margin-top: 25px; }
  button { padding:12px; width:100%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 16px; }
  button:hover { background: #45a049; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  button.delete-btn { background:#e53935; margin-top: 12px; } 
  button.delete-btn:hover { background:#d32f2f; }
  
  #eventInfo, #stats { margin-top:15px; padding:15px; border-radius:8px; display:none; }
  #eventInfo { background:#e8f0fe; border-left: 5px solid #1a73e8; }
  #stats { background:#f8f9fa; border-left: 5px solid #4CAF50; }
  
  /* åœ°å€æ¨£å¼å„ªåŒ– */
  .address-wrapper { display: flex; align-items: flex-start; margin-top: 10px; }
  .address-content { display: flex; align-items: center; cursor: pointer; color: #1a73e8; font-weight: 500; }
  .address-content:hover { text-decoration: underline; }
  .gm-icon { width: 20px; height: 20px; margin-left: 6px; flex-shrink: 0; }

  /* è¡Œç¨‹è¡¨æ‘ºç–Š */
  .itinerary-container { margin-top: 15px; background: #fff; border: 1px solid #cce0ff; border-radius: 6px; overflow: hidden; }
  .itinerary-header { background: #1a73e8; color: white; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: bold; }
  .itinerary-content { display: none; padding: 10px; font-size: 13px; max-height: 500px; overflow-y: auto; background: #fcfdfe; }
  .day-section { margin-bottom: 8px; border: 1px solid #e0e6ed; border-radius: 6px; overflow: hidden; }
  .day-toggle { background: #f8faff; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #1a73e8; font-size: 13px; }
  .day-content { display: none; padding: 8px; }
  .itinerary-table { width: 100%; border-collapse: collapse; }
  .itinerary-table th, .itinerary-table td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: left; }
  .itinerary-table th { color: #1a73e8; font-size: 11px; }

  /* è´ŠåŠ©èˆ‡çµ±è¨ˆ */
  .sponsor-item { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px; position: relative; }
  .remove-btn { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 18px; float: right; }
  .add-sponsor-btn { background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; display:none; }
  .user-list-item { font-size: 13px; color: #666; padding: 4px 0 4px 10px; border-left: 2px solid #1a73e8; margin: 6px 0; background: #fff; }
  .map-link-btn { background: #e8f0fe; color: #1a73e8; border: 1px solid #1a73e8; padding: 10px; border-radius: 6px; font-size: 13px; cursor: pointer; text-align: center; margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <h2>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</h2>
  <label>é¸æ“‡æ´»å‹•ï¼š<select id="eventSelect"><option value="">è¼‰å…¥æ´»å‹•ä¸­...</option></select></label>

  <div id="eventInfo">
    <h3 id="evTitle" style="margin:0 0 10px 0; color:#1a73e8;"></h3>
    <p>ğŸ‘¤ ä¸»è¾¦äººï¼š<span id="evHost"></span></p>
    <p>ğŸ“… æ™‚é–“ï¼š<span id="evTime"></span></p>
    <p>ğŸ“ åœ°é»ï¼š<span id="evStore"></span></p>
    <div class="address-wrapper">
      <span style="font-weight:bold; flex-shrink:0;">ğŸ  åœ°å€ï¼š</span>
      <div class="address-content" onclick="openGoogleMap()">
        <span id="evAddress"></span>
        <svg class="gm-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="#EA4335"/>
        </svg>
      </div>
    </div>
    
    <div id="itineraryBox" class="itinerary-container" style="display:none;">
      <div class="itinerary-header" onclick="toggleItinerary()">
        <span>ğŸ—ºï¸ æŸ¥çœ‹åˆ†å¤©è¡Œç¨‹è¡¨</span>
        <span id="arrow">ï¼‹</span>
      </div>
      <div id="itineraryContent" class="itinerary-content"></div>
    </div>
  </div>

  <form id="regForm" style="display:none;">
    <input type="hidden" id="userId">
    <label>å ±åè€…å§“åï¼š<input type="text" id="userName" readonly></label>
    <label>åƒåŠ äººæ•¸ï¼š<select id="people"></select></label>
    
    <div id="weiyaFields" style="display:none;"><label>èªæ¡Œæ•¸é‡ï¼š<select id="table"></select></label></div>
    
    <div id="travelFields" style="display:none;">
      <label><span style="color:red;">*</span> ä¸Šè»Šåœ°é»ï¼š</label>
      <select id="pickup" onchange="updatePickupMap()"></select>
      <div id="pickupMapLink" class="map-link-btn" style="display:none;" onclick="openPickupMap()">ğŸ“ æŸ¥çœ‹ [ <span id="locLabel"></span> ] ä¸Šè»Šä½ç½®</div>
      
      <label><span style="color:red;">*</span> æˆ¿å‹é¸æ“‡ï¼š</label>
      <select id="room"></select>
    </div>

    <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
    <label>ğŸ è´ŠåŠ©é …ç›®ç®¡ç†ï¼š</label>
    <div id="sponsorContainer"></div>
    <button type="button" class="add-sponsor-btn" id="addSponsorBtn">â• æ–°å¢è´ŠåŠ©é …ç›®</button>
    
    <label style="margin-top:20px;">å‚™è¨»ï¼š<textarea id="memo" rows="2" placeholder="ç‰¹æ®Šé£Ÿæ€§æˆ–å‚™è¨»"></textarea></label>
    
    <div class="btn-group">
      <button type="submit" id="subBtn">é€å‡ºå ±å</button>
      <button type="button" id="cancelBtn" class="delete-btn" style="display:none;">âŒ å–æ¶ˆå ±å</button>
    </div>
  </form>

  <div id="stats">
    <div id="uStats"></div>
    <div id="uDetail"></div>
    <div id="sStats" style="margin-top:10px;"></div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// [GAS ä¸²æ¥é‚è¼¯èˆ‡æ•¸æ“šè™•ç†ä¿æŒä¸è®Šï¼Œç•¥ä½œçµæ§‹èª¿æ•´å„ªåŒ–]
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);
let masterOptions = {};

// åˆå§‹åŒ– LIFF
async function init(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    $('userName').value = p.displayName; 
    $('userId').value = p.userId;
    
    const keys = ['sponsor','sponsorQty','people','table','pickup','room', 'itinerary'];
    const res = await Promise.all([...keys.map(k => callApi('getOptions', `&type=${k}`)), callApi('getEvents'), callApi('queryStats', '&all=true')]);
    
    keys.forEach((k, i) => masterOptions[k] = res[i]);
    renderEventSelect(res[7], res[8], p.userId);
  } catch (err) { console.error("Init error:", err); }
}

function renderEventSelect(events, stats, userId) {
  const sel = $('eventSelect');
  sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
  events.forEach(ev => {
    const joined = stats.some(j => String(j.eventId) === String(ev.eventId) && String(j.userId) === String(userId));
    const opt = new Option(`${joined ? 'ã€âœ… å·²å ±åã€‘ ' : ''}${ev.title} (${ev.type})`, ev.eventId);
    Object.assign(opt.dataset, ev, { joined });
    sel.add(opt);
  });
}

$('eventSelect').onchange = async () => {
  const o = $('eventSelect').selectedOptions[0];
  if(!o || !o.value) { $('regForm').style.display = 'none'; return; }
  const d = o.dataset;
  const currentStats = await callApi('queryStats', `&eventId=${o.value}`);
  
  // UI é¡¯ç¤ºåˆ‡æ›
  $('subBtn').innerText = d.joined === 'true' ? 'ç·¨è¼¯å ±å' : 'é€å‡ºå ±å';
  $('cancelBtn').style.display = d.joined === 'true' ? 'block' : 'none';
  $('regForm').style.display = $('eventInfo').style.display = 'block';
  
  // æ¸²æŸ“åŸºç¤è³‡æ–™
  $('evTitle').innerText = d.title;
  $('evHost').innerText = d.host;
  $('evStore').innerText = d.store;
  $('evAddress').innerText = d.address;
  
  // è™•ç†æ™‚é–“æ ¼å¼
  if (d.type === 'å°¾ç‰™') {
    const dt = new Date(d.time);
    $('evTime').innerText = `${formatOnlyDate(d.time)} ${getDayOfWeek(d.time)} ${isNaN(dt.getHours()) ? "" : dt.getHours().toString().padStart(2,'0')+':'+dt.getMinutes().toString().padStart(2,'0')}`;
    $('weiyaFields').style.display = 'block'; $('travelFields').style.display = 'none';
    $('itineraryBox').style.display = 'none';
    fillOptions('table', masterOptions.table);
  } else {
    $('evTime').innerText = `${formatOnlyDate(d.startdate)} ~ ${formatOnlyDate(d.enddate)}`;
    $('travelFields').style.display = 'block'; $('weiyaFields').style.display = 'none';
    fillPickup(masterOptions.pickup);
    fillRooms(masterOptions.room, currentStats.users || []);
    renderItinerary(masterOptions.itinerary);
  }
  
  fillOptions('people', masterOptions.people);
  $('sponsorContainer').innerHTML = ''; 
  createSponsorRow();
  renderStatsView(currentStats, d.type);
};

// å·¥å…·å‡½å¼èˆ‡è´ŠåŠ©é‚è¼¯
function fillOptions(id, list) {
  const el = $(id); el.innerHTML = '';
  list.forEach(x => el.add(new Option(x, x)));
}

function fillPickup(list) {
  const el = $('pickup'); el.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸Šè»Šé» --</option>';
  list.forEach(item => {
    const opt = new Option(item.name, item.name);
    opt.dataset.mapurl = item.info;
    el.add(opt);
  });
}

function fillRooms(list, users) {
  const el = $('room'); el.innerHTML = '<option value="">-- è«‹é¸æ“‡æˆ¿å‹ --</option>';
  el.add(new Option("æˆ‘è¦ä½µæˆ¿ (ç”±ä¸»è¾¦å–®ä½å®‰æ’)", "æˆ‘è¦ä½µæˆ¿"));
  list.forEach(item => {
    const used = users.reduce((acc, u) => (u.room && u.room.startsWith(item.name)) ? acc + 1 : acc, 0);
    const remain = (parseInt(item.totalCount) || 0) - used;
    const opt = new Option(`${item.name} ($${item.price} / å‰©${remain}é–“)`, item.name);
    if (remain <= 0) { opt.disabled = true; opt.text = `${item.name} (å·²å”®å®Œ)`; }
    el.add(opt);
  });
}

function createSponsorRow() {
  const container = $('sponsorContainer');
  const rowId = 'spRow_' + Date.now();
  const div = document.createElement('div');
  div.className = 'sponsor-item'; div.id = rowId;
  div.innerHTML = `
    <button type="button" class="remove-btn" onclick="removeRow('${rowId}')">Ã—</button>
    <label>é …ç›®ï¼š</label>
    <select class="sponsor-select" onchange="handleSponsorChange('${rowId}')"></select>
    <div class="qtyGrp" style="display:none; margin-top:8px;">
      <select class="qtySelect" onchange="handleQtyChange('${rowId}')"></select>
      <input type="text" class="otherInput" placeholder="è«‹è‡ªå¡«é …ç›®" style="display:none;">
      <div class="custom-qty-grp" style="display:none; margin-top:8px;">
        <input type="number" class="cQty" value="5" style="width:70px">
        <select class="cUnit" style="width:70px"><option value="ç“¶">ç“¶</option><option value="ç®±">ç®±</option></select>
      </div>
      <div class="moneyGrp" style="display:none; margin-top:8px;">
        <input type="number" class="mVal" value="500" step="500" style="width:100px"> å…ƒ
      </div>
    </div>`;
  container.appendChild(div);
  const sel = div.querySelector('.sponsor-select');
  sel.add(new Option("-- è«‹é¸æ“‡ --", ""));
  sel.add(new Option("ç„¡", "ç„¡"));
  masterOptions.sponsor.filter(s => s !== "ç„¡" && s !== "å…¶ä»–").forEach(s => sel.add(new Option(s, s)));
  sel.add(new Option("å…¶ä»– (è‡ªå¡«é …ç›®)", "å…¶ä»–"));
}

function handleSponsorChange(id) {
  const row = $(id), val = row.querySelector('.sponsor-select').value;
  const qGrp = row.querySelector('.qtyGrp'), qSel = row.querySelector('.qtySelect'), 
        oInp = row.querySelector('.otherInput'), mGrp = row.querySelector('.moneyGrp');
  
  qGrp.style.display = (val && val !== 'ç„¡') ? 'block' : 'none';
  qSel.style.display = (val !== 'å…¶ä»–' && val !== 'ç´…åŒ…') ? 'block' : 'none';
  oInp.style.display = (val === 'å…¶ä»–') ? 'block' : 'none';
  mGrp.style.display = (val === 'ç´…åŒ…') ? 'block' : 'none';

  if (qSel.style.display === 'block') {
    qSel.innerHTML = '';
    const items = val.includes('é…’') ? ['1ç“¶','2ç“¶','3ç“¶','5ç“¶','1ç®±(6ç“¶)','è‡ªå®šç¾©æ•¸é‡'] : masterOptions.sponsorQty;
    items.forEach(q => qSel.add(new Option(q, q)));
  }
  checkSponsorAddButton();
}

function handleQtyChange(id) {
  const row = $(id);
  row.querySelector('.custom-qty-grp').style.display = (row.querySelector('.qtySelect').value === 'è‡ªå®šç¾©æ•¸é‡') ? 'flex' : 'none';
}

function removeRow(id) { $(id).remove(); checkSponsorAddButton(); if($('sponsorContainer').children.length === 0) createSponsorRow(); }
function checkSponsorAddButton() {
  const sels = document.querySelectorAll('.sponsor-select');
  const last = sels[sels.length-1]?.value;
  $('addSponsorBtn').style.display = (last && last !== 'ç„¡') ? 'block' : 'none';
}

function renderItinerary(list) {
  if (!list || list.length === 0) { $('itineraryBox').style.display = 'none'; return; }
  const container = $('itineraryContent'); container.innerHTML = '';
  const days = [...new Set(list.map(i => i.day))].sort((a,b) => a-b);
  days.forEach((d, idx) => {
    const div = document.createElement('div');
    div.className = 'day-section';
    div.innerHTML = `
      <div class="day-toggle" onclick="toggleDay(this)"><span>ç¬¬ ${d} å¤©</span><span>ï¼‹</span></div>
      <div class="day-content">
        <table class="itinerary-table">
          ${list.filter(i => i.day == d).map(i => `<tr><td>${i.startTime || '-'}</td><td>${i.startLoc} â” ${i.endLoc}</td></tr>`).join('')}
        </table>
      </div>`;
    container.appendChild(div);
  });
  $('itineraryBox').style.display = 'block';
}

function toggleDay(el) {
  const content = el.nextElementSibling;
  const isShow = content.style.display === 'block';
  content.style.display = isShow ? 'none' : 'block';
  el.children[1].innerText = isShow ? 'ï¼‹' : 'ï¼';
}

function toggleItinerary() {
  const content = $('itineraryContent');
  const isShow = content.style.display === 'block';
  content.style.display = isShow ? 'none' : 'block';
  $('arrow').innerText = isShow ? 'ï¼‹' : 'ï¼';
}

async function callApi(action, extra = '') {
  const r = await fetch(`${GAS_URL}?action=${action}${extra}&ts=${Date.now()}`);
  return r.json();
}

function formatOnlyDate(val) {
  const d = new Date(val);
  return isNaN(d.getTime()) ? val : `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
}

function getDayOfWeek(dateStr) {
  const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const d = new Date(dateStr);
  return isNaN(d.getTime()) ? '' : `(${days[d.getDay()]})`;
}

function openGoogleMap() {
  const o = $('eventSelect').selectedOptions[0].dataset;
  if (!o.address) return;
  window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.store + ' ' + o.address)}`, '_blank');
}

function updatePickupMap() {
  const opt = $('pickup').selectedOptions[0];
  if (opt?.dataset.mapurl) { $('locLabel').innerText = opt.value; $('pickupMapLink').style.display = 'block'; }
  else { $('pickupMapLink').style.display = 'none'; }
}

function openPickupMap() { window.open($('pickup').selectedOptions[0].dataset.mapurl, '_blank'); }

function renderStatsView(data, type) {
  const users = data.users || [];
  $('uStats').innerHTML = `<strong>ğŸ‘¤ ç¸½å ±åï¼š${users.reduce((s, u) => s + (parseInt(u.people) || 0), 0)} äºº</strong>`;
  $('uDetail').innerHTML = '<p>ğŸ“ å ±ååå–®ï¼š</p>' + users.map(u => `<div class="user-list-item">${u.userName} (${u.people}äºº)${type==='æ—…éŠ'?` - ${u.pickup}`:''}</div>`).join('');
  
  let spHtml = '<strong>ğŸ è´ŠåŠ©å½™æ•´ï¼š</strong><br>';
  if(data.sponsor && Object.keys(data.sponsor).length > 0) {
    for (let k in data.sponsor) spHtml += `â€¢ ${k}: ${data.sponsor[k]}<br>`;
  } else { spHtml += 'æš«ç„¡è´ŠåŠ©'; }
  $('sStats').innerHTML = spHtml;
  $('stats').style.display = 'block';
}

$('regForm').onsubmit = async (e) => {
  e.preventDefault();
  const o = $('eventSelect').selectedOptions[0].dataset;
  const sponsorList = [];
  document.querySelectorAll('.sponsor-item').forEach(row => {
    const name = row.querySelector('.sponsor-select').value;
    if(!name || name === 'ç„¡') return;
    if (name === 'å…¶ä»–') { 
      const val = row.querySelector('.otherInput').value;
      if(val) sponsorList.push(val); 
    } else if (name === 'ç´…åŒ…') {
      sponsorList.push(`ç´…åŒ…(${row.querySelector('.mVal').value}å…ƒ)`);
    } else {
      const q = row.querySelector('.qtySelect').value;
      sponsorList.push(q === 'è‡ªå®šç¾©æ•¸é‡' ? `${name}(${row.querySelector('.cQty').value}${row.querySelector('.cUnit').value})` : `${name}(${q})`);
    }
  });

  $('subBtn').disabled = true;
  const payload = {
    eventId: o.eventId, userId: $('userId').value, userName: $('userName').value,
    people: $('people').value, table: o.type === 'å°¾ç‰™' ? $('table').value : '',
    pickup: o.type === 'æ—…éŠ' ? $('pickup').value : '',
    room: o.type === 'æ—…éŠ' ? ($('room').value === 'æˆ‘è¦ä½µæˆ¿' ? 'æˆ‘è¦ä½µæˆ¿' : `${$('room').value} (1é–“)`) : '',
    sponsor: sponsorList.join(', ') || 'ç„¡', memo: $('memo').value
  };
  const r = await callApi('modify', `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
  alert(r.message); location.reload();
};

$('cancelBtn').onclick = async () => {
  if (!confirm("ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ")) return;
  const o = $('eventSelect').selectedOptions[0].dataset;
  const r = await callApi('cancel', `&payload=${encodeURIComponent(JSON.stringify({ eventId: o.eventId, userId: $('userId').value }))}`);
  alert(r.message); location.reload();
};

window.onload = init;
</script>
</body>
</html>
