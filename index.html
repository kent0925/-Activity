<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJuAodySUQ0jUh0mNEvSv4D5J2Bi8GB7tp480BxHGyVOx-QeKiPJg7-KktBDtmKsf9/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';

function formatDateWithWeek(val){
  if(!val) return '';
  const d = new Date(val);
  if(isNaN(d.getTime())) return val;
  const local = new Date(d.getTime() + 8*60*60*1000);
  const weekMap = ['日','一','二','三','四','五','六'];
  const y = local.getFullYear();
  const m = String(local.getMonth()+1).padStart(2,'0');
  const day = String(local.getDate()).padStart(2,'0');
  const w = weekMap[local.getDay()];
  return `${y}/${m}/${day}（${w}）`;
}

function formatTimeWithWeek(val){
  if(!val) return '';
  const d = new Date(val);
  if(isNaN(d.getTime())) return val;
  const local = new Date(d.getTime() + 8*60*60*1000);
  const hh = String(local.getHours()).padStart(2,'0');
  const mm = String(local.getMinutes()).padStart(2,'0');
  const weekMap = ['日','一','二','三','四','五','六'];
  const w = weekMap[local.getDay()];
  return `${hh}:${mm}（${w}）`;
}

// LIFF 初始化
async function initLiff(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    userName.value = p.displayName;
    userId.value = p.userId;
  }catch(err){
    console.error('LIFF init error:', err);
    alert('LIFF 初始化失敗，請稍後再試');
  }
}

// 載入活動列表
async function loadEvents(){
  try{
    const res = await fetch(`${GAS_URL}?action=getEvents`);
    const data = await res.json();
    eventSelect.innerHTML = '<option value="">請選擇活動</option>';
    data.forEach(ev=>{
      const opt = document.createElement('option');
      opt.value = ev.eventId;
      opt.text = `${ev.title} (${ev.type})`;
      Object.keys(ev).forEach(k => opt.dataset[k] = ev[k] || '');
      eventSelect.add(opt);
    });
  }catch(err){
    console.error('Load events error:', err);
    alert('活動列表載入失敗');
  }
}

// 載入選項
async function loadOptions(type,id){
  try{
    const res = await fetch(`${GAS_URL}?action=getOptions&type=${type}`);
    const data = await res.json();
    const sel = document.getElementById(id);
    sel.innerHTML='';
    data.forEach(v=>{
      const o=document.createElement('option');
      o.value=v; o.text=v;
      sel.add(o);
    });
  }catch(err){
    console.error(`Load options ${type} error:`, err);
  }
}

// 顯示活動資訊
eventSelect.addEventListener('change',async ()=>{
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value){
    formFields.style.display='none';
    eventInfo.style.display='none';
    stats.style.display='none';
    return;
  }

  formFields.style.display='block';
  eventInfo.style.display='block';
  stats.style.display='block';

  evTitle.innerText = opt.dataset.title || '';
  evHost.innerText = opt.dataset.host || '';
  evStore.innerText = opt.dataset.store || '';
  evAddress.innerText = opt.dataset.address || '';

  if(opt.dataset.type==='尾牙'){
    evTime.innerText = formatTimeWithWeek(opt.dataset.time);
  }else{
    evTime.innerText = formatDateWithWeek(opt.dataset.startDate)+' ～ '+formatDateWithWeek(opt.dataset.endDate);
  }

  mapBtn.onclick = ()=>{
    const addr = encodeURIComponent(opt.dataset.address || '');
    window.open(`https://www.google.com/maps/search/?api=1&query=${addr}`);
  };

  tableLabel.style.display = opt.dataset.type==='尾牙'?'block':'none';
  pickupLabel.style.display = roomLabel.style.display = opt.dataset.type==='旅遊'?'block':'none';

  loadStats(opt.value);
});

// 贊助選項切換
sponsor.addEventListener('change',()=>{
  sponsorOtherLabel.style.display = sponsor.value==='其他'?'block':'none';
  qtyLabel.style.display = sponsor.value==='無'?'none':'block';
  if(sponsor.value!=='其他') sponsorOther.value='';
});

// 送出表單
registrationForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value) return alert('請先選擇活動');
  
  // 防重複提交
  const btn = e.target.querySelector('button[type="submit"]');
  btn.disabled = true;

  const payload = {
    eventId: opt.value,
    eventType: opt.dataset.type,
    userId: userId.value,
    userName: userName.value,
    people: people.value,
    table: table.value,
    pickup: pickup.value,
    room: room.value,
    sponsor: sponsor.value,
    sponsorOther: sponsorOther.value,
    qty: qty.value,
    memo: memo.value,
    action:'modify'
  };

  try{
    const res = await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        events:[{ postback:{ data: JSON.stringify(payload) }},
                { source:{ userId:userId.value }}]
      })
    });
    const r = await res.json();
    result.innerText = r.message;
    loadStats(opt.value);
  }catch(err){
    console.error('Submit error:', err);
    result.innerText = '送出失敗，請稍後再試';
  }finally{
    btn.disabled = false;
  }
});

// 取消報名
cancelBtn.addEventListener('click',async ()=>{
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value) return alert('請先選擇活動');

  const payload = {eventId:opt.value,userId:userId.value,action:'cancel'};
  cancelBtn.disabled = true;

  try{
    const res = await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        events:[{ postback:{ data: JSON.stringify(payload) }},
                { source:{ userId:userId.value }}]
      })
    });
    const r = await res.json();
    result.innerText = r.message;
    formFields.style.display='none';
    stats.style.display='none';

    // 清空欄位
    people.value='1';
    table.value='1';
    pickup.value='';
    room.value='';
    sponsor.value='無';
    sponsorOther.value='';
    memo.value='';
    qty.value='1';

    loadStats(opt.value);
  }catch(err){
    console.error('Cancel error:', err);
    result.innerText = '取消失敗，請稍後再試';
  }finally{
    cancelBtn.disabled = false;
  }
});

// 載入統計
async function loadStats(eventId){
  try{
    const res = await fetch(`${GAS_URL}?action=queryStats&eventId=${eventId}`);
    const data = await res.json();

    let totalPeople = 0;
    if(data.users && data.users.length>0){
      data.users.forEach(u=>{ totalPeople += parseInt(u.people)||0; });
    }
    let totalHtml = `<b>總報名人數：</b> ${totalPeople} 人<br>`;

    let userHtml='<b>使用者報名：</b><br>';
    if(data.users && data.users.length>0){
      data.users.forEach(u=>{
        userHtml+=`${u.userName}：${u.people}人<br>`;
      });
    }else userHtml+='尚無報名<br>';
    userStats.innerHTML = totalHtml + userHtml;

    let trHtml='<b>桌數 / 房型統計：</b><br>';
    if(data.tableRoom && Object.keys(data.tableRoom).length>0){
      for(const key in data.tableRoom){
        trHtml+=`${key}：${data.tableRoom[key]}<br>`;
      }
    }else trHtml+='尚無資料<br>';
    tableRoomStats.innerHTML=trHtml;

    let sponsorHtml='<b>贊助統計：</b><br>';
    if(data.sponsor && Object.keys(data.sponsor).length>0){
      for(const key in data.sponsor){
        sponsorHtml+=`${key}：${data.sponsor[key]}<br>`;
      }
    }else sponsorHtml+='尚無資料<br>';
    sponsorStats.innerHTML=sponsorHtml;

  }catch(err){
    console.error('Load stats error:', err);
  }
}

// DOMContentLoaded
window.addEventListener('DOMContentLoaded',async()=>{
  await initLiff();
  await loadEvents();
  loadOptions('people','people');
  loadOptions('table','table');
  loadOptions('pickup','pickup');
  loadOptions('room','room');
  loadOptions('sponsor','sponsor');
  loadOptions('sponsorQty','qty');
});
</script>
