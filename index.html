<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="address=no">
    <title>æ—…éŠ / é¤æœƒ å ±åç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;600&display=swap');

        :root {
            --primary: #06C755;
            --primary-dark: #05a346;
            --primary-soft: rgba(6, 199, 85, 0.12);
            --accent-red: #ff4757;
            --text-main: #2f3542;
            --text-sub: #747d8c;
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-white: rgba(255, 255, 255, 0.95);
            --shadow-soft: 0 10px 25px -5px rgba(0, 0, 0, 0.06), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            --radius-main: 24px;
            --radius-input: 12px;
        }

        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 520px;
            background: var(--glass-white);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 30px 24px;
            border-radius: var(--radius-main);
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary);
            border-radius: var(--radius-main) var(--radius-main) 0 0;
        }

        h2 {
            color: var(--text-main);
            margin: 10px 0 25px;
            text-align: center;
            font-weight: 700;
            font-size: 1.6rem;
            letter-spacing: -0.5px;
        }

        h3 {
            color: var(--primary-dark);
            font-size: 1.1rem;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
            display: flex;
            align-items: center;
        }

        /* Event Grid */
        .event-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .event-card {
            background: #fff;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 16px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .event-card:active { transform: scale(0.98); }

        .event-card.selected {
            border-color: var(--primary);
            background: var(--primary-soft);
            box-shadow: 0 8px 16px rgba(6, 199, 85, 0.2);
        }

        .event-card .badge {
            position: absolute;
            top: -8px;
            right: -5px;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .event-card .type-tag {
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .event-card .title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1.4;
        }

        /* Forms & Inputs */
        label {
            display: block;
            margin-top: 16px;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #edf2f7;
            border-radius: var(--radius-input);
            font-size: 16px; /* Prevent iOS Zoom */
            transition: all 0.2s;
            box-sizing: border-box;
            background: #fdfdfd;
            font-family: inherit;
            color: var(--text-main);
            -webkit-appearance: none;
        }

        select:focus, input:focus, textarea:focus {
            border-color: var(--primary);
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.1);
        }

        /* Buttons */
        .btn-group {
            margin-top: 30px;
            display: flex;
            gap: 12px;
        }

        button {
            padding: 14px;
            width: 100%;
            border: none;
            border-radius: var(--radius-input);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(6, 199, 85, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:active { transform: scale(0.98); }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            box-shadow: none;
            filter: grayscale(100%);
        }

        button.delete-btn {
            background: #fff1f0;
            color: var(--accent-red);
            box-shadow: none;
            border: 1px solid #fed7d7;
        }

        button.delete-btn:hover {
            background: #ffe5e5;
            border-color: var(--accent-red);
        }

        .btn-add-guest, .add-sponsor-btn {
            background: white;
            color: var(--text-main);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px dashed #e2e8f0;
            margin-top: 15px;
        }

        .btn-add-guest:hover, .add-sponsor-btn:hover {
            background: #f8fafc;
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Info & Stats Cards */
        #eventInfo, #stats {
            margin-top: 25px;
            padding: 24px;
            border-radius: 20px;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        #eventInfo p {
            margin: 8px 0;
            color: var(--text-sub);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Maps & Links */
        .store-wrapper, .address-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .web-icon, .gm-icon {
            width: 20px;
            height: 20px;
            fill: var(--primary);
            cursor: pointer;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .address-link {
            color: var(--text-main);
            text-decoration: none;
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }

        .map-link-btn {
            background: #eff6ff;
            color: #007AFF;
            border: 1px solid #bfdbfe;
            padding: 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }

        /* Itinerary */
        .itinerary-container {
            margin-top: 15px;
            border: 1px solid #edf2f7;
            border-radius: 14px;
            overflow: hidden;
        }

        .itinerary-header {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .day-section { border-bottom: 1px solid #edf2f7; }

        .day-toggle {
            padding: 10px 16px;
            background: #f8fafc;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        .itinerary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .itinerary-table td {
            padding: 8px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--text-sub);
        }

        /* Guests & Sponsors */
        .guest-card {
            border: 1px solid #edf2f7;
            border-radius: 16px;
            margin-top: 15px;
            background: #fff;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .guest-header {
            background: #f8fafc;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid #edf2f7;
            color: var(--text-main);
        }

        .guest-body { padding: 16px; }

        .sponsor-item {
            background: #fdfdfd;
            border: 1px solid #edf2f7;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.01);
        }

        .sponsor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .remove-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            padding: 0;
            background: #fee2e2;
            color: var(--accent-red);
        }

        /* User List */
        .user-list-item {
            font-size: 0.9rem;
            color: var(--text-main);
            padding: 10px 14px;
            border-left: 3px solid var(--primary);
            margin: 8px 0;
            background: #f8fafc;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
        }

        .copy-btn {
            background: #e6fffa;
            color: #06C755;
            border: 1px solid #06C755;
            padding: 6px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin: 0;
            width: auto;
            box-shadow: none;
        }

        #uStats {
            margin-bottom: 16px;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 12px;
        }

        hr {
            border: 0;
            border-top: 1px dashed #e2e8f0;
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>æ—…éŠ / é¤æœƒ å ±åç³»çµ±</h2>
        <label>é¸æ“‡æ´»å‹•ï¼š</label>
        <div id="eventGrid" class="event-grid">
            <p style="grid-column: span 2; text-align: center; color: var(--primary); padding: 10px;">ğŸš€ è¼‰å…¥ä¸­...</p>
        </div>
        <select id="eventSelect" style="display:none;">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>

        <div id="eventInfo" style="display:none;">
            <h3 id="evTitle" style="margin:0 0 16px 0; color:var(--text-main);"></h3>
            <p>ğŸ‘¤ <strong>ä¸»è¾¦äººï¼š</strong><span id="evHost"></span></p>
            <p>ğŸ“… <strong>æ™‚é–“ï¼š</strong><span id="evTime"></span></p>
            <p class="store-wrapper">
                ğŸ“ <strong>åœ°é»ï¼š</strong><span id="evStore"></span>
                <svg class="web-icon" onclick="openOfficialSite()" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                </svg>
            </p>
            <div class="address-wrapper">
                <span style="font-weight:600;min-width:45px;">ğŸ  åœ°å€ï¼š</span>
                <div class="address-link" onclick="openGoogleMap()">
                    <span id="evAddress"></span>
                    <svg class="gm-icon" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" />
                    </svg>
                </div>
            </div>
            <div id="itineraryBox" class="itinerary-container" style="display:none;">
                <div class="itinerary-header" onclick="toggleItinerary()"><span>ğŸ—ºï¸ æŸ¥çœ‹åˆ†å¤©è¡Œç¨‹è¡¨</span><span id="arrow">ï¼‹</span></div>
                <div id="itineraryContent" class="itinerary-content" style="display:none;"></div>
            </div>
        </div>

        <form id="regForm" style="display:none;">
            <input type="hidden" id="userId"><input type="hidden" id="userName">

            <div style="background: #f8fafc; padding: 20px; border-radius: 16px; margin-top: 20px;">
                <label style="margin-top:0;">å ±åè€…å§“å (æœ¬äºº)ï¼š</label>
                <input type="text" id="userNameShow" readonly style="background:#edf2f7; color:var(--text-sub);">

                <label>åƒåŠ äººæ•¸ï¼š</label>
                <select id="people"></select>

                <div id="weiyaFields" style="display:none;">
                    <label>èªæ¡Œæ•¸é‡ï¼š</label>
                    <select id="table"></select>
                </div>

                <div id="travelFields" style="display:none;">
                    <label><span style="color:var(--accent-red);">*</span> ä¸Šè»Šåœ°é»ï¼š</label>
                    <select id="pickup" onchange="updatePickupMap()"></select>
                    <div id="pickupMapLink" class="map-link-btn" style="display:none;" onclick="openPickupMap()">ğŸ“ æŸ¥çœ‹ [ <span id="locLabel"></span> ] ä¸Šè»Šä½ç½®</div>

                    <label><span style="color:var(--accent-red);">*</span> æˆ¿å‹é¸æ“‡ï¼š</label>
                    <select id="room"></select>
                </div>
            </div>

            <div id="guestContainer"></div>
            <button type="button" class="btn-add-guest" id="addGuestBtn">â• æ–°å¢ä¾†è³“å ±å</button>

            <hr>
            <label>ğŸ è´ŠåŠ©é …ç›®ç®¡ç†ï¼š</label>
            <div id="sponsorContainer"></div>
            <button type="button" class="add-sponsor-btn" id="addSponsorBtn">â• æ–°å¢è´ŠåŠ©é …ç›®</button>

            <label style="margin-top:20px;">å‚™è¨»ï¼š</label>
            <textarea id="memo" rows="2" placeholder="ç‰¹æ®Šé£Ÿæ€§ã€æˆ¿å‹å€™è£œæˆ–ä½µæˆ¿éœ€æ±‚èªªæ˜..."></textarea>

            <div class="btn-group">
                <button type="submit" id="subBtn">é€å‡ºå ±å</button>
                <button type="button" id="cancelBtn" class="delete-btn" style="display:none;">âŒ å–æ¶ˆå ±å</button>
            </div>
        </form>

        <div id="stats" style="display:none;">
            <div id="uStats"></div>
            <div id="uDetail" style="margin-bottom:15px;"></div>
            <div id="sStats"></div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
        const LIFF_ID = '2008678090-TpSkCDSZ';
        const $ = id => document.getElementById(id);
        let masterOptions = { sponsor: [], sponsorQty: [], people: [], table: [], pickup: [], room: [], itinerary: [] };
        let CURRENT_STATS_DATA = { users: [], eventInfo: {}, type: "" };

        // XSS Protection Helper
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&', '<': '<', '>': '>', '"': '"', "'": "'" }[m];
            });
        }

        function copyToClipboard() {
            if (!CURRENT_STATS_DATA.users || CURRENT_STATS_DATA.users.length === 0) {
                alert("ç›®å‰å°šç„¡å ±åè³‡æ–™å¯è¤‡è£½");
                return;
            }
            const info = CURRENT_STATS_DATA.eventInfo;
            const isTravel = CURRENT_STATS_DATA.type === 'æ—…éŠ';
            let text = `ã€${info.title}ã€‘\nğŸ‘¤ ä¸»è¾¦ï¼š${info.host}\nğŸ“… æ™‚é–“ï¼š${$('evTime').innerText}\nğŸ“ åœ°é»ï¼š${info.store}\n------------------\n`;
            CURRENT_STATS_DATA.users.forEach((u, i) => {
                let detail = isTravel ? `${u.pickup} / ${u.room || 'æœªé¸æˆ¿'}` : `${u.table || 0}æ¡Œ`;
                text += `${i + 1}. ${u.userName} (${u.people}äºº) [${detail}]\n`;
            });
            const totalPeople = CURRENT_STATS_DATA.users.reduce((s, u) => s + (parseInt(u.people) || 0), 0);
            text += `------------------\nğŸ“Š ç¸½è¨ˆï¼š${totalPeople} äºº\n`;
            const sStatsEl = $('sStats');
            if (sStatsEl) {
                let sText = sStatsEl.innerText.replace('ğŸ è´ŠåŠ©å½™æ•´ï¼š', '').trim();
                if (sText && sText !== 'æš«ç„¡è´ŠåŠ©') {
                    text += `ğŸ è´ŠåŠ©å½™æ•´ï¼š\n${sText}\n`;
                }
            }
            text += `ğŸ”— å ±åï¼šhttps://liff.line.me/${LIFF_ID}`;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                alert("âœ… å ±ååå–®å·²è¤‡è£½ï¼");
            } catch (err) {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—");
            }
            document.body.removeChild(el);
        }

        function openOfficialSite() {
            const sel = $('eventSelect').selectedOptions[0];
            if (!sel) return;
            const o = sel.dataset;
            if (o.officialsite && o.officialsite !== "undefined" && o.officialsite.trim() !== "") window.open(o.officialsite, '_blank');
            else alert("æ­¤åœ°é»æš«ç„¡å®˜ç¶²è³‡æ–™");
        }

        function openGoogleMap() {
            const sel = $('eventSelect').selectedOptions[0];
            if (!sel) return;
            const o = sel.dataset;
            // Standard Universal Link
            const query = encodeURIComponent(`${o.store} ${o.address}`);
            window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
        }

        function formatOnlyDate(val) {
            if (!val || val === 'undefined') return '';
            const d = new Date(val);
            if (isNaN(d.getTime())) return val;
            return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDateTime(val) {
            if (!val || val === 'undefined') return '';
            let d = new Date(val);
            if (isNaN(d.getTime())) return val;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const date = String(d.getDate()).padStart(2, '0');
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const dayName = `(${days[d.getDay()]})`;
            let timePart = (typeof val === 'string' && val.includes(' ')) ? val.split(' ')[1].substring(0, 5) : String(d.getHours()).padStart(2, '0') + ":" + String(d.getMinutes()).padStart(2, '0');
            return `${y}/${m}/${date} ${dayName} ${timePart}`;
        }

        function toggleItinerary() {
            const c = $('itineraryContent');
            c.style.display = c.style.display === 'block' ? 'none' : 'block';
            $('arrow').innerText = c.style.display === 'block' ? 'ï¼' : 'ï¼‹';
        }

        function toggleDay(el) {
            const c = el.nextElementSibling;
            c.style.display = c.style.display === 'block' ? 'none' : 'block';
            el.querySelector('.day-arrow').innerText = c.style.display === 'block' ? 'ï¼' : 'ï¼‹';
        }

        async function callApi(action, extra = '') {
            try {
                const r = await fetch(`${GAS_URL}?action=${action}${extra}&ts=${Date.now()}`);
                return await r.json();
            } catch (e) {
                return [];
            }
        }

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) liff.login();
                const p = await liff.getProfile();
                $('userName').value = $('userNameShow').value = p.displayName;
                $('userId').value = p.userId;
                const res = await callApi('getInitData');
                masterOptions = res.options;
                masterOptions.itinerary = res.itinerary;
                const sel = $('eventSelect');
                sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
                res.events.forEach(ev => {
                    if (!ev.eventId) return;
                    const joined = res.registrations.some(j => String(j.eventId) === String(ev.eventId) && String(j.userId) === String(p.userId));
                    const opt = new Option(`${joined ? 'ã€âœ… å·²å ±åã€‘ ' : ''}${ev.title}`, ev.eventId);
                    Object.assign(opt.dataset, {
                        joined, eventid: ev.eventId, type: ev.type, title: ev.title, host: ev.host, time: ev.time,
                        startdate: ev.startDate, enddate: ev.endDate, store: ev.store, address: ev.address, officialsite: ev.officialSite
                    });
                    sel.add(opt);
                });
                renderEventCards();
            } catch (err) {
                console.error(err);
            }
        }

        function renderEventCards() {
            const grid = $('eventGrid');
            const sel = $('eventSelect');
            grid.innerHTML = '';
            Array.from(sel.options).forEach((opt, idx) => {
                if (idx === 0) return;
                const d = opt.dataset;
                const card = document.createElement('div');
                card.className = 'event-card';
                if (d.joined === 'true') card.innerHTML += '<span class="badge">å·²å ±å</span>';
                card.innerHTML += `<div class="type-tag">${d.type}</div><div class="title">${d.title}</div>`;
                
                // --- é»æ“Šåˆ‡æ›é‚è¼¯ (Click Toggle Logic) ---
                card.onclick = () => {
                    if (card.classList.contains('selected')) {
                        // å¦‚æœå·²ç¶“é¸ä¸­ -> æ”¶ç¸® (Collapse)
                        card.classList.remove('selected');
                        sel.value = ""; // é‡ç½® select
                        
                        // éš±è—æ‰€æœ‰è³‡è¨Šå€å¡Š
                        $('regForm').style.display = 'none';
                        $('eventInfo').style.display = 'none';
                        $('stats').style.display = 'none';
                        $('sponsorContainer').innerHTML = '';
                        $('guestContainer').innerHTML = '';
                        $('itineraryContent').innerHTML = '';
                        
                    } else {
                        // å¦‚æœæœªé¸ä¸­ -> å±•é–‹ (Expand)
                        document.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        sel.value = opt.value;
                        sel.dispatchEvent(new Event('change'));
                    }
                };
                // ------------------------------------------------

                grid.appendChild(card);
            });
        }

        $('eventSelect').onchange = async () => {
            const sel = $('eventSelect');
            const o = sel.selectedOptions[0];
            if (!o || !o.value) return;
            $('regForm').style.display = 'none';
            $('eventInfo').style.display = 'none';
            $('stats').style.display = 'none';
            $('pickupMapLink').style.display = 'none';
            $('sponsorContainer').innerHTML = '';
            $('guestContainer').innerHTML = '';
            $('itineraryContent').innerHTML = '';
            $('arrow').innerText = 'ï¼‹';

            const d = o.dataset;
            const isW = (d.type === 'å°¾ç‰™' || d.type === 'èšæœƒ' || d.type === 'é¤æœƒ');
            const isTravel = (d.type === 'æ—…éŠ');

            $('addGuestBtn').style.display = isTravel ? 'block' : 'none';
            $('evTitle').innerText = d.title;
            $('evHost').innerText = d.host;
            $('evStore').innerText = d.store;
            $('evAddress').innerText = d.address;
            CURRENT_STATS_DATA.eventInfo = { title: d.title, host: d.host, store: d.store };
            CURRENT_STATS_DATA.type = d.type;

            const curStats = await callApi('queryStats', `&eventId=${o.value}`);
            const users = curStats.users || [];
            const joined = (d.joined === 'true');

            $('subBtn').innerText = joined ? 'ç·¨è¼¯å ±å' : 'é€å‡ºå ±å';
            $('subBtn').disabled = false;
            $('cancelBtn').style.display = joined ? 'block' : 'none';

            const fill = (id, list) => {
                const target = $(id);
                target.innerHTML = '';
                list.forEach(x => target.add(new Option(x, x)));
            };
            fill('people', masterOptions.people);

            if (isW) {
                $('evTime').innerText = formatDateTime(d.time) || "æ™‚é–“æœªå®š";
                $('weiyaFields').style.display = 'block';
                $('travelFields').style.display = 'none';
                $('itineraryBox').style.display = 'none';
                fill('table', masterOptions.table);
            } else {
                const sDate = formatOnlyDate(d.startdate);
                const eDate = formatOnlyDate(d.enddate);
                $('evTime').innerText = (sDate && eDate) ? `${sDate} ~ ${eDate}` : "æ™‚é–“æœªå®š";
                $('travelFields').style.display = 'block';
                $('weiyaFields').style.display = 'none';
                const pSel = $('pickup');
                pSel.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸Šè»Šé» --</option>';
                masterOptions.pickup.forEach(i => {
                    const opt = new Option(i.name, i.name);
                    opt.dataset.mapurl = i.info;
                    pSel.add(opt);
                });
                const rSel = $('room');
                rSel.innerHTML = '<option value="">-- è«‹é¸æ“‡æˆ¿å‹ --</option>';
                rSel.add(new Option("æˆ‘è¦ä½µæˆ¿ (è²»ç”¨å¦è¨ˆ)", "æˆ‘è¦ä½µæˆ¿"));
                masterOptions.room.forEach(i => {
                    const used = users.reduce((acc, u) => (u.room && u.room.startsWith(i.name)) ? acc + 1 : acc, 0);
                    const rem = (parseInt(i.totalCount) || 0) - used;
                    const label = rem > 0 ? `${i.name} / ${i.price}å…ƒ / å‰©${rem}é–“` : `${i.name} (å·²æ»¿ï¼Œå¾…è¦åŠƒ)`;
                    rSel.add(new Option(label, i.name));
                });
                renderItinerary();
            }

            if ($('sponsorContainer').children.length === 0) {
                createSponsorRow();
            }
            $('regForm').style.display = $('eventInfo').style.display = 'block';
            renderStatsView(curStats, d.type);
        };

        $('addGuestBtn').onclick = () => {
            const guestInputs = document.querySelectorAll('.g-name');
            for (let input of guestInputs) {
                if (input.value.trim() === "") {
                    alert("è«‹å…ˆå¡«å¯«å®Œç›®å‰ä¾†è³“çš„å§“åï¼Œå†æ–°å¢ä¸‹ä¸€ä½ï¼");
                    input.focus();
                    return;
                }
            }
            const gid = 'guest_' + Date.now();
            const isTravel = $('travelFields').style.display === 'block';
            const div = document.createElement('div');
            div.className = 'guest-card';
            div.id = gid;
            div.innerHTML = `
            <div class="guest-header" onclick="toggleGuest('${gid}')">
              <span>ğŸ‘¤ ä¾†è³“ï¼š<span class="g-name-lbl">æ–°ä¾†è³“</span></span>
              <div>
                <span class="guest-del" onclick="removeGuest('${gid}', event)">åˆªé™¤</span>
                <span class="g-arrow">ï¼</span>
              </div>
            </div>
            <div class="guest-body">
              <label>ä¾†è³“å§“åï¼š</label>
              <input type="text" class="g-name" placeholder="è«‹è¼¸å…¥å§“å" oninput="updateGuestName(this)">
              <label>åƒåŠ äººæ•¸ï¼š</label>
              <select class="g-people">${$('people').innerHTML}</select>
              <div class="g-travel-only" style="display:${isTravel ? 'block' : 'none'}">
                <label>ä¸Šè»Šåœ°é»ï¼š</label><select class="g-pickup">${$('pickup').innerHTML}</select>
                <label>æˆ¿å‹é¸æ“‡ï¼š</label><select class="g-room">${$('room').innerHTML}</select>
              </div>
            </div>`;
            $('guestContainer').appendChild(div);
        };

        function updateGuestName(input) {
            input.closest('.guest-card').querySelector('.g-name-lbl').innerText = escapeHtml(input.value) || "æ–°ä¾†è³“";
        }

        function toggleGuest(id) {
            const card = $(id);
            const body = card.querySelector('.guest-body');
            const arrow = card.querySelector('.g-arrow');
            const isHidden = body.style.display === 'none';
            body.style.display = isHidden ? 'block' : 'none';
            arrow.innerText = isHidden ? 'ï¼' : 'ï¼‹';
        }

        function removeGuest(id, e) {
            e.stopPropagation();
            if (confirm("ç¢ºå®šè¦ç§»é™¤é€™ä½ä¾†è³“å—ï¼Ÿ")) $(id).remove();
        }

        function updatePickupMap() {
            const opt = $('pickup').selectedOptions[0];
            if (opt && opt.value && opt.dataset.mapurl) {
                $('locLabel').innerText = opt.value;
                $('pickupMapLink').style.display = 'block';
            } else {
                $('pickupMapLink').style.display = 'none';
            }
        }

        function openPickupMap() {
            const url = $('pickup').selectedOptions[0].dataset.mapurl;
            if (url) window.open(url, '_blank');
        }

        function renderStatsView(data, type) {
            const users = data.users || [];
            CURRENT_STATS_DATA.users = users;
            const totalPeople = users.reduce((s, u) => s + (parseInt(u.people) || 0), 0);
            $('uStats').innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong style="color:var(--primary); font-size:1.1rem;">ğŸ‘¤ ç¸½å ±åï¼š${totalPeople} äºº</strong>
                <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½åå–®</button>
            </div>`;
            let uHtml = `<hr><strong>ğŸ“ å ±ååå–®ï¼š</strong>`;
            users.forEach(u => {
                let detail = type === 'æ—…éŠ' ? `${u.pickup} / ${u.room || 'æœªé¸æˆ¿'}` : `${u.table || 0}æ¡Œ`;
                uHtml += `<div class="user-list-item">${escapeHtml(u.userName)} (${u.people}äºº) [${detail}]</div>`;
            });
            $('uDetail').innerHTML = uHtml;
            let spHtml = `<hr><strong>ğŸ è´ŠåŠ©å½™æ•´ï¼š</strong><br>`;
            if (data.sponsor && Object.keys(data.sponsor).length > 0) {
                for (let k in data.sponsor) spHtml += `â€¢ ${escapeHtml(k)}: ${escapeHtml(data.sponsor[k])}<br>`;
            } else {
                spHtml += 'æš«ç„¡è´ŠåŠ©';
            }
            $('sStats').innerHTML = spHtml;
            $('stats').style.display = 'block';
        }

        function renderItinerary() {
            const list = masterOptions.itinerary;
            if (!list || list.length === 0) {
                $('itineraryBox').style.display = 'none';
                return;
            }
            const container = $('itineraryContent');
            container.innerHTML = '';
            const days = [...new Set(list.map(i => i.day))].sort((a, b) => a - b);
            days.forEach((day, idx) => {
                const div = document.createElement('div');
                div.className = 'day-section';
                div.innerHTML = `<div class="day-toggle" onclick="toggleDay(this)"><span>ç¬¬ ${day} å¤©</span><span class="day-arrow">${idx === 0 ? 'ï¼' : 'ï¼‹'}</span></div>
                <div class="day-content" style="display: ${idx === 0 ? 'block' : 'none'}"><table class="itinerary-table">
                ${list.filter(i => i.day == day).map(i => `<tr><td>${i.startTime}</td><td>${i.startLoc}</td><td>${i.endTime}</td><td>${i.endLoc}</td></tr>`).join('')}
                </table></div>`;
                container.appendChild(div);
            });
            $('itineraryBox').style.display = 'block';
        }

        $('addSponsorBtn').onclick = createSponsorRow;

        function createSponsorRow() {
            const rowId = 'spRow_' + Date.now();
            const div = document.createElement('div');
            div.className = 'sponsor-item';
            div.id = rowId;
            div.innerHTML = `<div class="sponsor-header"><span>è´ŠåŠ©é …ç›®</span><button type="button" class="remove-btn" onclick="removeRow('${rowId}')">âœ•</button></div>
            <select class="sponsor-select" onchange="handleSponsorChange('${rowId}')"></select>
            <div class="qtyGrp" style="display:none; margin-top:8px;">
              <select class="qtySelect" onchange="handleQtyChange('${rowId}')" style="display:none;"></select>
              <input type="text" class="otherInput" placeholder="è«‹è‡ªå¡«é …ç›®" style="display:none;">
              <div class="custom-qty-grp" style="display:none;"><input type="number" class="cQty" value="5" onchange="validateCustomQty('${rowId}')">
              <select class="cUnit" onchange="validateCustomQty('${rowId}')"><option value="ç“¶">ç“¶</option><option value="ç®±">ç®±</option></select></div>
              <div class="moneyGrp" style="display:none;"><input type="number" class="mVal" value="500"> <span>å…ƒ</span></div>
            </div>`;
            $('sponsorContainer').appendChild(div);
            const sel = div.querySelector('.sponsor-select');
            sel.add(new Option("-- è«‹é¸æ“‡ --", ""));
            sel.add(new Option("ç„¡", "ç„¡"));
            masterOptions.sponsor.filter(s => s !== "ç„¡").forEach(s => sel.add(new Option(s, s)));
        }

        function handleSponsorChange(id) {
            const r = $(id), v = r.querySelector('.sponsor-select').value, qG = r.querySelector('.qtyGrp'), qS = r.querySelector('.qtySelect'), oI = r.querySelector('.otherInput'), mG = r.querySelector('.moneyGrp');
            qG.style.display = (v && v !== 'ç„¡') ? 'block' : 'none';
            qS.style.display = oI.style.display = mG.style.display = 'none';
            if (v === 'å…¶ä»–') oI.style.display = 'block';
            else if (v === 'ç´…åŒ…') mG.style.display = 'flex';
            else if (v && v !== 'ç„¡') {
                qS.style.display = 'block';
                qS.innerHTML = '';
                let its = v.includes('é…’') ? ['1ç“¶', '2ç“¶', '3ç“¶', '4ç“¶', '5ç“¶', '1ç®±(6ç“¶)', '2ç®±(12ç“¶)', 'è‡ªå®šç¾©æ•¸é‡'] : masterOptions.sponsorQty;
                its.forEach(q => qS.add(new Option(q, q)));
            }
            checkSponsorAddButton();
        }

        function handleQtyChange(id) {
            $(id).querySelector('.custom-qty-grp').style.display = ($(id).querySelector('.qtySelect').value === 'è‡ªå®šç¾©æ•¸é‡') ? 'flex' : 'none';
        }

        function validateCustomQty(id) {
            const r = $(id), u = r.querySelector('.cUnit').value, i = r.querySelector('.cQty');
            if (u === 'ç“¶' && i.value < 6) i.value = 6;
            if (u === 'ç®±' && i.value < 3) i.value = 3;
        }

        function removeRow(id) {
            $(id).remove();
            checkSponsorAddButton();
            if ($('sponsorContainer').children.length === 0) createSponsorRow();
        }

        function checkSponsorAddButton() {
            const s = document.querySelectorAll('.sponsor-select');
            $('addSponsorBtn').style.display = (s[s.length - 1]?.value && s[s.length - 1]?.value !== 'ç„¡') ? 'block' : 'none';
        }

        $('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const o = $('eventSelect').selectedOptions[0].dataset;
            if (o.type === 'æ—…éŠ') {
                if (!$('pickup').value) return alert("è«‹é¸æ“‡æœ¬äººçš„ä¸Šè»Šåœ°é»");
                if (!$('room').value) return alert("è«‹é¸æ“‡æœ¬äººçš„æˆ¿å‹");
            }
            const sponsorList = [];
            document.querySelectorAll('.sponsor-item').forEach(r => {
                const n = r.querySelector('.sponsor-select').value;
                if (!n || n === 'ç„¡') return;
                if (n === 'å…¶ä»–') {
                    const val = r.querySelector('.otherInput').value;
                    if (val) sponsorList.push(val);
                } else if (n === 'ç´…åŒ…') {
                    sponsorList.push(`ç´…åŒ…(${r.querySelector('.mVal').value}å…ƒ)`);
                } else {
                    const q = r.querySelector('.qtySelect').value;
                    sponsorList.push(q === 'è‡ªå®šç¾©æ•¸é‡' ? `${n}(${r.querySelector('.cQty').value}${r.querySelector('.cUnit').value})` : `${n}(${q})`);
                }
            });
            const queue = [];
            queue.push({
                eventId: o.eventid, eventType: o.type, userId: $('userId').value, userName: $('userName').value,
                people: $('people').value, table: (o.type === 'å°¾ç‰™' || o.type === 'èšæœƒ' || o.type === 'é¤æœƒ') ? $('table').value : '',
                pickup: o.type === 'æ—…éŠ' ? $('pickup').value : '', room: o.type === 'æ—…éŠ' ? ($('room').value === 'æˆ‘è¦ä½µæˆ¿' ? 'æˆ‘è¦ä½µæˆ¿' : `${$('room').value} (1é–“)`) : '',
                sponsor: sponsorList.join(', ') || 'ç„¡', memo: $('memo').value
            });
            document.querySelectorAll('.guest-card').forEach((c, index) => {
                const gName = c.querySelector('.g-name').value;
                const gRoom = c.querySelector('.g-room').value;
                if (!gName) return;
                queue.push({
                    eventId: o.eventid, eventType: o.type, userId: $('userId').value + "_guest_" + index, userName: gName + " (ä¾†è³“)",
                    people: c.querySelector('.g-people').value, table: (o.type === 'å°¾ç‰™' || o.type === 'èšæœƒ' || o.type === 'é¤æœƒ') ? $('table').value : '',
                    pickup: o.type === 'æ—…éŠ' ? c.querySelector('.g-pickup').value : '', room: o.type === 'æ—…éŠ' ? (gRoom === 'æˆ‘è¦ä½µæˆ¿' ? 'æˆ‘è¦ä½µæˆ¿' : `${gRoom} (1é–“)`) : '',
                    sponsor: "ç„¡", memo: `ç”± ${$('userName').value} ä»£å ±å`
                });
            });

            $('subBtn').disabled = true;
            $('subBtn').innerText = "æº–å‚™é€å‡º...";
            try {
                let successCount = 0;
                // Loop with Progress Indicator
                for (let i = 0; i < queue.length; i++) {
                    $('subBtn').innerText = `æ­£åœ¨è™•ç†ç¬¬ ${i + 1} / ${queue.length} ç­†...`;
                    const r = await callApi('modify', `&payload=${encodeURIComponent(JSON.stringify(queue[i]))}`);
                    if (r.status === "success") successCount++;
                }
                alert(`æˆåŠŸè™•ç† ${successCount} ä½å ±åç´€éŒ„ï¼`);
                location.reload();
            } catch (err) {
                alert("éƒ¨åˆ†æˆ–å…¨éƒ¨å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                $('subBtn').disabled = false;
                $('subBtn').innerText = "é€å‡ºå ±å";
            }
        };

        $('cancelBtn').onclick = async () => {
            if (!confirm("è­¦å‘Šï¼šå–æ¶ˆå ±åå°‡æœƒä¸€ä½µç§»é™¤æ‚¨åä¸‹çš„æ‰€æœ‰ä¾†è³“ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            const o = $('eventSelect').selectedOptions[0].dataset;
            $('cancelBtn').disabled = true;
            $('cancelBtn').innerText = "è™•ç†ä¸­...";
            try {
                const r = await callApi('cancel', `&payload=${encodeURIComponent(JSON.stringify({ eventId: o.eventid, userId: $('userId').value }))}`);
                alert(r.message);
                location.reload();
            } catch (err) {
                alert("å–æ¶ˆå¤±æ•—");
                $('cancelBtn').disabled = false;
            }
        };
        window.onload = init;
    </script>
</body>

</html>
