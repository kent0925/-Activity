<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>æ´»å‹•å ±åè¡¨å–® - LIFF/GitHub</title>
<script src="https://static.line-scdn.net/liff/2.23.1/sdk.js"></script>
<style>
  /* é€™è£¡æ”¾ç½®ä½ çš„ CSS æ¨£å¼ */
  body { font-family: sans-serif; padding: 15px; background-color: #f0f0f0; }
  .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  .hidden { display: none; }
  /* [ç°¡åŒ–æ¨£å¼] */
  input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; margin: 6px 0 12px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  button { padding: 10px 15px; margin-right: 10px; cursor: pointer; background-color: #00B900; color: white; border: none; border-radius: 4px; }
  button[type="submit"] { width: 100%; background-color: #00B900; }
</style>
</head>
<body>

<div class="container">
  <div id="loading-message">é€£ç·šä¸­... è«‹ç¨å€™ã€‚</div>

  <div id="event-selection" class="hidden">
    <div class="header">
      <h2>æ´»å‹•å ±å</h2>
      <p id="user-info"></p>
    </div>
    <div id="dinner-list" class="form-section"><h3>ğŸ½ï¸ å°¾ç‰™æ´»å‹•</h3><div id="dinner-events"></div></div>
    <div id="trip-list" class="form-section"><h3>âœˆï¸ æ—…éŠæ´»å‹•</h3><div id="trip-events"></div></div>
  </div>

  <div id="form-container" class="hidden form-section">
    <h3 id="form-title"></h3>
    <form id="submission-form">
      <h4>å ±åè³‡è¨Š</h4>
      <label for="personCount">åƒåŠ äººæ•¸:</label><select id="personCount" name="personCount" required></select><br>
      <div id="dynamic-fields"></div>
      <hr>
      <h4>è´ŠåŠ©é …ç›® (å¯é¸å¡«)</h4>
      <label for="sponsorItem">è´ŠåŠ©é …ç›®:</label><select id="sponsorItem" name="sponsorItem"></select><br>
      <div id="sponsor-other-group" class="hidden">
        <label for="sponsorOtherName">è´ŠåŠ©é …ç›®åç¨± (å…¶ä»–):</label><input type="text" id="sponsorOtherName" name="sponsorOtherName">
      </div>
      <label for="sponsorCount">è´ŠåŠ©æ•¸é‡ (0-50):</label><input type="number" id="sponsorCount" name="sponsorCount" min="0" max="50" value="0" required><br>
      <hr>
      <h4>å‚™è¨»</h4>
      <label for="note">å‚™è¨»:</label><textarea id="note" name="note" rows="3"></textarea><br>

      <button type="submit">æäº¤å ±å</button>
      <button type="button" onclick="showEventSelection()" style="background-color: #ccc;">è¿”å›é¸æ“‡</button>
    </form>
  </div>
</div>

<script>
  // --- *** è«‹æ›¿æ›ä»¥ä¸‹å…©å€‹è®Šæ•¸ *** ---
  const LIFF_ID = '2008678090-TpSkCDSZ';
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyJuAodySUQ0jUh0mNEvSv4D5J2Bi8GB7tp480BxHGyVOx-QeKiPJg7-KktBDtmKsf9/exec';
  // ------------------------------------

  let lineUserID = '';
  let lineNickname = 'æœªçŸ¥ä½¿ç”¨è€…';
  let currentEventID = '';
  let currentActivityType = '';

  // --- 1. LIFF åˆå§‹åŒ–èˆ‡ç™»å…¥ ---

  window.onload = function() {
    liff.init({ liffId: LIFF_ID })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
        } else {
          initializeLiff();
        }
      })
      .catch((err) => {
        document.getElementById('loading-message').textContent = 'LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID: ' + err.message;
      });
  };

  function initializeLiff() {
    liff.getProfile()
      .then(profile => {
        lineUserID = profile.userId;
        lineNickname = profile.displayName;
        document.getElementById('user-info').textContent = `æ‚¨å¥½ï¼Œ${lineNickname}ï¼`;
        loadAvailableEvents();
      })
      .catch(() => {
        document.getElementById('loading-message').textContent = 'ç„¡æ³•å–å¾— LINE Profileï¼Œè«‹æª¢æŸ¥ LIFF æ¬Šé™è¨­å®šã€‚';
      });
  }

  // --- 2. è¼‰å…¥æ´»å‹•åˆ—è¡¨ (GET /?action=getEvents) ---

  async function loadAvailableEvents() {
    document.getElementById('loading-message').classList.add('hidden');
    document.getElementById('event-selection').classList.remove('hidden');

    try {
      const response = await fetch(`${GAS_API_URL}?action=getEvents`);
      const data = await response.json();
      renderEventList(data.dinner, 'dinner-events', 'Dinner');
      renderEventList(data.trip, 'trip-events', 'Trip');
    } catch (e) {
      document.getElementById('loading-message').textContent = 'è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS API: ' + e.message;
      document.getElementById('loading-message').classList.remove('hidden');
    }
  }

  function renderEventList(events, elementId, type) {
    const container = document.getElementById(elementId);
    container.innerHTML = ''; 
    if (events.length === 0) { container.textContent = 'ç›®å‰æ²’æœ‰é–‹æ”¾çš„æ´»å‹•ã€‚'; return; }
    
    events.forEach(event => {
      const eventDiv = document.createElement('div');
      eventDiv.innerHTML = `
        <h4>${event.title} (${event.eventId})</h4>
        <p>åœ°é»: ${event.venueName}</p>
        <button onclick="showForm('${event.eventId}', '${type}')">ç«‹å³å ±å</button>
        <a href="${generateMapUri(event.venueAddress)}" target="_blank"><button style="background-color: #888;">ğŸŒ åœ°åœ–</button></a>
        <hr>
      `;
      container.appendChild(eventDiv);
    });
  }
  
  function generateMapUri(address) {
    const encodedAddress = encodeURIComponent(address);
    return `https://www.google.com/maps/search/?api=1&query=$${encodedAddress}`;
  }


  // --- 3. é¡¯ç¤ºè¡¨å–®èˆ‡å¡«å……é¸é … (GET /?action=getSettings) ---
  
  async function showForm(eventId, activityType) {
    currentEventID = eventId;
    currentActivityType = activityType;
    document.getElementById('event-selection').classList.add('hidden');
    document.getElementById('form-container').classList.remove('hidden');
    document.getElementById('loading-message').textContent = 'æ­£åœ¨è¼‰å…¥è¡¨å–®ç´°ç¯€...';
    document.getElementById('loading-message').classList.remove('hidden');
    
    try {
      const response = await fetch(`${GAS_API_URL}?action=getSettings&eventID=${eventId}`);
      const settings = await response.json();
      
      document.getElementById('loading-message').classList.add('hidden');
      
      document.getElementById('form-title').textContent = settings.title;
      
      // å¡«å……é¸é …
      populateOptions('personCount', settings.personOptions);
      populateDynamicFields(settings, activityType);
      
      const sponsorOpts = settings.sponsorOptions && settings.sponsorOptions.length > 0 ? settings.sponsorOptions : ['ç„¡'];
      populateOptions('sponsorItem', sponsorOpts);
      
      document.getElementById('note').placeholder = settings.defaultNote || 'ç„¡';
      
      // è´ŠåŠ©é …ç›®ã€Œå…¶ä»–ã€çš„é‚è¼¯
      const sponsorSelect = document.getElementById('sponsorItem');
      const sponsorOtherInput = document.getElementById('sponsorOtherName');
      const sponsorOtherGroup = document.getElementById('sponsor-other-group');

      sponsorSelect.onchange = function() {
        if (this.value === 'å…¶ä»–') {
          sponsorOtherGroup.classList.remove('hidden');
          sponsorOtherInput.setAttribute('required', 'required');
        } else {
          sponsorOtherGroup.classList.add('hidden');
          sponsorOtherInput.removeAttribute('required');
          sponsorOtherInput.value = '';
        }
      };
      // ç¢ºä¿åˆå§‹ç‹€æ…‹æ­£ç¢º
      sponsorSelect.dispatchEvent(new Event('change'));
      
    } catch (e) {
      document.getElementById('loading-message').textContent = 'è¼‰å…¥è¡¨å–®ç´°ç¯€å¤±æ•—ï¼š' + e.message;
      document.getElementById('loading-message').classList.remove('hidden');
    }
  }
  
  function populateOptions(elementId, options) {
    const select = document.getElementById(elementId);
    select.innerHTML = '';
    options.forEach(opt => {
      const optionElement = document.createElement('option');
      optionElement.value = opt;
      optionElement.textContent = opt;
      select.appendChild(optionElement);
    });
  }
  
  function populateDynamicFields(settings, activityType) {
    const container = document.getElementById('dynamic-fields');
    container.innerHTML = '';

    if (activityType === 'Dinner') {
      container.innerHTML += `<label for="deskCount">èªæ¡Œæ•¸é‡:</label><select id="deskCount" name="deskCount" required></select><br>`;
      populateOptions('deskCount', settings.deskOptions);
    } else if (activityType === 'Trip') {
      container.innerHTML += `<label for="busLocation">ä¸Šè»Šåœ°é»:</label><select id="busLocation" name="busLocation" required></select><br>
        <label for="roomType">æˆ¿å‹é¸æ“‡:</label><select id="roomType" name="roomType" required></select><br>`;
      populateOptions('busLocation', settings.busOptions);
      populateOptions('roomType', settings.roomOptions);
    }
  }
  
  function showEventSelection() {
    document.getElementById('form-container').classList.add('hidden');
    document.getElementById('event-selection').classList.remove('hidden');
    document.getElementById('submission-form').reset();
  }


  // --- 4. æäº¤è¡¨å–® (POST GAS_API_URL) ---

  document.getElementById('submission-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    document.getElementById('loading-message').textContent = 'è³‡æ–™æäº¤ä¸­ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...';
    document.getElementById('loading-message').classList.remove('hidden');
    document.getElementById('form-container').classList.add('hidden');
    
    const form = e.target;
    const formData = {};
    new FormData(form).forEach((value, key) => { formData[key] = value; });

    const submissionData = {
      lineID: lineUserID,
      nickname: lineNickname,
      eventID: currentEventID,
      activityType: currentActivityType,
      formData: formData
    };

    try {
      const response = await fetch(GAS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(submissionData)
      });
      
      const result = await response.json();

      if (result.success) {
        const successTitle = document.getElementById('form-title').textContent;
        liff.sendMessages([{
          type: 'text',
          text: `âœ…ã€${successTitle}ã€‘å ±åæˆåŠŸï¼\nè³‡æ–™å·²é€å‡ºã€‚\n(Event ID: ${currentEventID})`
        }]).then(() => {
          liff.closeWindow(); 
        }).catch(() => {
           // å³ä½¿ç™¼é€å¤±æ•—ï¼Œä¹Ÿé¡¯ç¤ºæˆåŠŸè¨Šæ¯
           document.getElementById('loading-message').textContent = `âœ… å ±åæˆåŠŸï¼ä½†è‡ªå‹•å‚³é€ç¢ºèªè¨Šæ¯å¤±æ•—ã€‚`;
        });

      } else {
        document.getElementById('loading-message').textContent = `å ±åå¤±æ•—: ${result.message}`;
        document.getElementById('form-container').classList.remove('hidden');
      }
    } catch (error) {
      document.getElementById('loading-message').textContent = 'æäº¤æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤: ' + error.message;
      document.getElementById('form-container').classList.remove('hidden');
    }
  });
</script>

</body>
</html>
