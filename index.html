<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin:15px; background:#f0f2f5; color: #333; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { text-align:center; color: #1a73e8; margin-bottom: 20px; }
  label { display:block; margin-top:12px; font-weight: bold; color: #555; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  .btn-group { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; margin-top: 25px; }
  button { padding:12px; width:48%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-weight: bold; transition: 0.3s; }
  button.cancel-reg { background:#f44336; width: 100%; margin-top: 10px; }
  button.reset { background:#9e9e9e; }
  #eventInfo, #stats { margin-top:15px; padding:15px; border-radius:8px; display:none; }
  #eventInfo { background:#e8f0fe; border-left: 5px solid #1a73e8; }
  #stats { background:#f8f9fa; border-left: 5px solid #4CAF50; }
  .sponsor-item { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
  .sponsor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .remove-btn { background: none; color: #ff4d4d; border: none; cursor: pointer; font-size: 18px; font-weight: bold; }
  .add-sponsor-btn { background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 14px; width: 100%; font-weight: bold; display:none; }
  .qty-flex { display: flex; gap: 8px; margin-top: 8px; align-items: center; }
  .user-list-item { font-size: 13px; color: #666; padding-left: 10px; border-left: 2px solid #ddd; margin: 4px 0; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</h2>
  <label>é¸æ“‡æ´»å‹•ï¼š<select id="eventSelect" required><option value="">è¼‰å…¥æ´»å‹•ä¸­...</option></select></label>

  <div id="eventInfo">
    <h3 id="evTitle" style="margin:0 0 8px 0; color:#1a73e8;"></h3>
    <p>ğŸ‘¤ ä¸»è¾¦äººï¼š<span id="evHost"></span></p>
    <p>ğŸ“… æ™‚é–“ï¼š<span id="evTime"></span></p>
    <p>ğŸ“ åœ°é»ï¼š<span id="evStore"></span></p>
    <p>ğŸ  åœ°å€ï¼š<span id="evAddress"></span></p>
    <button type="button" id="mapBtn" style="width:100%; background:#4285F4; color:white; border:none; padding:8px; border-radius:5px; margin-top:10px; cursor:pointer;">ğŸ“ é–‹å•Ÿ Google åœ°åœ–</button>
  </div>

  <form id="regForm" style="display:none;">
    <input type="hidden" id="userId">
    <label>å ±åè€…å§“åï¼š<input type="text" id="userName" readonly></label>
    <label>åƒåŠ äººæ•¸ï¼š<select id="people" required></select></label>
    
    <div id="weiyaFields" style="display:none;"><label>èªæ¡Œæ•¸é‡ï¼š<select id="table"></select></label></div>
    <div id="travelFields" style="display:none;">
      <label>ä¸Šè»Šåœ°é»ï¼š<select id="pickup"></select></label>
      <label>æˆ¿å‹é¸æ“‡ï¼š<select id="room"></select></label>
    </div>
    
    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
    <label>ğŸ è´ŠåŠ©é …ç›®ç®¡ç†ï¼š</label>
    <div id="sponsorContainer"></div>
    <button type="button" class="add-sponsor-btn" id="addSponsorBtn">â• æ–°å¢è´ŠåŠ©é …ç›®</button>
    
    <label style="margin-top:20px;">å‚™è¨»ï¼š<textarea id="memo" rows="2" placeholder="ç‰¹æ®Šé£Ÿæ€§æˆ–å‚™è¨»"></textarea></label>
    
    <div class="btn-group">
      <button type="submit" id="subBtn">é€å‡ºæ›´æ–°</button>
      <button type="button" class="reset" onclick="location.reload()">é‡ç½®é¸å–®</button>
      <button type="button" id="cancelRegBtn" class="cancel-reg" style="display:none;">âŒ å–æ¶ˆå ±å (ç§»é™¤æˆ‘çš„è³‡æ–™)</button>
    </div>
  </form>

  <div id="stats">
    <div id="uStats"></div>
    <div id="uDetail" style="margin-bottom:15px;"></div>
    <div id="sStats"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);

let masterOptions = { sponsor: [], sponsorQty: [], people: [], table: [], pickup: [], room: [] };

// API å·¥å…·
async function callApi(action, extra = '') {
  try {
    const r = await fetch(`${GAS_URL}?action=${action}${extra}`);
    return await r.json();
  } catch (e) { return {status: "error", message: "é€£ç·šå¤±æ•—"}; }
}

// åˆå§‹åŒ–
async function init(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  $('userName').value = p.displayName; $('userId').value = p.userId;
  
  const keys = ['sponsor','sponsorQty','people','table','pickup','room'];
  const res = await Promise.all([...keys.map(k => callApi('getOptions', `&type=${k}`)), callApi('getEvents'), callApi('queryStats', '&all=true')]);
  keys.forEach((k, i) => masterOptions[k] = res[i]);
  
  $('eventSelect').innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
  res[6].forEach(ev => {
    const joined = res[7].some(j => String(j.eventId) === String(ev.eventId) && String(j.userId) === String(p.userId));
    const opt = new Option(`${ev.title} (${ev.type})${joined ? ' (å·²å ±å)' : ''}`, ev.eventId);
    opt.dataset.joined = joined;
    Object.keys(ev).forEach(k => opt.dataset[k.toLowerCase()] = ev[k] || '');
    $('eventSelect').add(opt);
  });
}

// è´ŠåŠ©é …ç›®é‚è¼¯ (ç•¥ï¼Œèˆ‡å‰ç‰ˆç›¸åŒ)
$('addSponsorBtn').onclick = createSponsorRow;
function createSponsorRow() {
  const rowId = 'spRow_' + Date.now();
  const div = document.createElement('div');
  div.className = 'sponsor-item'; div.id = rowId;
  div.innerHTML = `
    <div class="sponsor-header"><span>è´ŠåŠ©é …ç›®</span><button type="button" class="remove-btn" onclick="removeRow('${rowId}')">ğŸ—‘ï¸</button></div>
    <select class="sponsor-select" onchange="handleSponsorChange('${rowId}')" required></select>
    <div class="qtyGrp" style="display:none; margin-top:8px;">
      <select class="qtySelect" style="display:none;"></select>
      <input type="text" class="otherInput" placeholder="è«‹è‡ªå¡«é …ç›®" style="display:none;">
      <div class="moneyGrp qty-flex" style="display:none;"><input type="number" class="mVal" value="500" min="0" step="500"> <span>å…ƒ</span></div>
    </div>`;
  $('sponsorContainer').appendChild(div);
  const sel = div.querySelector('.sponsor-select');
  sel.add(new Option("-- è«‹é¸æ“‡ --", ""));
  sel.add(new Option("ç„¡", "ç„¡"));
  masterOptions.sponsor.forEach(s => { if(s!=="ç„¡") sel.add(new Option(s, s)); });
}
function handleSponsorChange(rowId) {
  const row = $(rowId), val = row.querySelector('.sponsor-select').value;
  const qGrp = row.querySelector('.qtyGrp'), qSel = row.querySelector('.qtySelect'), 
        oInp = row.querySelector('.otherInput'), mGrp = row.querySelector('.moneyGrp');
  qGrp.style.display = (val && val !== 'ç„¡') ? 'block' : 'none';
  qSel.style.display = oInp.style.display = mGrp.style.display = 'none';
  if (val === 'å…¶ä»–') oInp.style.display = 'block';
  else if (val === 'ç´…åŒ…') mGrp.style.display = 'flex';
  else if (val && val !== 'ç„¡') {
    qSel.style.display = 'block'; qSel.innerHTML = '';
    masterOptions.sponsorQty.forEach(q => qSel.add(new Option(q, q)));
  }
  $('addSponsorBtn').style.display = 'block';
}
function removeRow(id) { $(id).remove(); if ($('sponsorContainer').children.length === 0) createSponsorRow(); }

// æ´»å‹•é¸æ“‡
$('eventSelect').onchange = () => {
  const o = $('eventSelect').selectedOptions[0];
  if(!o || !o.value) return;
  const d = o.dataset;
  $('cancelRegBtn').style.display = (d.joined === 'true') ? 'block' : 'none';
  
  const fill = (id, list) => { $(id).innerHTML = ''; list.forEach(x => $(id).add(new Option(x, x))); };
  fill('people', masterOptions.people);
  if (d.type === 'å°¾ç‰™') {
    $('weiyaFields').style.display = 'block'; $('travelFields').style.display = 'none';
    fill('table', masterOptions.table);
    $('evTime').innerText = d.time;
  } else {
    $('travelFields').style.display = 'block'; $('weiyaFields').style.display = 'none';
    fill('pickup', masterOptions.pickup); fill('room', masterOptions.room);
    $('evTime').innerText = `${d.startdate} ~ ${d.enddate}`;
  }
  $('evTitle').innerText = d.title; $('evHost').innerText = d.host;
  $('evStore').innerText = d.store; $('evAddress').innerText = d.address;
  $('regForm').style.display = $('eventInfo').style.display = 'block';
  $('sponsorContainer').innerHTML = ''; createSponsorRow(); loadStats(o.value);
};

// ã€å–æ¶ˆå ±åã€‘åŠŸèƒ½ - å°æ¥æ‚¨çš„ GAS action="cancel"
$('cancelRegBtn').onclick = async () => {
  if (!confirm("ç¢ºå®šè¦ã€å¾¹åº•åˆªé™¤ã€‘å ±åç´€éŒ„å—ï¼Ÿ")) return;
  $('cancelRegBtn').disabled = true;
  const o = $('eventSelect').selectedOptions[0].dataset;
  const payload = { eventId: o.eventid, userId: $('userId').value };
  
  const r = await callApi('cancel', `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
  alert(r.message);
  location.reload();
};

// ã€é€å‡ºæ›´æ–°ã€‘åŠŸèƒ½
$('regForm').onsubmit = async (e) => {
  e.preventDefault();
  const sponsorList = [];
  document.querySelectorAll('.sponsor-item').forEach(row => {
    const name = row.querySelector('.sponsor-select').value;
    if(!name || name === 'ç„¡') return;
    if (name === 'å…¶ä»–') sponsorList.push(row.querySelector('.otherInput').value);
    else if (name === 'ç´…åŒ…') sponsorList.push(`ç´…åŒ…(${row.querySelector('.mVal').value})`);
    else sponsorList.push(`${name}(${row.querySelector('.qtySelect').value})`);
  });
  
  $('subBtn').disabled = true;
  const o = $('eventSelect').selectedOptions[0].dataset;
  const payload = {
    eventId: o.eventid, eventType: o.type, userId: $('userId').value, userName: $('userName').value,
    people: $('people').value, table: $('table').value, pickup: $('pickup').value, room: $('room').value,
    sponsor: sponsorList.join(', ') || 'ç„¡', memo: $('memo').value
  };
  
  const r = await callApi('modify', `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
  alert(r.message);
  location.reload();
};

// è¼‰å…¥çµ±è¨ˆ
async function loadStats(eventId) {
  const data = await callApi('queryStats', `&eventId=${eventId}`);
  if (!data.users) return;
  let total = data.users.reduce((s, u) => s + (parseInt(u.people)||0), 0);
  $('uStats').innerHTML = `<strong>ğŸ‘¤ ç¸½å ±åï¼š${total} äºº</strong>`;
  
  let uHtml = '';
  data.users.forEach(u => uHtml += `<div class="user-list-item">${u.userName} (${u.people}äºº)</div>`);
  $('uDetail').innerHTML = uHtml;

  let spHtml = `<strong>ğŸ ç¸½è´ŠåŠ©çµ±è¨ˆï¼š</strong><br>`;
  for (let key in data.sponsor) spHtml += `â€¢ ${key}: ${data.sponsor[key]}<br>`;
  $('sStats').innerHTML = Object.keys(data.sponsor).length ? spHtml : 'æš«ç„¡è´ŠåŠ©';
  $('stats').style.display = 'block';
}

window.onload = init;
</script>
</body>
</html>
