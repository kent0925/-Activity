<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>

<style>
body { font-family: Arial; margin: 20px; background: #f4f4f4; }
.container {
  max-width: 520px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 { text-align: center; }
label { display:block; margin-top:10px; }
select, input[type=text], textarea {
  width:100%; padding:7px; margin-top:5px;
}
button {
  margin-top:15px; padding:10px; width:48%;
  border:none; border-radius:5px;
  background:#4CAF50; color:#fff;
}
button.cancel { background:#f44336; }
#eventInfo {
  margin-top:15px; padding:12px;
  background:#f9f9f9; border-radius:8px;
}
#eventInfo h3 { margin:0 0 8px 0; }
#result { margin-top:10px; color:#d32f2f; font-weight:bold; }
</style>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
<div class="container">

<h2>æ—…éŠ / å°¾ç‰™ å ±åè¡¨å–®</h2>

<form id="registrationForm">

<label>é¸æ“‡æ´»å‹•ï¼š
  <select id="eventSelect" required>
    <option value="">è«‹é¸æ“‡æ´»å‹•</option>
  </select>
</label>

<!-- ===== æ´»å‹•è³‡è¨Š ===== -->
<div id="eventInfo" style="display:none;">
  <h3 id="evTitle"></h3>
  <p>ä¸»è¾¦ï¼š<span id="evHost"></span></p>
  <p>æ™‚é–“ï¼š<span id="evTime"></span></p>
  <p>åº—åï¼š<span id="evStore"></span></p>
  <p>åœ°å€ï¼š<span id="evAddress"></span></p>
  <button type="button" id="mapBtn">ğŸ“ Google Map</button>
</div>

<label>ä½¿ç”¨è€…åç¨±ï¼š
  <input type="text" id="userName" readonly>
</label>
<input type="hidden" id="userId">

<div id="formFields" style="display:none;">

<label>åƒåŠ äººæ•¸ï¼š
  <select id="people"></select>
</label>

<label id="tableLabel">èªæ¡Œæ•¸é‡ï¼ˆå°¾ç‰™ï¼‰ï¼š
  <select id="table"></select>
</label>

<label id="pickupLabel">ä¸Šè»Šåœ°é»ï¼ˆæ—…éŠï¼‰ï¼š
  <select id="pickup"></select>
</label>

<label id="roomLabel">æˆ¿å‹é¸æ“‡ï¼ˆæ—…éŠï¼‰ï¼š
  <select id="room"></select>
</label>

<label>è´ŠåŠ©é …ç›®ï¼š
  <select id="sponsor"></select>
</label>

<label id="sponsorOtherLabel" style="display:none;">
  å…¶ä»–è´ŠåŠ©é …ç›®ï¼š
  <input type="text" id="sponsorOther">
</label>

<label id="qtyLabel">è´ŠåŠ©æ•¸é‡ï¼š
  <select id="qty"></select>
</label>

<label>å‚™è¨»ï¼š
  <textarea id="memo"></textarea>
</label>

<button type="submit">é€å‡º / æ›´æ–°</button>
<button type="button" class="cancel" id="cancelBtn">å–æ¶ˆå ±å</button>

</div>

<p id="result"></p>
</form>

</div>

<script>
/* ===== è¨­å®š ===== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJuAodySUQ0jUh0mNEvSv4D5J2Bi8GB7tp480BxHGyVOx-QeKiPJg7-KktBDtmKsf9/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';

/* ===== LIFF ===== */
async function initLiff(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const profile = await liff.getProfile();
  userName.value = profile.displayName;
  userId.value = profile.userId;
}

/* ===== è¼‰å…¥æ´»å‹• ===== */
async function loadEvents(){
  const res = await fetch(`${GAS_URL}?action=getEvents`);
  const data = await res.json();
  data.forEach(ev=>{
    const opt = document.createElement('option');
    opt.value = ev.eventId;
    opt.text = `${ev.title} (${ev.type})`;
    Object.keys(ev).forEach(k => opt.dataset[k] = ev[k]);
    eventSelect.add(opt);
  });
}

/* ===== è¼‰å…¥é¸å–® ===== */
async function loadOptions(type,id){
  const res = await fetch(`${GAS_URL}?action=getOptions&type=${type}`);
  const data = await res.json();
  const sel = document.getElementById(id);
  sel.innerHTML = '';
  data.forEach(v=>{
    const o = document.createElement('option');
    o.value=v; o.text=v;
    sel.add(o);
  });
}

/* ===== æ´»å‹•åˆ‡æ› ===== */
eventSelect.addEventListener('change',()=>{
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value){
    formFields.style.display='none';
    eventInfo.style.display='none';
    return;
  }

  formFields.style.display='block';
  eventInfo.style.display='block';

  evTitle.innerText = opt.dataset.title || '';
  evHost.innerText = opt.dataset.host || '';
  evStore.innerText = opt.dataset.store || '';
  evAddress.innerText = opt.dataset.address || '';

  if(opt.dataset.type === 'å°¾ç‰™'){
    evTime.innerText = opt.dataset.time || '';
  }else{
    evTime.innerText =
      (opt.dataset.startDate || '') + ' ï½ ' + (opt.dataset.endDate || '');
  }

  mapBtn.onclick = ()=>{
    const addr = encodeURIComponent(opt.dataset.address || '');
    window.open(`https://www.google.com/maps/search/?api=1&query=${addr}`);
  };

  tableLabel.style.display = opt.dataset.type === 'å°¾ç‰™' ? 'block' : 'none';
  pickupLabel.style.display = roomLabel.style.display =
    opt.dataset.type === 'æ—…éŠ' ? 'block' : 'none';
});

/* ===== è´ŠåŠ©åˆ‡æ› ===== */
sponsor.addEventListener('change',()=>{
  sponsorOtherLabel.style.display = sponsor.value === 'å…¶ä»–' ? 'block':'none';
  qtyLabel.style.display = sponsor.value === 'ç„¡' ? 'none':'block';
});

/* ===== é€å‡º ===== */
registrationForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const opt = eventSelect.selectedOptions[0];
  const payload = {
    eventId: opt.value,
    eventType: opt.dataset.type,
    userId: userId.value,
    userName: userName.value,
    people: people.value,
    table: table.value,
    pickup: pickup.value,
    room: room.value,
    sponsor: sponsor.value,
    sponsorOther: sponsorOther.value,
    qty: qty.value,
    memo: memo.value,
    action:'modify'
  };

  const res = await fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({
      events:[
        { postback:{ data: JSON.stringify(payload) }},
        { source:{ userId: userId.value }}
      ]
    })
  });
  const r = await res.json();
  result.innerText = r.message;
});

/* ===== å–æ¶ˆ ===== */
cancelBtn.addEventListener('click',async ()=>{
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value) return;
  const res = await fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({
      events:[
        { postback:{ data: JSON.stringify({eventId:opt.value, action:'cancel'}) }},
        { source:{ userId:userId.value }}
      ]
    })
  });
  const r = await res.json();
  result.innerText = r.message;
  formFields.style.display='none';
});

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded',async()=>{
  await initLiff();
  await loadEvents();
  loadOptions('people','people');
  loadOptions('table','table');
  loadOptions('pickup','pickup');
  loadOptions('room','room');
  loadOptions('sponsor','sponsor');
  loadOptions('sponsorQty','qty');
});
</script>

</body>
</html>
