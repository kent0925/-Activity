<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin:15px; background:#f0f2f5; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { text-align:center; color: #1a73e8; margin-bottom: 20px; }
  label { display:block; margin-top:12px; font-weight: bold; color: #444; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  .btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
  button { padding:12px; width:48%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-weight: bold; transition: 0.3s; }
  button:hover { opacity: 0.8; }
  button.cancel { background:#e53935; }
  #eventInfo, #stats { margin-top:15px; padding:15px; border-radius:8px; display:none; }
  #eventInfo { background:#e8f0fe; border-left: 5px solid #1a73e8; }
  #stats { background:#f8f9fa; border-left: 5px solid #4CAF50; }
  #result { margin-top:15px; text-align: center; font-weight:bold; min-height: 24px; }
  .stat-item { margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 8px; font-size: 14px; line-height: 1.6; }
  #mapBtn { width: 100%; background: #4285F4 !important; margin-top:12px; display: block !important; color: white; }

  /* è´ŠåŠ©å€å¡Šå°ˆå±¬æ¨£å¼ */
  .sponsor-item { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px; position: relative; }
  .sponsor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .remove-btn { background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; line-height: 1; }
  .add-sponsor-btn { background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 14px; width: 100%; font-weight: bold; }
  .sponsor-tip { font-size: 12px; color: #666; margin: 10px 0; background: #fffde7; padding: 8px; border-radius: 6px; border: 1px solid #fff59d; }
  .qty-input-wrap { position: relative; display: flex; align-items: center; }
  .qty-input-wrap input { padding-right: 40px; }
  .qty-unit { position: absolute; right: 10px; top: 14px; color: #666; font-size: 14px; pointer-events: none; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</h2>
  
  <label>é¸æ“‡æ´»å‹•ï¼š
    <select id="eventSelect"><option value="">è¼‰å…¥ä¸­...</option></select>
  </label>

  <div id="eventInfo">
    <h3 id="evTitle" style="margin:0 0 8px 0; color:#1a73e8;"></h3>
    <p style="margin:4px 0;">ğŸ‘¤ ä¸»è¾¦äººï¼š<span id="evHost"></span></p>
    <p style="margin:4px 0;">ğŸ“… æ™‚é–“ï¼š<span id="evTime"></span></p>
    <p style="margin:4px 0;">ğŸ“ åœ°é»ï¼š<span id="evStore"></span></p>
    <p style="margin:4px 0;">ğŸ  åœ°å€ï¼š<span id="evAddress"></span></p>
    <button type="button" id="mapBtn">ğŸ“ é–‹å•Ÿ Google åœ°åœ–</button>
  </div>

  <form id="regForm" style="display:none;">
    <input type="hidden" id="userId">
    <label>å ±åè€…å§“åï¼š<input type="text" id="userName" readonly></label>
    <label>åƒåŠ äººæ•¸ï¼š<select id="people"></select></label>
    
    <div id="weiyaFields" style="display:none;">
      <label>èªæ¡Œæ•¸é‡ï¼š<select id="table"></select></label>
    </div>
    <div id="travelFields" style="display:none;">
      <label>ä¸Šè»Šåœ°é»ï¼š<select id="pickup"></select></label>
      <label>æˆ¿å‹é¸æ“‡ï¼š<select id="room"></select></label>
    </div>
    
    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
    
    <label>ğŸ è´ŠåŠ©é …ç›®ç®¡ç†ï¼š</label>
    <div id="sponsorContainer"></div>
    <button type="button" class="add-sponsor-btn" id="addSponsorBtn">â• æ–°å¢è´ŠåŠ©é …ç›®</button>
    
    <div class="sponsor-tip">
      ğŸ’¡ <b>æ“ä½œèªªæ˜ï¼š</b><br>
      â€¢ é¸ã€Œç´…åŒ…ã€ï¼šå¯è‡ªå¡«é‡‘é¡ã€‚<br>
      â€¢ é¸ã€Œå…¶ä»–ã€ï¼šå…å¡«æ•¸é‡ï¼Œä¸Šé™ 5 é …ã€‚<br>
      â€¢ é¸ã€Œç„¡ã€ï¼šéš±è—å¾ŒçºŒé¸é …ã€‚<br>
      â€¢ åŒä¸€é …ç›®ä¸å¯é‡è¤‡é¸æ“‡ã€‚
    </div>

    <label>å‚™è¨»ï¼š<textarea id="memo" rows="2" placeholder="ç‰¹æ®Šé£Ÿæ€§æˆ–å‚™è¨»"></textarea></label>

    <div class="btn-group">
      <button type="submit" id="subBtn">é€å‡ºæ›´æ–°</button>
      <button type="button" class="cancel" id="canBtn">å–æ¶ˆå ±å</button>
    </div>
  </form>

  <div id="result"></div>
  <div id="stats">
    <h3 style="margin:0 0 10px 0; font-size:16px; color:#2e7d32;">ğŸ“Š å³æ™‚çµ±è¨ˆå›å ±</h3>
    <div id="uStats" class="stat-item"></div>
    <div id="dStats" class="stat-item"></div>
    <div id="sStats" class="stat-item"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);

let masterOptions = { sponsor: [], sponsorQty: [] };

function formatDateTime(val, includeTime = false) {
  if (!val || val === 'undefined' || val === 'null' || val === '') return 'æœªå®š';
  let d = new Date(val);
  if (isNaN(d.getTime())) return String(val);
  if (String(val).includes('T')) { d.setHours(d.getHours() + 8); }
  const Y = d.getFullYear(), M = String(d.getMonth() + 1).padStart(2, '0'), D = String(d.getDate()).padStart(2, '0');
  const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  let res = `${Y}-${M}-${D} (${weekDays[d.getDay()]})`;
  if (includeTime) res += ` ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
  return res;
}

async function callApi(action, extra = '') {
  const r = await fetch(`${GAS_URL}?action=${action}${extra}`);
  return await r.json();
}

function createSponsorRow() {
  const container = $('sponsorContainer');
  const selects = container.querySelectorAll('.sponsor-select');
  const otherCount = Array.from(selects).filter(s => s.value === 'å…¶ä»–').length;
  if (otherCount >= 5) { alert("ã€Œå…¶ä»–ã€é …ç›®æœ€å¤šå¢åŠ  5 é …"); return; }

  const rowId = 'spRow_' + Date.now();
  const div = document.createElement('div');
  div.className = 'sponsor-item';
  div.id = rowId;
  div.innerHTML = `
    <div class="sponsor-header"><span>è´ŠåŠ©é …ç›®</span><button type="button" class="remove-btn" onclick="removeRow('${rowId}')">âœ–</button></div>
    <select class="sponsor-select" onchange="handleSponsorChange('${rowId}')"></select>
    <div class="spOtherGrp" style="display:none; margin-top:5px;"><input type="text" class="spOtherInput" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©é …ç›®åç¨±"></div>
    <div class="qtyGrp" style="display:none; margin-top:5px;">
      <select class="qtySelect"></select>
      <div class="qtyInputWrap" style="display:none;"><input type="number" class="qtyInput" placeholder="é‡‘é¡" step="500" min="0" value="0"><span class="qty-unit">å…ƒ</span></div>
    </div>
  `;
  container.appendChild(div);
  updateSponsorOptions();
}

function removeRow(id) { $(id).remove(); updateSponsorOptions(); }

function updateSponsorOptions() {
  const selects = document.querySelectorAll('.sponsor-select');
  const selectedValues = Array.from(selects).map(s => s.value).filter(v => v !== "" && v !== "å…¶ä»–" && v !== "ç„¡");

  selects.forEach(select => {
    const currentVal = select.value;
    select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
    masterOptions.sponsor.forEach(opt => {
      if (selectedValues.includes(opt) && opt !== currentVal && opt !== "å…¶ä»–" && opt !== "ç„¡") return;
      select.add(new Option(opt, opt));
    });
    select.value = currentVal;
    handleSponsorChange(select.closest('.sponsor-item').id);
  });
}

function handleSponsorChange(rowId) {
  const row = $(rowId);
  const val = row.querySelector('.sponsor-select').value;
  const oGrp = row.querySelector('.spOtherGrp'), qGrp = row.querySelector('.qtyGrp'), qSel = row.querySelector('.qtySelect'), qInp = row.querySelector('.qtyInputWrap');
  if(qSel.options.length === 0) masterOptions.sponsorQty.forEach(q => qSel.add(new Option(q, q)));

  // ğŸ’¡ é‚è¼¯ï¼šé¸æ“‡ã€Œç„¡ã€å…¨éƒ¨éš±è—
  if (val === 'ç„¡' || val === '') { oGrp.style.display = qGrp.style.display = 'none'; }
  else if (val === 'å…¶ä»–') { oGrp.style.display = 'block'; qGrp.style.display = 'none'; }
  else if (val === 'ç´…åŒ…') { oGrp.style.display = 'none'; qGrp.style.display = 'block'; qSel.style.display = 'none'; qInp.style.display = 'flex'; }
  else { oGrp.style.display = 'none'; qGrp.style.display = 'block'; qSel.style.display = 'block'; qInp.style.display = 'none'; }
}

$('regForm').onsubmit = async (e) => {
  e.preventDefault();
  $('subBtn').disabled = true;
  $('result').innerHTML = '<span>å‚³è¼¸ä¸­...</span>';
  
  const sponsorList = [];
  document.querySelectorAll('.sponsor-item').forEach(row => {
    const sel = row.querySelector('.sponsor-select').value;
    if(!sel || sel === 'ç„¡') return;
    let name = sel, qty = "";
    if(sel === 'å…¶ä»–') { name = row.querySelector('.spOtherInput').value || 'å…¶ä»–'; qty = "1"; }
    else if(sel === 'ç´…åŒ…') qty = row.querySelector('.qtyInput').value;
    else qty = row.querySelector('.qtySelect').value;
    sponsorList.push(`${name}(${qty})`);
  });

  const o = $('eventSelect').selectedOptions[0];
  const payload = {
    eventId: o.value, eventType: o.dataset.type, userId: $('userId').value, userName: $('userName').value,
    people: $('people').value, table: $('table').value, pickup: $('pickup').value, room: $('room').value,
    sponsor: sponsorList.join(', ') || 'ç„¡', memo: $('memo').value
  };

  try {
    const r = await callApi('modify', `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
    $('result').innerHTML = `<span style="color:blue;">${r.message}</span>`;
    loadStats(o.value);
  } catch(e) { $('result').innerText = 'å„²å­˜å¤±æ•—'; }
  finally { $('subBtn').disabled = false; }
};

async function init(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) { liff.login(); return; }
    const p = await liff.getProfile();
    $('userName').value = p.displayName; $('userId').value = p.userId;
    loadEvents();
  } catch(e) {}
}

async function loadEvents(){
  const [evs, myJoined] = await Promise.all([callApi('getEvents'), callApi('queryStats', '&all=true')]);
  $('eventSelect').innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
  evs.forEach(ev => {
    const isJoined = myJoined.some(j => String(j.eventId) === String(ev.eventId) && String(j.userId) === $('userId').value);
    const opt = new Option(`${ev.title} (${ev.type})${isJoined ? ' âœ…' : ''}`, ev.eventId);
    Object.keys(ev).forEach(k => opt.dataset[k] = ev[k] || '');
    $('eventSelect').add(opt);
  });
}

$('eventSelect').onchange = () => {
  const o = $('eventSelect').selectedOptions[0];
  if(!o || !o.value) return;
  const isW = o.dataset.type === 'å°¾ç‰™';
  $('eventInfo').style.display = $('regForm').style.display = $('stats').style.display = 'block';
  $('evTitle').innerText = o.dataset.title;
  $('evHost').innerText = o.dataset.host || 'ç„¡';
  $('evStore').innerText = o.dataset.store || 'ç„¡';
  $('evAddress').innerText = o.dataset.address || 'ç„¡';
  $('evTime').innerText = isW ? formatDateTime(o.dataset.time, true) : `${formatDateTime(o.dataset.startDate)} ~ ${formatDateTime(o.dataset.endDate)}`;
  $('mapBtn').onclick = () => {
    const addr = o.dataset.address;
    if(addr && addr !== 'ç„¡') window.open("http://maps.google.com/?q=" + encodeURIComponent(addr), "_blank");
  };
  $('weiyaFields').style.display = isW ? 'block' : 'none';
  $('travelFields').style.display = isW ? 'none' : 'block';
  $('sponsorContainer').innerHTML = '';
  createSponsorRow();
  loadStats(o.value);
};

$('addSponsorBtn').onclick = createSponsorRow;

async function loadStats(eventId) {
  try {
    const data = await callApi('queryStats', `&eventId=${eventId}`);
    let total = 0; data.users.forEach(u => total += parseInt(u.people)||0);
    $('uStats').innerHTML = `<strong>ğŸ‘¥ ç¸½äººæ•¸ï¼š${total}</strong><br>` + (data.users.map(u => `${u.userName}(${u.people})`).join(', '));
    const isW = $('eventSelect').selectedOptions[0].dataset.type === 'å°¾ç‰™';
    const tar = isW ? data.tableStats : data.roomStats;
    let det = `<strong>${isW ? 'ğŸ—„ï¸ æ¡Œæ•¸' : 'ğŸ¨ æˆ¿å‹'}ï¼š</strong><br>`;
    Object.keys(tar).forEach(k => { if(k!=="undefined") det += `â€¢ ${k} (${tar[k]}äºº)<br>`; });
    $('dStats').innerHTML = det;
    let sp = `<strong>ğŸ è´ŠåŠ©ï¼š</strong><br>`;
    Object.keys(data.sponsor).forEach(k => { sp += `â€¢ ${k}: ${data.sponsor[k]}<br>`; });
    $('sStats').innerHTML = sp;
  } catch(e) {}
}

window.onload = async () => {
  init();
  masterOptions.sponsor = await callApi('getOptions', '&type=sponsor');
  masterOptions.sponsorQty = await callApi('getOptions', '&type=sponsorQty');
};

$('canBtn').onclick = async () => {
  if(!confirm('å–æ¶ˆå ±åï¼Ÿ')) return;
  const o = $('eventSelect').selectedOptions[0];
  const r = await callApi('cancel', `&payload=${encodeURIComponent(JSON.stringify({eventId:o.value, userId:$('userId').value}))}`);
  $('result').innerHTML = `<span style="color:red;">${r.message}</span>`;
  loadEvents(); loadStats(o.value);
};
</script>
</body>
</html>
