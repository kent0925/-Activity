<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>旅遊/尾牙報名系統（LIFF）</title>
<style>
body { font-family: Arial; margin: 20px; background: #f4f4f4; }
.container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
h2 { text-align: center; color: #333; }
label { display: block; margin-top: 10px; color: #555; }
select, input[type=text], textarea { width: 100%; padding: 7px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
button { margin-top: 15px; padding: 10px; width: 48%; border:none; border-radius: 5px; background: #4CAF50; color: #fff; cursor: pointer; }
button.cancel { background: #f44336; }
button:hover { opacity: 0.9; }
#result { margin-top: 10px; color: #d32f2f; font-weight: bold; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
<h2>旅遊/尾牙報名表單</h2>
<form id="registrationForm">
<label>選擇活動：
  <select id="eventSelect" required>
    <option value="">請選擇活動</option>
  </select>
</label>
<label>使用者名稱：
  <input type="text" id="userName" readonly>
</label>
<label style="display:none;">User ID：
  <input type="text" id="userId" readonly>
</label>

<div id="formFields" style="display:none;">
<label>參加人數：
  <select id="people" required></select>
</label>
<label id="tableLabel">認桌數量（尾牙）：
  <select id="table"></select>
</label>
<label id="pickupLabel">上車地點（旅遊）：
  <select id="pickup"></select>
</label>
<label id="roomLabel">房型選擇（旅遊）：
  <select id="room"></select>
</label>
<label>贊助項目：
  <select id="sponsor" required></select>
</label>
<label id="sponsorOtherLabel" style="display:none;">其他贊助項目：
  <input type="text" id="sponsorOther">
</label>
<label id="qtyLabel">贊助數量：
  <select id="qty" required></select>
</label>
<label>備註：
  <textarea id="memo"></textarea>
</label>
<button type="submit">送出 / 更新報名</button>
<button type="button" class="cancel" id="cancelBtn">取消報名</button>
</div>
<p id="result"></p>
</form>
</div>

<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbyJuAodySUQ0jUh0mNEvSv4D5J2Bi8GB7tp480BxHGyVOx-QeKiPJg7-KktBDtmKsf9/exec';
const LIFF_ID='2008678090-TpSkCDSZ';

async function initLiff(){
  await liff.init({liffId: LIFF_ID});
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    document.getElementById('userName').value = profile.displayName;
    document.getElementById('userId').value = profile.userId;
  }else liff.login();
}

// 載入活動
async function loadEvents(){
  const res = await fetch(`${GAS_URL}?action=getEvents`);
  const data = await res.json();
  const select = document.getElementById('eventSelect');
  data.forEach(ev=>{
    const opt = document.createElement('option');
    opt.value = ev.eventId;
    opt.dataset.type = ev.type;
    opt.text = `${ev.title} (${ev.type})`;
    select.add(opt);
  });
}

// 載入下拉選單
async function loadOptions(type,selectId){
  const res = await fetch(`${GAS_URL}?action=getOptions&type=${type}`);
  const data = await res.json();
  const select = document.getElementById(selectId);
  select.innerHTML = '';
  data.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d;
    opt.text = d;
    select.add(opt);
  });
}

// 切換欄位
document.getElementById('eventSelect').addEventListener('change',()=>{
  const selected = document.getElementById('eventSelect').selectedOptions[0];
  if(!selected.value){ document.getElementById('formFields').style.display='none'; return; }
  const type = selected.dataset.type;
  document.getElementById('formFields').style.display='block';
  document.getElementById('tableLabel').style.display = type==='尾牙'?'block':'none';
  document.getElementById('pickupLabel').style.display = type==='旅遊'?'block':'none';
  document.getElementById('roomLabel').style.display = type==='旅遊'?'block':'none';
});

// 贊助選擇
document.getElementById('sponsor').addEventListener('change',()=>{
  const val = document.getElementById('sponsor').value;
  document.getElementById('sponsorOtherLabel').style.display = val==='其他'?'block':'none';
  document.getElementById('qtyLabel').style.display = val==='無'||val===''?'none':'block';
});

window.addEventListener('DOMContentLoaded',async()=>{
  await initLiff();
  await loadEvents();
  loadOptions('people','people');
  loadOptions('table','table');
  loadOptions('pickup','pickup');
  loadOptions('room','room');
  loadOptions('sponsor','sponsor');
  loadOptions('sponsorQty','qty');
});

// 送出 / 修改
document.getElementById('registrationForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const eventSelect = document.getElementById('eventSelect').selectedOptions[0];
  const data = {
    eventId: eventSelect.value,
    eventType: eventSelect.dataset.type,
    userId: document.getElementById('userId').value,
    userName: document.getElementById('userName').value,
    people: document.getElementById('people').value,
    table: document.getElementById('table').value,
    pickup: document.getElementById('pickup').value,
    room: document.getElementById('room').value,
    sponsor: document.getElementById('sponsor').value,
    sponsorOther: document.getElementById('sponsorOther').value,
    qty: document.getElementById('qty').value,
    memo: document.getElementById('memo').value,
    action:'modify'
  };
  const res = await fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({events:[{postback:{data:JSON.stringify(data)}}, {source:{userId:data.userId}}]})
  });
  const result = await res.json();
  document.getElementById('result').innerText = result.message;
});

// 取消報名
document.getElementById('cancelBtn').addEventListener('click',async ()=>{
  const eventSelect = document.getElementById('eventSelect').selectedOptions[0];
  if(!eventSelect.value) return alert('請先選擇活動');
  const data = { eventId: eventSelect.value, userId: document.getElementById('userId').value, action:'cancel' };
  const res = await fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({events:[{postback:{data:JSON.stringify(data)}}, {source:{userId:data.userId}}]})
  });
  const result = await res.json();
  document.getElementById('result').innerText = result.message;
  document.getElementById('formFields').style.display='none';
});
</script>
</body>
</html>
