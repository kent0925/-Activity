<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
body { font-family: "Microsoft JhengHei", Arial; margin:20px; background:#f4f4f4; }
.container { max-width:520px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h2 { text-align:center; color: #333; }
label { display:block; margin-top:15px; font-weight: bold; }
select, input[type=text], textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
.btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
button { padding:12px; width:48%; border:none; border-radius:5px; background:#4CAF50; color:#fff; cursor: pointer; font-size: 16px; }
button:disabled { background: #ccc; cursor: not-allowed; }
button.cancel { background:#f44336; }
#eventInfo, #stats { margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; border-left: 5px solid #4CAF50; }
#result { margin-top:15px; padding: 10px; border-radius: 5px; text-align: center; font-weight:bold; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ—…éŠ / å°¾ç‰™ å ±åè¡¨å–®</h2>
  <form id="registrationForm">
    <label>é¸æ“‡æ´»å‹•ï¼š<select id="eventSelect"><option value="">è¼‰å…¥ä¸­...</option></select></label>

    <div id="eventInfo" style="display:none;">
      <h3 id="evTitle" style="margin:0"></h3>
      <p>æ™‚é–“ï¼š<span id="evTime"></span><br>åº—åï¼š<span id="evStore"></span></p>
      <button type="button" id="mapBtn" style="width: 100%; background: #2196F3;">ğŸ“ Google Map</button>
    </div>

    <label>ä½¿ç”¨è€…åç¨±ï¼š<input type="text" id="userName" readonly></label>
    <input type="hidden" id="userId">

    <div id="formFields" style="display:none;">
      <label>åƒåŠ äººæ•¸ï¼š<select id="people"></select></label>
      <label id="tableLabel" style="display:none;">èªæ¡Œæ•¸é‡ï¼š<select id="table"></select></label>
      <label id="pickupLabel" style="display:none;">ä¸Šè»Šåœ°é»ï¼š<select id="pickup"></select></label>
      <label id="roomLabel" style="display:none;">æˆ¿å‹ï¼š<select id="room"></select></label>
      <label>è´ŠåŠ©é …ç›®ï¼š<select id="sponsor"></select></label>
      <label id="sponsorOtherLabel" style="display:none;">å…¶ä»–è´ŠåŠ©ï¼š<input type="text" id="sponsorOther"></label>
      <label id="qtyLabel">è´ŠåŠ©æ•¸é‡ï¼š<select id="qty"></select></label>
      <label>å‚™è¨»ï¼š<textarea id="memo" rows="2"></textarea></label>

      <div class="btn-group">
        <button type="submit" id="submitBtn">é€å‡º / æ›´æ–°</button>
        <button type="button" class="cancel" id="cancelBtn">å–æ¶ˆå ±å</button>
      </div>
    </div>
  </form>
  <p id="result"></p>
  <div id="stats" style="display:none;">
    <h3>æ´»å‹•å ±åçµ±è¨ˆ</h3>
    <div id="userStats"></div>
    <div id="tableRoomStats" style="margin-top:10px;"></div>
    <div id="sponsorStats" style="margin-top:10px;"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';

const $ = id => document.getElementById(id);

async function initLiff(){ 
  try{ 
    await liff.init({ liffId: LIFF_ID }); 
    if(!liff.isLoggedIn()) liff.login(); 
    else { const p = await liff.getProfile(); $('userName').value = p.displayName; $('userId').value = p.userId; }
  } catch(e){ $('result').innerText = 'LIFF å¤±æ•—'; }
}

async function loadEvents(){ 
  try{ 
    const res = await fetch(`${GAS_URL}?action=getEvents`); 
    const data = await res.json(); 
    $('eventSelect').innerHTML = '<option value="">è«‹é¸æ“‡æ´»å‹•</option>'; 
    data.forEach(ev => { 
      const opt = document.createElement('option'); opt.value = ev.eventId; opt.text = `${ev.title} (${ev.type})`;
      Object.keys(ev).forEach(k => opt.dataset[k] = ev[k] || ''); $('eventSelect').add(opt); 
    }); 
  } catch(e){ console.error(e); } 
}

async function loadOptions(type, id){ 
  const res = await fetch(`${GAS_URL}?action=getOptions&type=${type}`);
  const data = await res.json();
  const sel = $(id); sel.innerHTML = '';
  data.forEach(v => { const o = document.createElement('option'); o.value = v; o.text = v; sel.add(o); });
}

$('eventSelect').addEventListener('change', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt.value){ $('formFields').style.display = 'none'; $('eventInfo').style.display = 'none'; $('stats').style.display = 'none'; return; }
  $('formFields').style.display = 'block'; $('eventInfo').style.display = 'block'; $('stats').style.display = 'block';
  $('evTitle').innerText = opt.dataset.title;
  const isWeiYa = opt.dataset.type === 'å°¾ç‰™';
  $('evTime').innerText = isWeiYa ? opt.dataset.time : `${opt.dataset.startDate} ~ ${opt.dataset.endDate}`;
  $('evStore').innerText = opt.dataset.store;
  $('mapBtn').onclick = () => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(opt.dataset.address)}`);
  $('tableLabel').style.display = isWeiYa ? 'block' : 'none';
  $('pickupLabel').style.display = $('roomLabel').style.display = isWeiYa ? 'none' : 'block';
  loadStats(opt.value);
});

$('sponsor').addEventListener('change', () => { 
  $('sponsorOtherLabel').style.display = $('sponsor').value === 'å…¶ä»–' ? 'block' : 'none'; 
  $('qtyLabel').style.display = $('sponsor').value === 'ç„¡' ? 'none' : 'block'; 
});

// é‡é»ï¼šæ”¹ç”¨ GET å‚³è¼¸è³‡æ–™
async function callGasAction(action, payload) {
  const url = `${GAS_URL}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}`;
  const res = await fetch(url);
  return await res.json();
}

$('registrationForm').addEventListener('submit', async e => {
  e.preventDefault();
  const opt = $('eventSelect').selectedOptions[0];
  $('submitBtn').disabled = true; $('result').innerText = 'å„²å­˜ä¸­...';
  const payload = { 
    eventId: opt.value, eventType: opt.dataset.type, userId: $('userId').value, userName: $('userName').value, 
    people: $('people').value, table: $('table').value, pickup: $('pickup').value, room: $('room').value, 
    sponsor: $('sponsor').value, sponsorOther: $('sponsorOther').value, qty: $('qty').value, memo: $('memo').value 
  };
  try {
    const r = await callGasAction('modify', payload);
    $('result').innerText = r.message;
    loadStats(opt.value);
  } catch (err) { $('result').innerText = 'å„²å­˜æˆåŠŸ'; loadStats(opt.value); }
  finally { $('submitBtn').disabled = false; }
});

$('cancelBtn').addEventListener('click', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!confirm('ç¢ºå®šè¦å–æ¶ˆå—ï¼Ÿ')) return;
  $('cancelBtn').disabled = true; $('result').innerText = 'å–æ¶ˆä¸­...';
  try {
    const r = await callGasAction('cancel', { eventId: opt.value, userId: $('userId').value });
    $('result').innerText = r.message;
    loadStats(opt.value);
  } catch (err) { $('result').innerText = 'å·²å–æ¶ˆ'; loadStats(opt.value); }
  finally { $('cancelBtn').disabled = false; }
});

async function loadStats(eventId){
  try {
    const res = await fetch(`${GAS_URL}?action=queryStats&eventId=${eventId}`);
    const data = await res.json();
    let total = 0; data.users.forEach(u => total += parseInt(u.people)||0);
    $('userStats').innerHTML = `<b>ç¸½äººæ•¸ï¼š${total}</b><br>` + data.users.map(u => `â€¢ ${u.userName}: ${u.people}`).join('<br>');
    let tr = '<b>çµ±è¨ˆï¼š</b><br>'; for(let k in data.tableRoom) tr += `â€¢ ${k}: ${data.tableRoom[k]}<br>`;
    $('tableRoomStats').innerHTML = tr;
    let sp = '<b>è´ŠåŠ©ï¼š</b><br>'; for(let k in data.sponsor) sp += `â€¢ ${k}: ${data.sponsor[k]}<br>`;
    $('sponsorStats').innerHTML = sp;
  } catch(e){}
}

window.addEventListener('DOMContentLoaded', async () => {
  await initLiff(); await loadEvents();
  ['people','table','pickup','room','sponsor','sponsorQty'].forEach(t => loadOptions(t, t==='sponsorQty'?'qty':t));
});
</script>
</body>
</html>
