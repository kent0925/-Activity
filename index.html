<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ´»å‹•å ±åç³»çµ± - æœ€çµ‚ç‰ˆ</title>
<style>
  body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin:15px; background:#f0f2f5; line-height: 1.5; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { text-align:center; color: #1a73e8; margin-bottom: 20px; }
  label { display:block; margin-top:12px; font-weight: bold; color: #444; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  .btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
  button { padding:12px; width:48%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
  button:hover { opacity: 0.8; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  button.cancel { background:#e53935; }
  #eventInfo { margin-top:15px; padding:15px; background:#e8f0fe; border-radius:8px; border-left: 5px solid #1a73e8; }
  #eventInfo p { margin: 5px 0; font-size: 14px; color: #333; }
  #stats { margin-top:15px; padding:15px; background:#f8f9fa; border-radius:8px; border-left: 5px solid #4CAF50; }
  #result { margin-top:15px; padding: 10px; border-radius: 6px; text-align: center; font-weight:bold; min-height: 20px; }
  .stat-item { margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
  .loading-overlay { color: #666; font-size: 12px; text-align: center; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ´»å‹•å ±åç³»çµ±</h2>
  <form id="registrationForm">
    <label>é¸æ“‡æ´»å‹•ï¼š<select id="eventSelect"><option value="">è¼‰å…¥æ´»å‹•ä¸­...</option></select></label>

    <div id="eventInfo" style="display:none;">
      <h3 id="evTitle" style="margin:0 0 10px 0; color:#1a73e8;"></h3>
      <p><strong>ğŸ‘¤ ä¸»è¾¦äººï¼š</strong><span id="evHost"></span></p>
      <p><strong>ğŸ“… æ™‚é–“ï¼š</strong><span id="evTime"></span></p>
      <p><strong>ğŸ“ åœ°é»ï¼š</strong><span id="evStore"></span></p>
      <p><strong>ğŸ  åœ°å€ï¼š</strong><span id="evAddress"></span></p>
      <button type="button" id="mapBtn" style="width: 100%; background: #5c6bc0; margin-top:10px;">ğŸ“ é–‹å•Ÿ Google åœ°åœ–</button>
    </div>

    <label>å ±åè€…å§“åï¼š<input type="text" id="userName" readonly placeholder="ç™»å…¥ LINE è¼‰å…¥ä¸­..."></label>
    <input type="hidden" id="userId">

    <div id="formFields" style="display:none;">
      <label>åƒåŠ äººæ•¸ï¼š<select id="people"></select></label>
      
      <div id="weiyaFields" style="display:none;">
        <label>èªæ¡Œæ•¸é‡ï¼š<select id="table"></select></label>
      </div>
      
      <div id="travelFields" style="display:none;">
        <label>ä¸Šè»Šåœ°é»ï¼š<select id="pickup"></select></label>
        <label>æˆ¿å‹é¸æ“‡ï¼š<select id="room"></select></label>
      </div>
      
      <label>è´ŠåŠ©é …ç›®ï¼š<select id="sponsor"></select></label>
      <div id="sponsorOtherGroup" style="display:none;">
        <label>è´ŠåŠ©åç¨±ï¼š<input type="text" id="sponsorOther" placeholder="è«‹è¼¸å…¥é …ç›®åç¨±"></label>
      </div>
      
      <label id="qtyLabel">è´ŠåŠ©æ•¸é‡ï¼š<select id="qty"></select></label>
      
      <label>å‚™è¨»ï¼š<textarea id="memo" rows="2" placeholder="ç‰¹æ®Šé£Ÿæ€§æˆ–å‚™è¨»"></textarea></label>

      <div class="btn-group">
        <button type="submit" id="submitBtn">é€å‡ºæ›´æ–°</button>
        <button type="button" class="cancel" id="cancelBtn">å–æ¶ˆå ±å</button>
      </div>
    </div>
  </form>

  <div id="result"></div>

  <div id="stats" style="display:none;">
    <h3 style="margin-top:0; font-size:16px; color:#2e7d32;">ğŸ“Š å³æ™‚å ±åçµ±è¨ˆå›å ±</h3>
    <div id="userStats" class="stat-item"></div>
    <div id="detailStats" class="stat-item"></div>
    <div id="sponsorStats"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);

// --- åˆå§‹åŒ– LIFF ---
async function initLiff(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) {
      liff.login();
    } else {
      const p = await liff.getProfile();
      $('userName').value = p.displayName;
      $('userId').value = p.userId;
    }
  } catch(e) { 
    $('result').innerHTML = '<span style="color:red">LINE ç™»å…¥å¤±æ•—ï¼Œè«‹æ–¼ LINE App é–‹å•Ÿ</span>'; 
  }
}

// --- API å‘¼å«å…ƒä»¶ ---
async function callApi(action, extraParams = '') {
  const res = await fetch(`${GAS_URL}?action=${action}${extraParams}`);
  return await res.json();
}

// --- ç›£æ§æ´»å‹•é¸æ“‡ ---
$('eventSelect').addEventListener('change', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt || !opt.value) {
    $('formFields').style.display = $('eventInfo').style.display = $('stats').style.display = 'none';
    return;
  }

  const isWeiYa = opt.dataset.type === 'å°¾ç‰™';
  
  // é¡¯ç¤ºå€å¡Š
  $('eventInfo').style.display = 'block';
  $('formFields').style.display = 'block';
  $('stats').style.display = 'block';

  // å¡«å…¥æ´»å‹•è³‡è¨Š
  $('evTitle').innerText = opt.dataset.title;
  $('evHost').innerText = opt.dataset.host || 'ç„¡';
  $('evStore').innerText = opt.dataset.store || 'ç„¡';
  $('evAddress').innerText = opt.dataset.address || 'ç„¡';
  
  // æ™‚é–“é‚è¼¯ï¼šæ—…éŠé¡¯ç¤ºèµ·è¨–æ—¥æœŸï¼Œå°¾ç‰™é¡¯ç¤ºå–®ä¸€æ™‚é–“é»
  $('evTime').innerText = isWeiYa ? (opt.dataset.time || 'æœªå®š') : `${opt.dataset.startDate} ï½ ${opt.dataset.endDate}`;

  // åœ°åœ–æŒ‰éˆ•
  $('mapBtn').onclick = () => {
    if(opt.dataset.address) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(opt.dataset.address)}`);
    else alert('æ­¤æ´»å‹•æœªæä¾›åœ°å€è³‡è¨Š');
  };

  // æ¬„ä½é¡¯ç¤º/éš±è— åˆ‡æ›
  $('weiyaFields').style.display = isWeiYa ? 'block' : 'none';
  $('travelFields').style.display = isWeiYa ? 'none' : 'block';

  loadStats(opt.value);
});

// --- è´ŠåŠ©é …ç›®é€£å‹• ---
$('sponsor').addEventListener('change', () => {
  $('sponsorOtherGroup').style.display = $('sponsor').value === 'å…¶ä»–' ? 'block' : 'none';
  $('qtyLabel').style.display = $('sponsor').value === 'ç„¡' ? 'none' : 'block';
});

// --- å ±åèˆ‡æ›´æ–° ---
$('registrationForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt.value) return;

  $('submitBtn').disabled = true;
  $('result').innerText = 'æ­£åœ¨å‚³è¼¸è³‡æ–™...';

  const payload = {
    eventId: opt.value,
    eventType: opt.dataset.type,
    userId: $('userId').value,
    userName: $('userName').value,
    people: $('people').value,
    table: $('table').value,
    pickup: $('pickup').value,
    room: $('room').value,
    sponsor: $('sponsor').value,
    sponsorOther: $('sponsorOther').value,
    qty: $('qty').value,
    memo: $('memo').value
  };

  try {
    const res = await fetch(`${GAS_URL}?action=modify&payload=${encodeURIComponent(JSON.stringify(payload))}`);
    const r = await res.json();
    $('result').innerHTML = `<span style="color:blue">${r.message}</span>`;
    loadStats(opt.value);
  } catch(e) {
    $('result').innerHTML = '<span style="color:red">å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</span>';
  } finally {
    $('submitBtn').disabled = false;
  }
});

// --- å–æ¶ˆå ±å ---
$('cancelBtn').addEventListener('click', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;

  $('cancelBtn').disabled = true;
  $('result').innerText = 'æ­£åœ¨è™•ç†å–æ¶ˆè«‹æ±‚...';

  try {
    const res = await fetch(`${GAS_URL}?action=cancel&payload=${encodeURIComponent(JSON.stringify({ eventId: opt.value, userId: $('userId').value }))}`);
    const r = await res.json();
    $('result').innerHTML = `<span style="color:darkred">${r.message}</span>`;
    loadStats(opt.value);
  } catch(e) {
    $('result').innerText = 'å–æ¶ˆå¤±æ•—';
  } finally {
    $('cancelBtn').disabled = false;
  }
});

// --- è¼‰å…¥çµ±è¨ˆ ---
async function loadStats(eventId) {
  try {
    const data = await callApi('queryStats', `&eventId=${eventId}`);
    const isWeiYa = $('eventSelect').selectedOptions[0].dataset.type === 'å°¾ç‰™';
    
    let total = 0;
    data.users.forEach(u => total += parseInt(u.people)||0);
    $('userStats').innerHTML = `<strong>ğŸ‘¥ å ±åç¸½äººæ•¸ï¼š${total} äºº</strong><br>` + 
      data.users.map(u => `${u.userName}(${u.people}äºº)`).join(', ');

    let detail = `<strong>${isWeiYa ? 'ğŸ—„ï¸ æ¡Œæ•¸çµ±è¨ˆ' : 'ğŸ¨ æˆ¿å‹çµ±è¨ˆ'}ï¼š</strong><br>`;
    const target = isWeiYa ? data.tableStats : data.roomStats;
    const unit = isWeiYa ? 'æ¡Œ' : 'é–“';
    if(Object.keys(target).length > 0) {
      for(let k in target) detail += `â€¢ ${k}: ${target[k]} ${unit}<br>`;
    } else detail += 'æš«ç„¡è³‡æ–™';
    $('detailStats').innerHTML = detail;

    let sp = `<strong>ğŸ è´ŠåŠ©çµ±è¨ˆï¼š</strong><br>`;
    if(Object.keys(data.sponsor).length > 0) {
      for(let k in data.sponsor) sp += `â€¢ ${k}: ${data.sponsor[k]}<br>`;
    } else sp += 'æš«ç„¡è´ŠåŠ©';
    $('sponsorStats').innerHTML = sp;
  } catch(e) { console.error('çµ±è¨ˆæ›´æ–°å¤±æ•—'); }
}

// --- é é¢å•Ÿå‹•æµç¨‹ ---
window.addEventListener('DOMContentLoaded', async () => {
  // 1. åˆå§‹åŒ– LIFF
  await initLiff();

  // 2. é è¼‰å…¥æ´»å‹•æ¸…å–®
  try {
    const evs = await callApi('getEvents');
    $('eventSelect').innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
    evs.forEach(ev => {
      const opt = document.createElement('option');
      opt.value = ev.eventId;
      opt.text = `${ev.title} (${ev.type})`;
      Object.keys(ev).forEach(k => opt.dataset[k] = ev[k] || '');
      $('eventSelect').add(opt);
    });
  } catch(e) { $('eventSelect').innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>'; }

  // 3. é è¼‰å…¥æ‰€æœ‰ä¸‹æ‹‰é¸é …
  const optionTypes = [
    { type: 'people', id: 'people' },
    { type: 'table', id: 'table' },
    { type: 'pickup', id: 'pickup' },
    { type: 'room', id: 'room' },
    { type: 'sponsor', id: 'sponsor' },
    { type: 'sponsorQty', id: 'qty' }
  ];

  optionTypes.forEach(async (obj) => {
    try {
      const d = await callApi('getOptions', `&type=${obj.type}`);
      const target = $(obj.id);
      target.innerHTML = '';
      d.forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.text = v; target.add(o);
      });
    } catch(e) { console.warn(`é¸é … ${obj.type} è¼‰å…¥å¤±æ•—`); }
  });
});
</script>
</body>
</html>
