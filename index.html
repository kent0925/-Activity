<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>旅遊/尾牙報名系統（LIFF）</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f5f5f5;
}
h2 {
  text-align: center;
  color: #333;
}
form {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  max-width: 500px;
  margin: auto;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
}
select, input[type=text], textarea {
  width: 100%;
  margin-top: 5px;
  padding: 5px;
  border-radius: 5px;
  border: 1px solid #ccc;
}
button {
  margin-top: 20px;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
#submitBtn { background: #4CAF50; color: #fff; }
#cancelBtn { background: #f44336; color: #fff; margin-left: 10px; }
#result { margin-top: 15px; font-weight: bold; color: #007BFF; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<h2>旅遊/尾牙報名表單</h2>

<form id="registrationForm">
  <label>活動類型：
    <select id="eventType" required></select>
  </label>

  <label>活動名稱：
    <select id="eventId" required></select>
  </label>

  <label>使用者名稱：
    <input type="text" id="userName" readonly>
  </label>

  <label style="display:none;">User ID：
    <input type="text" id="userId" readonly>
  </label>

  <div id="formFields" style="display:none;">
    <label>參加人數：
      <select id="people" required></select>
    </label>

    <label id="tableLabel">認桌數量（尾牙）：
      <select id="table"></select>
    </label>

    <label id="pickupLabel">上車地點（旅遊）：
      <select id="pickup"></select>
    </label>

    <label id="roomLabel">房型選擇（旅遊）：
      <select id="room"></select>
    </label>

    <label>贊助項目：
      <select id="sponsor" required></select>
    </label>

    <label id="sponsorOtherLabel" style="display:none;">其他贊助項目：
      <input type="text" id="sponsorOther">
    </label>

    <label>贊助數量：
      <select id="qty" required></select>
    </label>

    <label>備註：
      <textarea id="memo"></textarea>
    </label>

    <button type="submit" id="submitBtn">送出 / 更新報名</button>
    <button type="button" id="cancelBtn">取消報名</button>
  </div>

  <p id="result"></p>
</form>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJuAodySUQ0jUh0mNEvSv4D5J2Bi8GB7tp480BxHGyVOx-QeKiPJg7-KktBDtmKsf9/exec'; // 直接使用 GAS HtmlService 域名

const eventTypeEl = document.getElementById('eventType');
const tableLabel = document.getElementById('tableLabel');
const pickupLabel = document.getElementById('pickupLabel');
const roomLabel = document.getElementById('roomLabel');
const sponsorEl = document.getElementById('sponsor');
const sponsorOtherLabel = document.getElementById('sponsorOtherLabel');
const formFields = document.getElementById('formFields');

async function initLiff() {
  await liff.init({ liffId: '2008678090-TpSkCDSZ' });
  if (liff.isLoggedIn()) {
    const profile = await liff.getProfile();
    document.getElementById('userName').value = profile.displayName;
    document.getElementById('userId').value = profile.userId;
  } else {
    liff.login();
  }
}

// 載入活動類型與活動
async function loadEvents() {
  const res = await fetch(GAS_URL+'?action=getEvents');
  const events = await res.json();
  const typeSet = new Set();
  events.forEach(e => typeSet.add(e.type));
  eventTypeEl.innerHTML = '<option value="">請選擇</option>';
  typeSet.forEach(t => eventTypeEl.add(new Option(t,t)));

  // 當選活動類型時，更新活動名稱下拉
  eventTypeEl.addEventListener('change', () => {
    const type = eventTypeEl.value;
    const eventSelect = document.getElementById('eventId');
    eventSelect.innerHTML = '<option value="">請選擇</option>';
    events.filter(e => e.type === type).forEach(ev => {
      eventSelect.add(new Option(ev.title, ev.eventId));
    });

    // 顯示對應欄位
    if(type==='尾牙'){ tableLabel.style.display='block'; pickupLabel.style.display='none'; roomLabel.style.display='none'; }
    else if(type==='旅遊'){ tableLabel.style.display='none'; pickupLabel.style.display='block'; roomLabel.style.display='block'; }
    else { tableLabel.style.display='none'; pickupLabel.style.display='none'; roomLabel.style.display='none'; }

    formFields.style.display = 'block';
  });
}

// 載入下拉選單
async function loadOptions(type, selectId) {
  const res = await fetch(GAS_URL+'?action=getOptions&type='+type);
  const data = await res.json();
  const select = document.getElementById(selectId);
  select.innerHTML = '<option value="">請選擇</option>';
  data.forEach(d => select.add(new Option(d,d)));
}

// 贊助選其他顯示文字欄
sponsorEl.addEventListener('change', () => {
  sponsorOtherLabel.style.display = sponsorEl.value === '其他' ? 'block' : 'none';
});

// 初始化
window.addEventListener('DOMContentLoaded', async () => {
  await initLiff();
  await loadEvents();
  await loadOptions('people','people');
  await loadOptions('table','table');
  await loadOptions('pickup','pickup');
  await loadOptions('room','room');
  await loadOptions('sponsor','sponsor');
  await loadOptions('sponsorQty','qty');
});

// 送出 / 修改報名
document.getElementById('registrationForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    eventId: document.getElementById('eventId').value,
    eventType: document.getElementById('eventType').value,
    userId: document.getElementById('userId').value,
    userName: document.getElementById('userName').value,
    people: document.getElementById('people').value,
    table: document.getElementById('table').value,
    pickup: document.getElementById('pickup').value,
    room: document.getElementById('room').value,
    sponsor: document.getElementById('sponsor').value,
    sponsorOther: document.getElementById('sponsorOther').value,
    qty: document.getElementById('qty').value,
    memo: document.getElementById('memo').value,
    action: 'modify'
  };
  const res = await fetch(GAS_URL, {
    method: 'POST',
    body: JSON.stringify({ events:[{ postback:{ data: JSON.stringify(data) }, source:{ userId: data.userId } }] })
  });
  const result = await res.json();
  document.getElementById('result').innerText = result.message;
});

// 取消報名
document.getElementById('cancelBtn').addEventListener('click', async () => {
  const data = {
    eventId: document.getElementById('eventId').value,
    userId: document.getElementById('userId').value,
    action: 'cancel'
  };
  const res = await fetch(GAS_URL, {
    method: 'POST',
    body: JSON.stringify({ events:[{ postback:{ data: JSON.stringify(data) }, source:{ userId: data.userId } }] })
  });
  const result = await res.json();
  document.getElementById('result').innerText = result.message;
  formFields.style.display = 'none';
});
</script>
</body>
</html>
