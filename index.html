// ========== 配置區 ==========
const SPREADSHEET_ID = "你的 Spreadsheet ID"; 
const SHEET_RESPONSES = "Responses";
const SHEET_OPTIONS = "Options";
const SHEET_EVENTS = "Events";

// Helper：回傳帶 CORS 的 JSON
function corsJson(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}

// OPTIONS 預檢
function doOptions(e) {
  return ContentService.createTextOutput("")
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}

// 打開 Spreadsheet
function getSpreadsheet() {
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

// GET 請求
function doGet(e) {
  const action = e.parameter.action;

  if(action === "getOptions") {
    const type = e.parameter.type;
    const sheet = getSpreadsheet().getSheetByName(SHEET_OPTIONS);
    const data = sheet.getDataRange().getValues()
                      .filter(r => r[0] === type)
                      .map(r => r[1]);
    return corsJson(data);

  } else if(action === "getEvents") {
    const sheet = getSpreadsheet().getSheetByName(SHEET_EVENTS);
    const rows = sheet.getDataRange().getValues();
    const events = [];
    for(let i=1;i<rows.length;i++){
      events.push({
        eventId: rows[i][0],
        type: rows[i][1],
        title: rows[i][2],
        host: rows[i][3],
        time: rows[i][4],
        startDate: rows[i][5],
        endDate: rows[i][6],
        store: rows[i][7],
        address: rows[i][8],
        map: rows[i][9]
      });
    }
    return corsJson(events);

  } else if(action === "queryStats") {
    const eventId = e.parameter.eventId;
    const sheet = getSpreadsheet().getSheetByName(SHEET_RESPONSES);
    const data = sheet.getDataRange().getValues();

    const users = [];
    const tableRoom = {};
    const sponsor = {};

    for(let i=1;i<data.length;i++){
      if(data[i][0] !== eventId) continue;

      users.push({ userName: data[i][3], people: data[i][4] });

      const type = data[i][1];
      if(type==="尾牙" && data[i][5]) tableRoom[data[i][5]] = (tableRoom[data[i][5]]||0)+1;
      else if(type==="旅遊" && data[i][7]) tableRoom[data[i][7]] = (tableRoom[data[i][7]]||0)+1;

      const s = data[i][8];
      const qty = Number(data[i][10])||0;
      if(s && s!=="無"){
        const key = s==="其他" ? data[i][9] : s;
        sponsor[key] = (sponsor[key]||0)+qty;
      }
    }

    return corsJson({ users, tableRoom, sponsor });
  }

  return corsJson({ error: "Invalid action" });
}

// POST 請求
function doPost(e) {
  const body = JSON.parse(e.postData.contents);
  const lineEvent = body.events[0];
  const userId = lineEvent.source.userId;
  const data = JSON.parse(lineEvent.postback.data);

  if(data.action==="cancel"){
    const result = cancelRegistration(data.eventId, userId);
    return corsJson({ message: result ? "報名已取消" : "尚未報名" });
  }

  saveForm({
    userId: userId,
    userName: data.userName,
    people: data.people,
    table: data.table,
    pickup: data.pickup,
    room: data.room,
    sponsor: data.sponsor,
    sponsorOther: data.sponsorOther,
    qty: data.qty,
    memo: data.memo
  }, data.eventId, data.eventType);

  return corsJson({ message: "報名完成（已更新資料）" });
}

// 儲存 / 更新報名
function saveForm(data, eventId, eventType){
  const sheet = getSpreadsheet().getSheetByName(SHEET_RESPONSES);
  const rowData = [
    eventId,eventType,data.userId,data.userName,data.people,
    eventType==="尾牙"?data.table:"",
    eventType==="旅遊"?data.pickup:"",
    eventType==="旅遊"?data.room:"",
    data.sponsor,
    data.sponsor==="其他"?data.sponsorOther:"",
    data.qty,
    data.memo||"",
    new Date()
  ];
  const rowIndex = findUserRow(eventId,data.userId);
  if(rowIndex===-1) sheet.appendRow(rowData);
  else sheet.getRange(rowIndex,1,1,rowData.length).setValues([rowData]);
}

// 取消報名
function cancelRegistration(eventId,userId){
  const sheet = getSpreadsheet().getSheetByName(SHEET_RESPONSES);
  const rowIndex = findUserRow(eventId,userId);
  if(rowIndex===-1) return false;
  sheet.deleteRow(rowIndex);
  return true;
}

// 找使用者行號
function findUserRow(eventId,userId){
  const sheet = getSpreadsheet().getSheetByName(SHEET_RESPONSES);
  const data = sheet.getDataRange().getValues();
  for(let i=1;i<data.length;i++){
    if(data[i][0]===eventId && data[i][2]===userId) return i+1;
  }
  return -1;
}
