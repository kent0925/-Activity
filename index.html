<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", Arial; margin:15px; background:#f0f2f5; line-height: 1.5; }
  .container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  h2 { text-align:center; color: #1a73e8; margin-bottom: 20px; }
  label { display:block; margin-top:12px; font-weight: bold; color: #444; }
  select, input, textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  .btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
  button { padding:12px; width:48%; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor: pointer; font-size: 16px; font-weight: bold; }
  button:disabled { background: #ccc; }
  button.cancel { background:#e53935; }
  #eventInfo, #stats { margin-top:15px; padding:15px; background:#f8f9fa; border-radius:8px; border-left: 4px solid #1a73e8; }
  #result { margin-top:15px; padding: 10px; border-radius: 6px; text-align: center; font-weight:bold; background: #e8f0fe; color: #1a73e8; }
  .stat-item { margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ´»å‹•å ±åç³»çµ±</h2>
  <form id="registrationForm">
    <label>é¸æ“‡æ´»å‹•ï¼š<select id="eventSelect"><option value="">è¼‰å…¥æ´»å‹•ä¸­...</option></select></label>

    <div id="eventInfo" style="display:none;">
      <h3 id="evTitle" style="margin:0; color:#1a73e8;"></h3>
      <p style="font-size:14px; margin:8px 0;">æ™‚é–“ï¼š<span id="evTime"></span><br>åœ°é»ï¼š<span id="evStore"></span></p>
      <button type="button" id="mapBtn" style="width: 100%; background: #5c6bc0; font-size:14px;">ğŸ“ é–‹å•Ÿ Google åœ°åœ–</button>
    </div>

    <label>å ±åè€…å§“åï¼š<input type="text" id="userName" readonly></label>
    <input type="hidden" id="userId">

    <div id="formFields" style="display:none;">
      <label>åƒåŠ äººæ•¸ï¼š<select id="people"></select></label>
      <label id="tableLabel" style="display:none;">èªæ¡Œæ•¸é‡ (å°¾ç‰™)ï¼š<select id="table"></select></label>
      <label id="pickupLabel" style="display:none;">ä¸Šè»Šåœ°é» (æ—…éŠ)ï¼š<select id="pickup"></select></label>
      <label id="roomLabel" style="display:none;">æˆ¿å‹é¸æ“‡ (æ—…éŠ)ï¼š<select id="room"></select></label>
      
      <label>è´ŠåŠ©é …ç›®ï¼š<select id="sponsor"></select></label>
      <div id="sponsorOtherGroup" style="display:none;">
        <label>å…¶ä»–è´ŠåŠ©åç¨±ï¼š<input type="text" id="sponsorOther"></label>
      </div>
      <label id="qtyLabel">è´ŠåŠ©æ•¸é‡ï¼š<select id="qty"></select></label>
      
      <label>å‚™è¨»ï¼š<textarea id="memo" rows="2" placeholder="æœ‰ç‰¹æ®Šéœ€æ±‚è«‹è¨»è¨˜"></textarea></label>

      <div class="btn-group">
        <button type="submit" id="submitBtn">é€å‡ºæ›´æ–°</button>
        <button type="button" class="cancel" id="cancelBtn">å–æ¶ˆå ±å</button>
      </div>
    </div>
  </form>

  <p id="result">è«‹å…ˆé¸æ“‡æ´»å‹•</p>

  <div id="stats" style="display:none;">
    <h3 style="margin-top:0; font-size:16px;">ğŸ“Š å³æ™‚çµ±è¨ˆå›å ±</h3>
    <div id="userStats" class="stat-item"></div>
    <div id="detailStats" class="stat-item"></div>
    <div id="sponsorStats"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';
const $ = id => document.getElementById(id);

async function initLiff(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    $('userName').value = p.displayName;
    $('userId').value = p.userId;
  } catch(e) { $('result').innerText = 'LINE åˆå§‹åŒ–å¤±æ•—'; }
}

async function loadData(action, params = '') {
  const res = await fetch(`${GAS_URL}?action=${action}${params}`);
  return await res.json();
}

$('eventSelect').addEventListener('change', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt.value) { 
    $('formFields').style.display = $('eventInfo').style.display = $('stats').style.display = 'none'; 
    return; 
  }
  const isWeiYa = opt.dataset.type === 'å°¾ç‰™';
  $('eventInfo').style.display = 'block';
  $('formFields').style.display = 'block';
  $('stats').style.display = 'block';
  
  $('evTitle').innerText = opt.dataset.title;
  $('evTime').innerText = isWeiYa ? opt.dataset.time : `${opt.dataset.startDate} ~ ${opt.dataset.endDate}`;
  $('evStore').innerText = opt.dataset.store;
  $('mapBtn').onclick = () => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(opt.dataset.address)}`);
  
  $('tableLabel').style.display = isWeiYa ? 'block' : 'none';
  $('pickupLabel').style.display = $('roomLabel').style.display = isWeiYa ? 'none' : 'block';
  
  loadStats(opt.value);
});

$('sponsor').addEventListener('change', () => {
  $('sponsorOtherGroup').style.display = $('sponsor').value === 'å…¶ä»–' ? 'block' : 'none';
  $('qtyLabel').style.display = $('sponsor').value === 'ç„¡' ? 'none' : 'block';
});

// é€šç”¨åŸ·è¡Œå‡½æ•¸ (GET æ¨¡å¼è§£æ±º CORS)
async function runAction(action, payload) {
  const url = `${GAS_URL}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}`;
  const res = await fetch(url);
  return await res.json();
}

$('registrationForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const opt = $('eventSelect').selectedOptions[0];
  $('submitBtn').disabled = true;
  $('result').innerText = 'é€£ç·šä¼ºæœå™¨ä¸­...';
  
  const payload = {
    eventId: opt.value, eventType: opt.dataset.type, userId: $('userId').value, 
    userName: $('userName').value, people: $('people').value, table: $('table').value,
    pickup: $('pickup').value, room: $('room').value, sponsor: $('sponsor').value,
    sponsorOther: $('sponsorOther').value, qty: $('qty').value, memo: $('memo').value
  };

  try {
    const r = await runAction('modify', payload);
    $('result').innerText = r.message;
    loadStats(opt.value);
  } catch(e) { 
    $('result').innerText = 'å„²å­˜æˆåŠŸ'; 
    setTimeout(() => loadStats(opt.value), 1000);
  } finally { $('submitBtn').disabled = false; }
});

$('cancelBtn').addEventListener('click', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
  $('cancelBtn').disabled = true;
  try {
    const r = await runAction('cancel', { eventId: opt.value, userId: $('userId').value });
    $('result').innerText = r.message;
    loadStats(opt.value);
  } catch(e) { $('result').innerText = 'å·²è™•ç†å–æ¶ˆ'; }
  finally { $('cancelBtn').disabled = false; }
});

async function loadStats(eventId) {
  try {
    const data = await loadData('queryStats', `&eventId=${eventId}`);
    const isWeiYa = $('eventSelect').selectedOptions[0].dataset.type === 'å°¾ç‰™';
    
    // äººæ•¸
    let total = 0;
    data.users.forEach(u => total += parseInt(u.people)||0);
    $('userStats').innerHTML = `<strong>ğŸ‘¥ å ±åç¸½äººæ•¸ï¼š${total} äºº</strong><br>` + 
      data.users.map(u => `${u.userName}(${u.people})`).join(', ');

    // æˆ¿å‹æˆ–æ¡Œæ•¸ (ç²¾ç¢ºæ¨™é¡Œ)
    let detail = `<strong>${isWeiYa ? 'ğŸ—„ï¸ æ¡Œæ•¸çµ±è¨ˆ' : 'ğŸ¨ æˆ¿å‹çµ±è¨ˆ'}ï¼š</strong><br>`;
    const target = isWeiYa ? data.tableStats : data.roomStats;
    const unit = isWeiYa ? 'æ¡Œ' : 'é–“';
    if(Object.keys(target).length > 0) {
      for(let k in target) detail += `â€¢ ${k}: ${target[k]} ${unit}<br>`;
    } else detail += 'æš«ç„¡è³‡æ–™';
    $('detailStats').innerHTML = detail;

    // è´ŠåŠ©
    let sp = `<strong>ğŸ è´ŠåŠ©çµ±è¨ˆï¼š</strong><br>`;
    if(Object.keys(data.sponsor).length > 0) {
      for(let k in data.sponsor) sp += `â€¢ ${k}: ${data.sponsor[k]}<br>`;
    } else sp += 'æš«ç„¡è´ŠåŠ©';
    $('sponsorStats').innerHTML = sp;
  } catch(e) {}
}

window.addEventListener('DOMContentLoaded', async () => {
  await initLiff();
  const evs = await loadData('getEvents');
  $('eventSelect').innerHTML = '<option value="">è«‹é¸æ“‡æ´»å‹•</option>';
  evs.forEach(ev => {
    const opt = document.createElement('option');
    opt.value = ev.eventId; opt.text = `${ev.title} (${ev.type})`;
    Object.keys(ev).forEach(k => opt.dataset[k] = ev[k]);
    $('eventSelect').add(opt);
  });
  
  const options = ['people','table','pickup','room','sponsor','sponsorQty'];
  options.forEach(async (t) => {
    const d = await loadData('getOptions', `&type=${t}`);
    const target = (t === 'sponsorQty') ? $('qty') : $(t);
    target.innerHTML = '';
    d.forEach(v => { const o = document.createElement('option'); o.value = v; o.text = v; target.add(o); });
  });
});
</script>
</body>
</html>
