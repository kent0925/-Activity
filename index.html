<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
body { font-family: "Microsoft JhengHei", Arial; margin:20px; background:#f4f4f4; }
.container { max-width:520px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h2 { text-align:center; color: #333; }
label { display:block; margin-top:15px; font-weight: bold; }
select, input[type=text], textarea { width:100%; padding:10px; margin-top:5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
.btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
button { padding:12px; width:48%; border:none; border-radius:5px; background:#4CAF50; color:#fff; cursor: pointer; font-size: 16px; }
button:disabled { background: #ccc; cursor: not-allowed; }
button.cancel { background:#f44336; }
#eventInfo, #stats { margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; border-left: 5px solid #4CAF50; }
#eventInfo h3, #stats h3 { margin:0 0 8px 0; color: #4CAF50; }
#result { margin-top:15px; padding: 10px; border-radius: 5px; text-align: center; font-weight:bold; }
.loading { color: #666; font-style: italic; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <h2>æ—…éŠ / å°¾ç‰™ å ±åè¡¨å–®</h2>
  <form id="registrationForm">

    <label>é¸æ“‡æ´»å‹•ï¼š
      <select id="eventSelect"><option value="">è¼‰å…¥ä¸­...</option></select>
    </label>

    <div id="eventInfo" style="display:none;">
      <h3 id="evTitle"></h3>
      <p>ä¸»è¾¦ï¼š<span id="evHost"></span></p>
      <p>æ™‚é–“ï¼š<span id="evTime"></span></p>
      <p>åº—åï¼š<span id="evStore"></span></p>
      <p>åœ°å€ï¼š<span id="evAddress"></span></p>
      <button type="button" id="mapBtn" style="width: 100%; background: #2196F3;">ğŸ“ Google Map</button>
    </div>

    <label>ä½¿ç”¨è€…åç¨±ï¼š
      <input type="text" id="userName" readonly placeholder="ç™»å…¥ LINE ä»¥ç²å–åç¨±">
    </label>
    <input type="hidden" id="userId">

    <div id="formFields" style="display:none;">
      <label>åƒåŠ äººæ•¸ï¼š
        <select id="people"></select>
      </label>

      <label id="tableLabel" style="display:none;">èªæ¡Œæ•¸é‡ï¼ˆå°¾ç‰™ï¼‰ï¼š
        <select id="table"></select>
      </label>

      <label id="pickupLabel" style="display:none;">ä¸Šè»Šåœ°é»ï¼ˆæ—…éŠï¼‰ï¼š
        <select id="pickup"></select>
      </label>

      <label id="roomLabel" style="display:none;">æˆ¿å‹é¸æ“‡ï¼ˆæ—…éŠï¼‰ï¼š
        <select id="room"></select>
      </label>

      <label>è´ŠåŠ©é …ç›®ï¼š
        <select id="sponsor"></select>
      </label>

      <label id="sponsorOtherLabel" style="display:none;">å…¶ä»–è´ŠåŠ©é …ç›®ï¼š
        <input type="text" id="sponsorOther">
      </label>

      <label id="qtyLabel">è´ŠåŠ©æ•¸é‡ï¼š
        <select id="qty"></select>
      </label>

      <label>å‚™è¨»ï¼š
        <textarea id="memo" rows="3"></textarea>
      </label>

      <div class="btn-group">
        <button type="submit" id="submitBtn">é€å‡º / æ›´æ–°</button>
        <button type="button" class="cancel" id="cancelBtn">å–æ¶ˆå ±å</button>
      </div>
    </div>
  </form>

  <p id="result"></p>

  <div id="stats" style="display:none;">
    <h3>æ´»å‹•å ±åçµ±è¨ˆ</h3>
    <div id="userStats"></div>
    <div id="tableRoomStats" style="margin-top:10px;"></div>
    <div id="sponsorStats" style="margin-top:10px;"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwTgTtVmzAoZrW3zp0Eqq5WcpVqT54uZhWwF3P8InjwQJor_TqFQsOeaRLn_lQOvwKU/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';

// DOM å…ƒç´ ç°¡å¯«
const $ = id => document.getElementById(id);

// ===== æ—¥æœŸ/æ™‚é–“æ ¼å¼åŒ– =====
function formatDateWithWeek(val){ 
  const d = new Date(val); 
  if(isNaN(d)) return val; 
  const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; 
  return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}ï¼ˆ${w[d.getDay()]}ï¼‰`; 
}

// ===== LIFF åˆå§‹åŒ– =====
async function initLiff(){ 
  try{ 
    await liff.init({ liffId: LIFF_ID }); 
    if(!liff.isLoggedIn()) {
      liff.login(); 
    } else {
      const p = await liff.getProfile(); 
      $('userName').value = p.displayName; 
      $('userId').value = p.userId; 
    }
  } catch(e){ 
    console.error(e); 
    $('result').innerText = 'LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åœ¨ LINE ä¸­é–‹å•Ÿ';
  }
}

// ===== è¼‰å…¥æ´»å‹• & é¸é … =====
async function loadEvents(){ 
  try{ 
    const res = await fetch(`${GAS_URL}?action=getEvents`); 
    const data = await res.json(); 
    $('eventSelect').innerHTML = '<option value="">è«‹é¸æ“‡æ´»å‹•</option>'; 
    data.forEach(ev => { 
      const opt = document.createElement('option'); 
      opt.value = ev.eventId; 
      opt.text = `${ev.title} (${ev.type})`; 
      Object.keys(ev).forEach(k => opt.dataset[k] = ev[k] || ''); 
      $('eventSelect').add(opt); 
    }); 
  } catch(e){ 
    console.error(e); 
    $('result').innerText = 'è¼‰å…¥æ´»å‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
  } 
}

async function loadOptions(type, id){ 
  try{ 
    const res = await fetch(`${GAS_URL}?action=getOptions&type=${type}`); 
    const data = await res.json(); 
    const sel = $(id); 
    sel.innerHTML = ''; 
    data.forEach(v => { 
      const o = document.createElement('option'); 
      o.value = v; o.text = v; sel.add(o); 
    }); 
  } catch(e){ console.error(e); } 
}

// ===== é¡¯ç¤ºæ´»å‹•è³‡è¨Šèˆ‡æ¬„ä½åˆ‡æ› =====
$('eventSelect').addEventListener('change', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt || !opt.value){ 
    $('formFields').style.display = 'none'; 
    $('eventInfo').style.display = 'none'; 
    $('stats').style.display = 'none'; 
    return; 
  }
  
  $('formFields').style.display = 'block'; 
  $('eventInfo').style.display = 'block'; 
  $('stats').style.display = 'block';
  
  $('evTitle').innerText = opt.dataset.title || ''; 
  $('evHost').innerText = opt.dataset.host || ''; 
  $('evStore').innerText = opt.dataset.store || ''; 
  $('evAddress').innerText = opt.dataset.address || '';
  
  const isWeiYa = opt.dataset.type === 'å°¾ç‰™';
  $('evTime').innerText = isWeiYa ? opt.dataset.time : `${formatDateWithWeek(opt.dataset.startDate)} ï½ ${formatDateWithWeek(opt.dataset.endDate)}`;
  
  $('mapBtn').onclick = () => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(opt.dataset.address || '')}`); };
  
  $('tableLabel').style.display = isWeiYa ? 'block' : 'none';
  $('pickupLabel').style.display = $('roomLabel').style.display = isWeiYa ? 'none' : 'block';
  
  loadStats(opt.value);
});

// ===== è´ŠåŠ©é¸é …åˆ‡æ› =====
$('sponsor').addEventListener('change', () => { 
  $('sponsorOtherLabel').style.display = $('sponsor').value === 'å…¶ä»–' ? 'block' : 'none'; 
  $('qtyLabel').style.display = $('sponsor').value === 'ç„¡' ? 'none' : 'block'; 
  if($('sponsor').value !== 'å…¶ä»–') $('sponsorOther').value = ''; 
});

// ===== é€å‡ºè¡¨å–® (ä¿®æ­£ CORS å•é¡Œ) =====
$('registrationForm').addEventListener('submit', async e => {
  e.preventDefault();
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt.value) return alert('è«‹å…ˆé¸æ“‡æ´»å‹•');
  
  const btn = $('submitBtn');
  btn.disabled = true;
  $('result').innerText = 'å„²å­˜ä¸­...';
  $('result').style.color = '#333';

  const payload = { 
    action: 'modify', 
    eventId: opt.value, 
    eventType: opt.dataset.type, 
    userId: $('userId').value, 
    userName: $('userName').value, 
    people: $('people').value, 
    table: $('table').value, 
    pickup: $('pickup').value, 
    room: $('room').value, 
    sponsor: $('sponsor').value, 
    sponsorOther: $('sponsorOther').value, 
    qty: $('qty').value, 
    memo: $('memo').value 
  };

  try {
    // é—œéµä¿®æ­£ï¼šä¸è¨­å®š Headersï¼Œä½¿ç”¨ç°¡å–®è«‹æ±‚æ¨¡å¼
    const res = await fetch(GAS_URL, { 
      method: 'POST', 
      mode: 'cors', // ç¢ºä¿è·¨åŸŸ
      body: JSON.stringify(payload) 
    });
    const r = await res.json();
    $('result').innerText = r.message;
    $('result').style.color = '#4CAF50';
    loadStats(opt.value);
  } catch (err) {
    console.error(err);
    // å³ä½¿å ±éŒ¯ä¹Ÿå¯èƒ½æ˜¯å› ç‚ºè·³è½‰å•é¡Œï¼Œå¼•å°ä½¿ç”¨è€…ç¢ºèª
    $('result').innerText = 'å·²å˜—è©¦é€å‡ºï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹çµ±è¨ˆç¢ºèªæ˜¯å¦æˆåŠŸ';
    $('result').style.color = '#f44336';
    setTimeout(() => loadStats(opt.value), 2000);
  } finally {
    btn.disabled = false;
  }
});

// ===== å–æ¶ˆå ±å =====
$('cancelBtn').addEventListener('click', async () => {
  const opt = $('eventSelect').selectedOptions[0];
  if(!opt.value) return alert('è«‹å…ˆé¸æ“‡æ´»å‹•');
  if(!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;

  $('cancelBtn').disabled = true;
  $('result').innerText = 'æ­£åœ¨å–æ¶ˆ...';
  
  const payload = { action: 'cancel', eventId: opt.value, userId: $('userId').value };

  try {
    const res = await fetch(GAS_URL, { 
      method: 'POST', 
      body: JSON.stringify(payload) 
    });
    const r = await res.json();
    $('result').innerText = r.message;
    loadStats(opt.value);
    $('formFields').style.display = 'none';
  } catch (err) {
    console.error(err);
    $('result').innerText = 'å–æ¶ˆè«‹æ±‚å·²é€å‡º';
    setTimeout(() => loadStats(opt.value), 2000);
  } finally {
    $('cancelBtn').disabled = false;
  }
});

// ===== è¼‰å…¥çµ±è¨ˆ =====
async function loadStats(eventId){ 
  try { 
    const res = await fetch(`${GAS_URL}?action=queryStats&eventId=${eventId}`); 
    const data = await res.json();
    
    let totalPeople = 0; 
    if(data.users && data.users.length > 0) data.users.forEach(u => totalPeople += parseInt(u.people)||0);
    
    $('userStats').innerHTML = `<b>ç¸½å ±åäººæ•¸ï¼š</b> ${totalPeople} äºº<br><br>` + 
      (data.users && data.users.length > 0 ? data.users.map(u => `â€¢ ${u.userName}ï¼š${u.people}äºº`).join('<br>') : 'å°šç„¡å ±å');
    
    let trHtml = '<b>æ¡Œæ•¸ / æˆ¿å‹çµ±è¨ˆï¼š</b><br>';
    if(data.tableRoom && Object.keys(data.tableRoom).length > 0){
      for(const key in data.tableRoom) trHtml += `â€¢ ${key}ï¼š${data.tableRoom[key]}<br>`;
    } else trHtml += 'å°šç„¡è³‡æ–™';
    $('tableRoomStats').innerHTML = trHtml;

    let sponsorHtml = '<b>è´ŠåŠ©çµ±è¨ˆï¼š</b><br>';
    if(data.sponsor && Object.keys(data.sponsor).length > 0){
      for(const key in data.sponsor) sponsorHtml += `â€¢ ${key}ï¼š${data.sponsor[key]}<br>`;
    } else sponsorHtml += 'å°šç„¡è³‡æ–™';
    $('sponsorStats').innerHTML = sponsorHtml;
  } catch(err) { console.error(err); }
}

// ===== åˆå§‹åŒ–è§¸ç™¼ =====
window.addEventListener('DOMContentLoaded', async () => {
  await initLiff();
  await loadEvents();
  loadOptions('people', 'people');
  loadOptions('table', 'table');
  loadOptions('pickup', 'pickup');
  loadOptions('room', 'room');
  loadOptions('sponsor', 'sponsor');
  loadOptions('sponsorQty', 'qty');
});
</script>
</body>
</html>
