<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…éŠ / å°¾ç‰™ å ±åç³»çµ±</title>
<style>
body { font-family: Arial; margin:20px; background:#f4f4f4; }
.container {
  max-width:520px; margin:auto; background:#fff;
  padding:20px; border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}
h2 { text-align:center; }
label { display:block; margin-top:10px; }
select, input[type=text], textarea {
  width:100%; padding:7px; margin-top:5px;
}
button {
  margin-top:15px; padding:10px; width:48%;
  border:none; border-radius:5px;
  background:#4CAF50; color:#fff;
}
button.cancel { background:#f44336; }
#eventInfo, #stats {
  margin-top:15px; padding:12px;
  background:#f9f9f9; border-radius:8px;
}
#eventInfo h3, #stats h3 { margin:0 0 8px 0; }
#result { margin-top:10px; color:#d32f2f; font-weight:bold; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">

<h2>æ—…éŠ / å°¾ç‰™ å ±åè¡¨å–®</h2>

<form id="registrationForm">

<label>é¸æ“‡æ´»å‹•ï¼š
  <select id="eventSelect">
    <option value="">è«‹é¸æ“‡æ´»å‹•</option>
  </select>
</label>

<div id="eventInfo" style="display:none;">
  <h3 id="evTitle"></h3>
  <p>ä¸»è¾¦ï¼š<span id="evHost"></span></p>
  <p>æ™‚é–“ï¼š<span id="evTime"></span></p>
  <p>åº—åï¼š<span id="evStore"></span></p>
  <p>åœ°å€ï¼š<span id="evAddress"></span></p>
  <button type="button" id="mapBtn">ğŸ“ Google Map</button>
</div>

<label>ä½¿ç”¨è€…åç¨±ï¼š
  <input type="text" id="userName" readonly>
</label>
<input type="hidden" id="userId">

<div id="formFields" style="display:none;">

<label>åƒåŠ äººæ•¸ï¼š
  <select id="people"></select>
</label>

<label id="tableLabel">èªæ¡Œæ•¸é‡ï¼ˆå°¾ç‰™ï¼‰ï¼š
  <select id="table"></select>
</label>

<label id="pickupLabel">ä¸Šè»Šåœ°é»ï¼ˆæ—…éŠï¼‰ï¼š
  <select id="pickup"></select>
</label>

<label id="roomLabel">æˆ¿å‹é¸æ“‡ï¼ˆæ—…éŠï¼‰ï¼š
  <select id="room"></select>
</label>

<label>è´ŠåŠ©é …ç›®ï¼š
  <select id="sponsor"></select>
</label>

<label id="sponsorOtherLabel" style="display:none;">
  å…¶ä»–è´ŠåŠ©é …ç›®ï¼š
  <input type="text" id="sponsorOther">
</label>

<label id="qtyLabel">è´ŠåŠ©æ•¸é‡ï¼š
  <select id="qty"></select>
</label>

<label>å‚™è¨»ï¼š
  <textarea id="memo"></textarea>
</label>

<button type="submit">é€å‡º / æ›´æ–°</button>
<button type="button" class="cancel" id="cancelBtn">å–æ¶ˆå ±å</button>

</div>

<p id="result"></p>

<div id="stats" style="display:none;">
  <h3>æ´»å‹•å ±åçµ±è¨ˆ</h3>
  <div id="userStats"></div>
  <div id="tableRoomStats"></div>
  <div id="sponsorStats"></div>
</div>

</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJuAodySUQ0jUh0mNEvSv4D5J2Bi8GB7tp480BxHGyVOx-QeKiPJg7-KktBDtmKsf9/exec';
const LIFF_ID = '2008678090-TpSkCDSZ';

function formatDateWithWeek(val){
  if(!val) return '';
  const d = new Date(val);
  if(isNaN(d.getTime())) return val;
  const local = new Date(d.getTime() + 8*60*60*1000);
  const weekMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const y = local.getFullYear();
  const m = String(local.getMonth()+1).padStart(2,'0');
  const day = String(local.getDate()).padStart(2,'0');
  const w = weekMap[local.getDay()];
  return `${y}/${m}/${day}ï¼ˆ${w}ï¼‰`;
}

function formatTimeWithWeek(val){
  if(!val) return '';
  const d = new Date(val);
  if(isNaN(d.getTime())) return val;
  const local = new Date(d.getTime() + 8*60*60*1000);
  const hh = String(local.getHours()).padStart(2,'0');
  const mm = String(local.getMinutes()).padStart(2,'0');
  const weekMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const w = weekMap[local.getDay()];
  return `${hh}:${mm}ï¼ˆ${w}ï¼‰`;
}

async function initLiff(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  userName.value = p.displayName;
  userId.value = p.userId;
}

async function loadEvents(){
  const res = await fetch(`${GAS_URL}?action=getEvents`);
  const data = await res.json();
  data.forEach(ev=>{
    const opt = document.createElement('option');
    opt.value = ev.eventId;
    opt.text = `${ev.title} (${ev.type})`;
    Object.keys(ev).forEach(k => opt.dataset[k] = ev[k]);
    eventSelect.add(opt);
  });
}

async function loadOptions(type,id){
  const res = await fetch(`${GAS_URL}?action=getOptions&type=${type}`);
  const data = await res.json();
  const sel = document.getElementById(id);
  sel.innerHTML='';
  data.forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.text=v;
    sel.add(o);
  });
}

eventSelect.addEventListener('change',async ()=>{
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value){
    formFields.style.display='none';
    eventInfo.style.display='none';
    stats.style.display='none';
    return;
  }

  formFields.style.display='block';
  eventInfo.style.display='block';
  stats.style.display='block';

  evTitle.innerText = opt.dataset.title || '';
  evHost.innerText = opt.dataset.host || '';
  evStore.innerText = opt.dataset.store || '';
  evAddress.innerText = opt.dataset.address || '';

  if(opt.dataset.type==='å°¾ç‰™'){
    evTime.innerText = formatTimeWithWeek(opt.dataset.time);
  }else{
    evTime.innerText = formatDateWithWeek(opt.dataset.startDate)+' ï½ '+formatDateWithWeek(opt.dataset.endDate);
  }

  mapBtn.onclick = ()=>{
    const addr = encodeURIComponent(opt.dataset.address || '');
    window.open(`https://www.google.com/maps/search/?api=1&query=${addr}`);
  };

  tableLabel.style.display = opt.dataset.type==='å°¾ç‰™'?'block':'none';
  pickupLabel.style.display = roomLabel.style.display = opt.dataset.type==='æ—…éŠ'?'block':'none';

  loadStats(opt.value);
});

sponsor.addEventListener('change',()=>{
  sponsorOtherLabel.style.display = sponsor.value==='å…¶ä»–'?'block':'none';
  qtyLabel.style.display = sponsor.value==='ç„¡'?'none':'block';
});

registrationForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const opt = eventSelect.selectedOptions[0];
  const payload = {
    eventId: opt.value,
    eventType: opt.dataset.type,
    userId: userId.value,
    userName: userName.value,
    people: people.value,
    table: table.value,
    pickup: pickup.value,
    room: room.value,
    sponsor: sponsor.value,
    sponsorOther: sponsorOther.value,
    qty: qty.value,
    memo: memo.value,
    action:'modify'
  };
  const res = await fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({
      events:[{ postback:{ data: JSON.stringify(payload) }},
              { source:{ userId:userId.value }}]
    })
  });
  const r = await res.json();
  result.innerText = r.message;
  loadStats(opt.value);
});

cancelBtn.addEventListener('click',async ()=>{
  const opt = eventSelect.selectedOptions[0];
  if(!opt.value) return alert('è«‹å…ˆé¸æ“‡æ´»å‹•');
  const payload = {eventId:opt.value,userId:userId.value,action:'cancel'};
  const res = await fetch(GAS_URL,{
    method:'POST',
    body: JSON.stringify({
      events:[{ postback:{ data: JSON.stringify(payload) }},
              { source:{ userId:userId.value }}]
    })
  });
  const r = await res.json();
  result.innerText = r.message;
  formFields.style.display='none';
  stats.style.display='none';
  loadStats(opt.value);
});

async function loadStats(eventId){
  const res = await fetch(`${GAS_URL}?action=queryStats&eventId=${eventId}`);
  const data = await res.json();

  let totalPeople = 0;
  if(data.users && data.users.length>0){
    data.users.forEach(u=>{ totalPeople += parseInt(u.people)||0; });
  }
  let totalHtml = `<b>ç¸½å ±åäººæ•¸ï¼š</b> ${totalPeople} äºº<br>`;

  let userHtml='<b>ä½¿ç”¨è€…å ±åï¼š</b><br>';
  if(data.users && data.users.length>0){
    data.users.forEach(u=>{
      userHtml+=`${u.userName}ï¼š${u.people}äºº<br>`;
    });
  }else userHtml+='å°šç„¡å ±å<br>';
  userStats.innerHTML = totalHtml + userHtml;

  let trHtml='<b>æ¡Œæ•¸ / æˆ¿å‹çµ±è¨ˆï¼š</b><br>';
  if(data.tableRoom && Object.keys(data.tableRoom).length>0){
    for(const key in data.tableRoom){
      trHtml+=`${key}ï¼š${data.tableRoom[key]}<br>`;
    }
  }else trHtml+='å°šç„¡è³‡æ–™<br>';
  tableRoomStats.innerHTML=trHtml;

  let sponsorHtml='<b>è´ŠåŠ©çµ±è¨ˆï¼š</b><br>';
  if(data.sponsor && Object.keys(data.sponsor).length>0){
    for(const key in data.sponsor){
      sponsorHtml+=`${key}ï¼š${data.sponsor[key]}<br>`;
    }
  }else sponsorHtml+='å°šç„¡è³‡æ–™<br>';
  sponsorStats.innerHTML=sponsorHtml;
}

window.addEventListener('DOMContentLoaded',async()=>{
  await initLiff();
  await loadEvents();
  loadOptions('people','people');
  loadOptions('table','table');
  loadOptions('pickup','pickup');
  loadOptions('room','room');
  loadOptions('sponsor','sponsor');
  loadOptions('sponsorQty','qty');
});
</script>
</body>
</html>
